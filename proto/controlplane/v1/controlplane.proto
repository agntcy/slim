// Copyright AGNTCY Contributors (https://github.com/agntcy)
// SPDX-License-Identifier: Apache-2.0

syntax = "proto3";
package controlplane.proto.v1;

import "controller/v1/controller.proto";

option go_package = "github.com/agntcy/slim/control-plane/common/proto/controlplane/v1;controlplanev1";

service ControlPlaneService {
  rpc AddRoute(AddRouteRequest) returns (AddRouteResponse) {}
  rpc DeleteRoute(DeleteRouteRequest) returns (DeleteRouteResponse) {}
  rpc ListSubscriptions(Node) returns (controller.proto.v1.SubscriptionListResponse) {}
  rpc ListConnections(Node) returns (controller.proto.v1.ConnectionListResponse) {}
  rpc ListNodes(NodeListRequest) returns (NodeListResponse) {}

  // MLS group management
  rpc CreateChannel(CreateChannelRequest) returns (CreateChannelResponse) {}
  rpc DeleteChannel(controller.proto.v1.DeleteChannelRequest) returns (controller.proto.v1.Ack) {}
  rpc AddParticipant(controller.proto.v1.AddParticipantRequest) returns (controller.proto.v1.Ack) {}
  rpc DeleteParticipant(controller.proto.v1.DeleteParticipantRequest) returns (controller.proto.v1.Ack) {}
  rpc ListChannels(controller.proto.v1.ListChannelsRequest) returns (controller.proto.v1.ListChannelsResponse) {}
  rpc ListParticipants(controller.proto.v1.ListParticipantsRequest) returns (controller.proto.v1.ListParticipantsResponse) {}

  // Route management

  // List routes registered at the controller with optional filtering by source and destination node IDs
  rpc ListRoutes(RouteListRequest) returns (RouteListResponse) {}
}

message ConfigurationCommand {
  controller.proto.v1.ConfigurationCommand configuration_command = 1;
  string nodeId = 2;
}

message Node {
  string id = 1;
}

message NodeListRequest {}

enum NodeStatus {
  NODE_STATUS_UNSPECIFIED = 0;
  CONNECTED = 1;
  NOT_CONNECTED = 2;
}

message NodeEntry {
  string id = 1;
  repeated controller.proto.v1.ConnectionDetails connections = 2;
  NodeStatus status = 4;
}

message NodeListResponse {
  repeated NodeEntry entries = 1;
}

message AddRouteRequest {
  controller.proto.v1.Connection connection = 1;
  controller.proto.v1.Subscription subscription = 2;
  string nodeId = 3;
  string destNodeId = 4; // optional
}

message AddRouteResponse {
  bool success = 1;
  string routeId = 2;
}

message DeleteRouteRequest {
  controller.proto.v1.Subscription subscription = 1;
  string nodeId = 2;
  string destNodeId = 3; // optional
}

message DeleteRouteResponse {
  bool success = 1;
}

message CreateChannelRequest {
  // list of moderators for the channel
  repeated string moderators = 1;
}

message CreateChannelResponse {
  // ID of the channel, to which clients will subscribe
  string channel_name = 1;
}

// Request to list routes, filtered by optional nodeId and destNodeId
message RouteListRequest {
  // the identifier of the source node to filter routes
  string srcNodeId = 1; // optional

  string destNodeId = 2; // optional
}

// Route status enum
enum RouteStatus {
  ROUTE_STATUS_UNSPECIFIED = 0;
  ROUTE_STATUS_APPLIED = 1;
  ROUTE_STATUS_FAILED = 2;
}

// Route message representing a single route
message RouteEntry {
  uint64 id = 1;
  string source_node_id = 2;
  string dest_node_id = 3;
  string dest_endpoint = 4;
  string conn_config_data = 5;
  string component_0 = 6;
  string component_1 = 7;
  string component_2 = 8;
  optional uint64 component_id = 9;
  RouteStatus status = 10;
  string status_msg = 11;
  bool deleted = 12;
  int64 last_updated = 13; // Unix timestamp
}

// Response containing a list of route representations
message RouteListResponse {
  // list of routes
  repeated RouteEntry routes = 1;
}
