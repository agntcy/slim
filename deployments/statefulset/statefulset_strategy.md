# Statefulset Deployment Strategy

## Description

The statefulset deployment strategy provides a more robust approach to deploying SLIM in a Kubernetes cluster, specifically designed for scenarios requiring high availability and ordered deployment patterns. This strategy deploys SLIM itself as a StatefulSet rather than a standard Deployment.

**Target Audience:**
- Production environments requiring high availability
- Applications needing ordered scaling and updates
- Deployments requiring predictable pod management

**Use Cases:**
- Production SLIM deployments with high availability
- Applications with complex initialization sequences
- Deployments needing predictable pod naming and ordering
- Environments requiring reliable service continuity

## Details

Multiple SLIM nodes are deployed and connected to the Controller. Clients are connecting to a `ClusterIP` Service which load balances connections between SLIM nodes. Since SLIM keeps the connection open, all communication will go to the same server. 

Forwarding routes between the nodes are managed automatically by Controller on-demand upon new subscriptions. 
SLIM nodes are connected directly via their pod IP using MTLS, with certificates generated by Spire.

SLIM nodes are also configured to connect to the Controller using MTLS with certificates generated by Spire.

Clients are deployed on the cluster connecting with MTLS using Spire as well, but in addition messages are encrypted using MLS, where JWT tokens are generated by Spire.

The statefulset deployment strategy deploys SLIM components with enhanced configuration:
- StatefulSet-based deployment for SLIM pods
- Ordered pod management for reliable scaling
- Enhanced configuration through dedicated values file

This approach deploys SLIM as a StatefulSet, which provides guarantees around ordered deployment and scaling, supporting high availability scenarios. The deployment is driven by the `statefulset-values.yaml` file, which contains specific configuration parameters optimized for stateful workloads.

**Key Features:**
- Ordered deployment and scaling for high availability
- Predictable pod management
- Enhanced SLIM configuration options

![SLIM StatefulSet Deployment Diagram](img/slim_statefulset.svg)

## Usage

Follow these steps to deploy SLIM using the statefulset deployment strategy:

### 1. Set up the Kubernetes cluster
```bash
task templates:cluster:up
```

### 2. Deploy Spire
```bash
task templates:spire:deploy
```

<details>
  <summary>More Details on Spire</summary>
  
  This step will deploy a Spire Server, Agent and Controller on the cluster.
  Spire Controller will automatically create SVIDs, certificates, JWT tokens and register the created *SPIFFEID* for each running pod driven by `ClusterSPIFFEID` custom resource. 
  
  Here's an example of the default `ClusterSPIFFEID` which applies to all pods unless a custom one is defined: 

  ```yaml
    apiVersion: spire.spiffe.io/v1alpha1
    kind: ClusterSPIFFEID
    name: spire-spire-default
    spec:
        className: spire-spire
        fallback: true
        hint: default
        namespaceSelector:
            matchExpressions:
            - key: kubernetes.io/metadata.name
            operator: NotIn
            values:
            - spire
            - spire-server
            - spire-system
        spiffeIDTemplate: spiffe://{{ .TrustDomain }}/ns/{{ .PodMeta.Namespace }}/sa/{{
            .PodSpec.ServiceAccountName }}
  ```

  Useful command for troubleshooting connection problems to list created entries:

  ```bash
  kubctl exec -n spire spire-server-0 -- /opt/spire/bin/spire-server entry
  ```

</details>

### 3. Deploy SLIM controller
```bash
task templates:slim:controller:deploy
```

<details>
  <summary>More Details</summary>
  
  This step will deploy SLIM Controller Southbound API configured with MTLS.
  Controller support MTLS by Spire natively, just need to be enabled and `socketPath` has to be set:

  ```yaml
    config:
        northbound:
            httpHost: 0.0.0.0
            httpPort: "{{ .Values.service.north.port }}"

        southbound:
            httpHost: 0.0.0.0
            httpPort: "{{ .Values.service.south.port }}"    
            tls:
                useSpiffe: true
            spire:
                socketPath: "unix:///run/spire/agent-sockets/api.sock"
  ```

  See [SLIM Controller Helm chart values](../controller-values.yaml)

</details>


### 4. Deploy SLIM as StatefulSet
```bash
task slim:deploy
```

<details>
  <summary>More Details</summary>
  
  This step will deploy 3 replicas of SLIM servers and a `ClusterIP` service. 
  In each SLIM pod there's a `spire-helper` container running fetching generated X509 certificates, keys and certificate bundles
  to the configured path. SLIM nodes must be configured to use MTLS using the same path.

  ```yaml
    services:
      slim/0:
        node_id: ${env:SLIM_SVC_ID}
        dataplane:
          servers:
            - endpoint: "0.0.0.0:{{ .Values.slim.service.data.port }}"
              tls:
                #insecure: true
                insecure_skip_verify: false
                cert_file: "/svids/tls.crt"
                key_file: "/svids/tls.key"
                ca_file: "/svids/svid_bundle.pem"                

          clients: []
        controller:
          clients:
            - endpoint: "https://slim-control:50052"
              tls:
                #insecure: true
                insecure_skip_verify: false
                cert_file: "/svids/tls.crt"
                key_file: "/svids/tls.key"
                ca_file: "/svids/svid_bundle.pem"
  ```

  Here is also important to set the `node_id` to a unique ID within the cluster, since this is used by Controller to identify SLIM server.

  See [SLIM Helm chart values](statefulset-values.yaml)

</details>

### 4. Verify the deployment
```bash
kubectl get statefulsets -n slim
kubectl get pods -n slim
```

### 5. View SLIM logs
```bash
task slim:show-logs
```

### 6. (Optional) Deploy sample client applications for testing
```bash
task apps:spire:receiver:deploy
```

### 6. (Optional) Deploy sample client applications for testing
```bash
task apps:spire:sender:deploy
```

### 7. Clean up when done
```bash
task slim:delete
task templates:cluster:down
```

**Note:** The statefulset strategy uses the `statefulset-values.yaml` file for Helm chart configuration. This values file contains specific settings for StatefulSet deployment, including SLIM-specific parameters and enhanced resource definitions. Review and customize this file according to your SLIM requirements.