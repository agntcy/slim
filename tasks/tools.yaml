# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

version: "3"

silent: true

vars:
  REPO_ROOT:
    sh: git rev-parse --show-toplevel

  TOOLS_MODULE_DIR: "{{.REPO_ROOT}}/internal/tools"

  TOOLS_INSTALL_DIR: "{{.REPO_ROOT}}/.tools"

  TOOLS_PACKAGES:
    sh: |
      grep -E '\s+_\s+".*"' {{.TOOLS_MODULE_DIR}}/tools.go | \
        tr -d " _\"" | \
        grep -vE '/v[0-9]+$$' | \
        tr '\n' ' '

  ADDITIONAL_TOOLS: "protoc"

  TMP_FOLDER: ".tmp"

  PROTOC_URL: "https://github.com/protocolbuffers/protobuf/releases/download"

  PROTOC_VERSION: "29.0"

tasks:
  tools:foreach:
    internal: true
    desc: Run task for each tool
    cmds:
      - |
        for tool in {{.TOOLS_PACKAGES}}; do
          echo "Tool: ${tool}"
          {{.CMD}}
        done

  tools:dir:
    internal: true
    cmds:
      - mkdir -p {{.TOOLS_INSTALL_DIR}}
    status:
      - test -d {{.TOOLS_INSTALL_DIR}}

  tools:gomodtidy:
    internal: true
    desc: Install go modules in tools
    cmds:
      - cd {{.TOOLS_MODULE_DIR}} && go mod tidy

  tools:buf:
    internal: true
    desc: Install buf
    cmds:
      - |
        BIN="{{.TOOLS_INSTALL_DIR}}" && \
        VERSION="1.56.0" && \
        curl -sSL \
        "https://github.com/bufbuild/buf/releases/download/v${VERSION}/buf-$(uname -s)-$(uname -m)" \
        -o "${BIN}/buf" && \
        chmod +x "${BIN}/buf"
    status:
      - test -f {{.TOOLS_INSTALL_DIR}}/buf

  tools:protoc:
    deps:
      - tools:dir
    dir: "{{.TMP_FOLDER}}"
    cmds:
      - |
        # Detect OS and architecture for cross-platform compatibility
        OS_NAME="$(uname -s | tr '[:upper:]' '[:lower:]')"
        ARCH_NAME="$(uname -m)"

        # Map to protoc release naming conventions
        case "$OS_NAME" in
          darwin) O="osx" ;;
          linux) O="linux" ;;
          mingw*|msys*|cygwin*) O="win64" ;;
          *) O="linux" ;;
        esac

        case "$ARCH_NAME" in
          x86_64|amd64) A="x86_64" ;;
          aarch64|arm64) A="aarch_64" ;;
          *) A="x86_64" ;;
        esac

        # Windows uses different naming (win64 instead of win64-x86_64)
        if [[ "$O" == "win64" ]]; then
          PROTOC_FILE="protoc-{{.PROTOC_VERSION}}-win64.zip"
        else
          PROTOC_FILE="protoc-{{.PROTOC_VERSION}}-$O-$A.zip"
        fi

        echo "Downloading protoc: $PROTOC_FILE"
        curl -L {{.PROTOC_URL}}/v{{.PROTOC_VERSION}}/$PROTOC_FILE -o protoc.zip
        unzip -o protoc.zip

        # Handle Windows .exe extension
        if [[ "$O" == "win64" ]]; then
          mv bin/protoc.exe {{.TOOLS_INSTALL_DIR}}/protoc.exe
        else
          mv bin/protoc {{.TOOLS_INSTALL_DIR}}/protoc
        fi
        mv include {{.TOOLS_INSTALL_DIR}}
        rm -f protoc.zip
    status:
      - |
        # Check for protoc or protoc.exe
        test -f {{.TOOLS_INSTALL_DIR}}/protoc || test -f {{.TOOLS_INSTALL_DIR}}/protoc.exe

  # Download packages
  tools:go-tools:
    internal: true
    deps:
      - tools:dir
      - tools:gomodtidy
    cmds:
      - task: tools:foreach
        vars:
          CMD: |
            unset GOOS
            unset GOARCH
            bin_name="$(basename ${tool})"
            # On Windows, Go automatically adds .exe extension
            cd {{.TOOLS_MODULE_DIR}} && go build -o {{.TOOLS_INSTALL_DIR}}/${bin_name} -trimpath ${tool}
    status:
      - |
        for tool in {{.TOOLS_PACKAGES}}; do
          bin_name="$(basename ${tool})"
          # Check for both with and without .exe extension (Windows compatibility)
          test -f {{.TOOLS_INSTALL_DIR}}/${bin_name} || test -f {{.TOOLS_INSTALL_DIR}}/${bin_name}.exe
        done

  tools:
    desc: Download tools
    cmds:
      - task: tools:protoc
      - task: tools:go-tools
