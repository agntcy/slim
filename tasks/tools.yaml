# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

version: "3"

silent: true

vars:
  REPO_ROOT:
    sh: git rev-parse --show-toplevel

  TOOLS_MODULE_DIR: "{{.REPO_ROOT}}/internal/tools"

  TOOLS_INSTALL_DIR: "{{.REPO_ROOT}}/.tools"

  TOOLS_PACKAGES:
    sh: |
      grep -E '\s+_\s+".*"' {{.TOOLS_MODULE_DIR}}/tools.go | \
        tr -d " _\"" | \
        grep -vE '/v[0-9]+$$' | \
        tr '\n' ' '

  ADDITIONAL_TOOLS: "protoc"

  TMP_FOLDER: ".tmp"

  PROTOC_URL: "https://github.com/protocolbuffers/protobuf/releases/download"

  PROTOC_VERSION: "29.0"

  DETECTED_OS:
    sh: |
        if [[ "{{OS}}" == "linux" ]]; then
          echo "linux"
        elif [[ "{{OS}}" == "darwin" ]]; then
          echo "macos"
        elif [[ "{{OS}}" == "windows" ]]; then
          echo "windows"
        else
          echo "unknown"
        fi

  DETECTED_ARCH:
    sh: |
        if [[ "{{ARCH}}" == "amd64" ]]; then
          echo "x86_64"
        elif [[ "{{ARCH}}" == "arm64" ]]; then
          echo "aarch64"
        else
          echo "unknown"
        fi

  EXTENSION:
    sh: |
        if [[ "{{.DETECTED_OS}}" == "windows" ]]; then
          echo "zip"
        else
          echo "tar.xz"
        fi

tasks:
  foreach:
    internal: true
    desc: Run task for each tool
    cmds:
      - |
        for tool in {{.TOOLS_PACKAGES}}; do
          echo "Tool: ${tool}"
          {{.CMD}}
        done

  dir:
    internal: true
    cmds:
      - mkdir -p {{.TOOLS_INSTALL_DIR}}
    status:
      - test -d {{.TOOLS_INSTALL_DIR}}

  gomodtidy:
    internal: true
    desc: Install go modules in tools
    cmds:
      - cd {{.TOOLS_MODULE_DIR}} && go mod tidy

  buf:
    internal: true
    desc: Install buf
    cmds:
      - |
        BIN="{{.TOOLS_INSTALL_DIR}}" && \
        VERSION="1.56.0" && \
        curl -sSL \
        "https://github.com/bufbuild/buf/releases/download/v${VERSION}/buf-$(uname -s)-$(uname -m)" \
        -o "${BIN}/buf" && \
        chmod +x "${BIN}/buf"
    status:
      - test -f {{.TOOLS_INSTALL_DIR}}/buf

  protoc:
    deps:
      - dir
    dir: "{{.TMP_FOLDER}}"
    cmds:
      - |
        A="{{ARCH}}"
        O="{{OS}}"
        [[ "{{ARCH}}" == "amd64" ]] && A="x86_64"
        [[ "{{ARCH}}" == "arm64" ]] && A="aarch_64"
        [[ "{{OS}}" == "darwin" ]] && O="osx"
        curl -L {{.PROTOC_URL}}/v{{.PROTOC_VERSION}}/protoc-{{.PROTOC_VERSION}}-$O-$A.zip -o protoc.zip
        unzip -o protoc.zip
        mv bin/protoc {{.TOOLS_INSTALL_DIR}}
        mv include {{.TOOLS_INSTALL_DIR}}
        rm -f protoc.zip
    status:
      - |
        for tool in {{.ADDITIONAL_TOOLS}}; do
          test -f {{.TOOLS_INSTALL_DIR}}/${tool}
        done

  go-tools:
    internal: true
    deps:
      - dir
      - gomodtidy
    cmds:
      - task: foreach
        vars:
          CMD: |
            unset GOOS
            unset GOARCH
            bin_name="$(basename ${tool})"
            cd {{.TOOLS_MODULE_DIR}} && go build -o {{.TOOLS_INSTALL_DIR}}/${bin_name} -trimpath ${tool}
    status:
      - |
        for tool in {{.TOOLS_PACKAGES}}; do
          bin_name="$(basename ${tool})"
          test -f {{.TOOLS_INSTALL_DIR}}/${bin_name}
        done

  all:
    desc: Download all tools
    cmds:
      - task: protoc
      - task: go-tools
      - task: zig

  zig:
    desc: Install Zig locally for all platforms via direct download
    dir: "{{.TMP_FOLDER}}"
    status:
      - test -f "{{.TOOLS_INSTALL_DIR}}/zig" || test -f "{{.TOOLS_INSTALL_DIR}}/zig.exe"
    deps:
      - dir
    vars:
      ZIG_VERSION: '{{.ZIG_VERSION | default "0.14.1"}}'
      DOWNLOAD_BASE: "https://ziglang.org/download/{{.ZIG_VERSION}}/zig-{{.DETECTED_ARCH}}-{{.DETECTED_OS}}-{{.ZIG_VERSION}}.{{.EXTENSION}}"
    cmds:
      - curl -L "{{.DOWNLOAD_BASE}}" -o "zig.{{.EXTENSION}}"
      - |
        if [[ "{{.EXTENSION}}" == "zip" ]]; then
          unzip -q "zig.{{.EXTENSION}}" -d .
        else
          tar -xf "zig.{{.EXTENSION}}" -C .
        fi
      - mv zig-{{.DETECTED_ARCH}}-{{.DETECTED_OS}}-{{.ZIG_VERSION}}/* "{{.TOOLS_INSTALL_DIR}}"
      - echo "Zig installed to {{.TOOLS_INSTALL_DIR}}"
      - task: dlltool-wrapper

  dlltool-wrapper:
    desc: Create dlltool wrapper script for MinGW cross-compilation
    status:
      - test -f "{{.TOOLS_INSTALL_DIR}}/{{.DETECTED_ARCH}}-w64-mingw32-dlltool"
    deps:
      - dir
    cmds:
      - |
        cat > "{{.TOOLS_INSTALL_DIR}}/{{.DETECTED_ARCH}}-w64-mingw32-dlltool" << 'EOF'
        #!/usr/bin/env sh
        # Wrapper script to use Zig's dlltool instead of MinGW's dlltool
        exec "{{.TOOLS_INSTALL_DIR}}/zig" dlltool "$@"
        EOF
      - chmod +x "{{.TOOLS_INSTALL_DIR}}/{{.DETECTED_ARCH}}-w64-mingw32-dlltool"
      - echo "Created dlltool wrapper at {{.TOOLS_INSTALL_DIR}}/{{.DETECTED_ARCH}}-w64-mingw32-dlltool"
