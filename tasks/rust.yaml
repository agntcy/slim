# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

---
version: "3"

includes:
  tools:
    taskfile: ./tools.yaml
    internal: true

silent: true
set: [pipefail]
shopt: [globstar]

vars:
  GLOBAL_ARGS: '{{.GLOBAL_ARGS | default ""}}'

  PROFILE: '{{.PROFILE | default "debug"}}'
  RELEASE:
    sh: '[[ {{.PROFILE}} == "release" ]] && echo "--release" || echo ""'
  CURRENT_TARGET:
    sh: 'rustc -vV | sed -n "s|host: ||p"'
  TARGET: "{{.TARGET | default .CURRENT_TARGET}}"
  TARGET_ARGS:
    sh: '[[ -z "{{.TARGET}}" ]] && echo '''' || echo ''--target {{.TARGET}}'''
  TARGET_ARCH:
    sh: 'echo {{.TARGET}} | cut -d"-" -f1'
  TARGET_OS:
    sh: 'echo {{.TARGET}} | cut -d"-" -f3'
  TARGET_ABI:
    sh: 'echo {{.TARGET}} | cut -d"-" -f4 || echo ""'

  LLVM_VERSION: '{{ .LLVM_VERSION | default "19" }}'
  OBJCOPY: 'llvm-objcopy-{{.LLVM_VERSION}}'

  GNU_CLIB_VERSION: '{{.GNU_CLIB_VERSION | default "2.28"}}'
  TOOLS_INSTALL_DIR: '{{.TOOLS_INSTALL_DIR | default ""}}'

tasks:
  print-vars:
    desc: "Print the variables"
    cmds:
      - |
        echo "Variables:"
        echo "  PROFILE: {{.PROFILE}}"
        echo "  RELEASE: {{.RELEASE}}"
        echo "  TARGET: {{.TARGET}}"
        echo "  TARGET_ARGS: {{.TARGET_ARGS}}"
        echo "  TARGET_ARCH: {{.TARGET_ARCH}}"
        echo "  LLVM_VERSION: {{.LLVM_VERSION}}"
        echo "  OBJCOPY: {{.OBJCOPY}}"
        echo ""

  fmt:
    desc: "Format the code"
    cmds:
      - cargo fmt {{.ARGS}}
    vars:
      ARGS: '{{ .ARGS | default "" }}'

  fmt:check:
    desc: "Check the code formatting"
    cmds:
      - task: fmt
        vars:
          ARGS: "-- --check"

  fetch:
    desc: "Fetch the dependencies"
    deps:
      - task: install-target
    cmds:
      - cargo fetch {{.TARGET_ARGS}} {{.ARGS}}
    vars:
      ARGS: '{{.ARGS | default "--locked"}}'

  tools:fetch:
    desc: "Fetch the dependencies"
    cmds:
      - task: install-cargo-components
        vars:
          COMPONENTS: "{{.CARGO_COMPONENTS}}"

  tools:hash:
    desc: "Compute the SHA-256 hash of the CARGO_COMPONENTS string"
    cmds:
      - cmd: sh -c "echo -n '{{.CARGO_COMPONENTS}}' | sha256sum | cut -d ' ' -f1"

  check:
    desc: "Check the project"
    deps:
      - task: install-target
    cmds:
      - cargo check {{.RELEASE}} {{.TARGET_ARGS}} {{.GLOBAL_ARGS}} {{.ARGS}}
    vars:
      ARGS: '{{.ARGS | default "--all-targets --locked"}}'

  clean:
    desc: "Clean the project"
    cmds:
      - cargo clean {{.ARGS}}
    vars:
      ARGS: '{{ .ARGS | default "" }}'

  clippy:
    desc: "Run clippy"
    deps:
      - task: install-target
    cmds:
      - cargo clippy {{.RELEASE}} {{.TARGET_ARGS}} {{.GLOBAL_ARGS}} {{.ARGS}} -- -D warnings
    vars:
      ARGS: '{{.ARGS | default "--all-targets --locked --all-features"}}'

  sort:check:
    desc: "Check the dependencies are sorted"
    cmds:
      - task: sort
        vars:
          ARGS: "--check"

  unused:check:
    desc: "Check for unused dependencies"
    deps:
      - task: install-cargo-components
        vars:
          COMPONENTS: "cargo-machete"
    cmds:
      - cargo machete {{.ARGS}}
    vars:
      ARGS: '{{ .ARGS | default "" }}'

  licenses:
    desc: "Check for licenses"
    deps:
      - task: install-cargo-components
        vars:
          COMPONENTS: "cargo-deny"
    cmds:
      - cargo deny check {{.ARGS}}
    vars:
      ARGS: '{{ .ARGS | default "" }}'

  typos:
    desc: "Check for typos"
    deps:
      - task: install-cargo-components
        vars:
          COMPONENTS: "typos-cli"
    cmds:
      - typos
    vars:
      ARGS: '{{ .ARGS | default "" }}'

  sort:
    desc: "Sort the dependencies"
    deps:
      - task: install-cargo-components
        vars:
          COMPONENTS: "cargo-sort"
    cmds:
      - cargo sort {{.GLOBAL_ARGS}} {{.ARGS}}
    vars:
      ARGS: '{{.ARGS | default ""}}'

  doc:
    desc: "Generate the documentation"
    cmds:
      - cargo doc {{.RELEASE}} {{.TARGET_ARGS}} {{.GLOBAL_ARGS}} {{.ARGS}}
    vars:
      ARGS: '{{.ARGS | default "--no-deps --locked --all-features"}}'

  lintall:
    desc: "Run the linter"
    cmds:
      - task: fmt:check
      - task: clippy
      - task: vuln
      - task: sort:check
      - task: unused:check
      - task: licenses
      - task: typos

  test:build:
    desc: "Build the tests"
    deps:
      - task: install-target
    cmds:
      - cargo test --no-run {{.RELEASE}} {{.TARGET_ARGS}} {{.GLOBAL_ARGS}} {{.ARGS}}
    vars:
      ARGS: '{{.ARGS | default "--all-targets --locked --all-features"}}'

  test:
    desc: "Run the tests"
    cmds:
      - cargo test {{.RELEASE}} {{.TARGET_ARGS}} {{.GLOBAL_ARGS}} {{.ARGS}}
      - task: bindings:test
      - task: core:test
    vars:
      ARGS: '{{.ARGS | default "--all-targets --locked --all-features"}}'

  test:coverage:
    desc: "Run tests coverage"
    deps:
      - task: install-cargo-components
        vars:
          COMPONENTS: "cargo-llvm-cov"
    cmds:
      - cargo llvm-cov --lcov --output-path lcov.info {{.GLOBAL_ARGS}} {{.ARGS}}
    vars:
      ARGS: '{{.ARGS | default "--all-targets --locked --all-features"}}'

  build:
    desc: "Build the project"
    deps:
      - task: install-target
    cmds:
      - cargo build {{.RELEASE}} {{.TARGET_ARGS}} {{.ARGS}}
    vars:
      ARGS: '{{.ARGS | default "--all-targets --locked --all-features"}}'

  vuln:
    desc: "Check for vulnerabilities"
    deps:
      - task: install-cargo-components
        vars:
          COMPONENTS: "cargo-audit"
    cmds:
      - cargo audit {{.ARGS}}
    vars:
      ARGS: '{{ .ARGS | default "" }}'

  crossbuild:
    desc: "Cross-compile the project using cargo-zigbuild"
    deps:
      - task: install-target
      - task: install-cargo-components
        vars:
          COMPONENTS: "cargo-zigbuild"
      - task: tools:zig
      - task: tools:dlltool-wrapper
    cmds:
      - |
        # Determine the correct libc version based on TARGET_ABI
        TARGET_ABI="{{.TARGET_ABI}}"
        TARGET_OS="{{.TARGET_OS}}"

        ARGS=()

        # Use zigbuild for Linux or gnu targets, cargo build for others
        if [[ "$TARGET_OS" == "linux" || "$TARGET_ABI" == "gnu" ]]; then
          # For Linux or gnu targets, use zigbuild with libc version for gnu ABI
          LIBC_VERSION=""
          if [[ "$TARGET_ABI" == "gnu" ]]; then
            LIBC_VERSION=".{{.GNU_CLIB_VERSION}}"
          fi

          ARGS=(
            "zigbuild"
            "--target"
            "{{.TARGET}}$LIBC_VERSION"
            {{.RELEASE}}
            {{.ARGS}}
          )
        else
          # For Windows MSVC/macOS, use regular cargo build without libc version
          ARGS=(
            "build"
            "--target"
            "{{.TARGET}}"
            {{.RELEASE}}
            {{.ARGS}}
          )
        fi

        echo cargo ${ARGS[*]}
        PATH="{{.TOOLS_INSTALL_DIR}}:$PATH" cargo "${ARGS[@]}"
    vars:
      ARGS: '{{ .ARGS | default "" }}'

  strip:
    desc: "Strip the binary"
    cmds:
      - "{{.OBJCOPY}} --only-keep-debug {{.TARGET_BIN}} {{.TARGET_BIN}}.dbg"
      - "{{.OBJCOPY}} --strip-unneeded {{.TARGET_BIN}}"
      - "{{.OBJCOPY}} --add-gnu-debuglink={{.TARGET_BIN}} {{.TARGET_BIN}}.dbg"
    vars:
      TARGET_BIN: '{{.TARGET_BIN | default ""}}'

  run:
    desc: "Run a binary"
    cmds:
      - "cargo run {{.RELEASE}} --bin {{.BIN}} {{.ARGS}} -- {{.BIN_ARGS}}"
    vars:
      BIN: '{{.BIN | default "slim"}}'
      ARGS: '{{ .ARGS | default "" }}'
      BIN_ARGS: '{{ .BIN_ARGS | default "" }}'

  run-command:
    desc: "Run a command"
    dir: '{{.DIR | default ""}}'
    deps:
      - task: install-target
    cmds:
      - "{{.COMMAND}}"
    vars:
      COMMAND: '{{.COMMAND | default ""}}'

  install-target:
    desc: "Install the target"
    internal: true
    cmds:
      - rustup target add {{.TARGET}}

  install-cargo-components:
    desc: "Install cargo components"
    internal: true
    cmds:
      - cargo install {{.COMPONENTS}}
    vars:
      COMPONENTS: '{{ .COMPONENTS | default "" }}'
