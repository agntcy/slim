# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

version: '3'

vars:
  ROOT_DIR:
    sh: pwd
  # OpenTelemetry Collector Builder settings
  OCB_VERSION: 0.142.0
  GOOS:
    sh: go env GOOS
  GOARCH:
    sh: go env GOARCH
  OCB_BINARY: ocb_{{.OCB_VERSION}}_{{.GOOS}}_{{.GOARCH}}
  OCB_URL: https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/cmd%2Fbuilder%2Fv{{.OCB_VERSION}}/{{.OCB_BINARY}}
  COLLECTOR_OUTPUT: ./slim-otelcol
  # Docker settings
  DOCKER_IMAGE: slim-otelcol
  DOCKER_TAG: latest

tasks:
  default:
    cmds:
      - task -l

  # OpenTelemetry Collector Builder
  collector:download-ocb:
    desc: Download OpenTelemetry Collector Builder for current architecture
    cmds:
      - echo "Downloading OCB {{.OCB_VERSION}} for {{.GOOS}}/{{.GOARCH}}..."
      - curl -L -o ocb "{{.OCB_URL}}"
      - chmod +x ocb
      - echo "OCB downloaded successfully"
    status:
      - test -f ocb

  collector:build:
    desc: Build the SLIM OpenTelemetry Collector
    deps:
      - collector:download-ocb
    cmds:
      - echo "Generating collector sources..."
      - ./ocb --config builder-config.yaml --skip-compilation
      - echo "Compiling with CGO enabled..."
      - go get github.com/agntcy/slim-bindings-go@main
      - go run github.com/agntcy/slim-bindings-go/cmd/slim-bindings-setup@main
      - cd {{.COLLECTOR_OUTPUT}} && CGO_ENABLED=1 go build -trimpath -o slim-otelcol -ldflags="-s -w"
      - echo "Collector built successfully at {{.COLLECTOR_OUTPUT}}/slim-otelcol"

  collector:clean:
    desc: Clean the generated collector directory
    cmds:
      - rm -rf {{.COLLECTOR_OUTPUT}}
      - echo "Collector build directory cleaned"

  collector:run:
    desc: Run the SLIM OpenTelemetry Collector
    cmds:
      - echo "Running SLIM OpenTelemetry Collector..."
      - "{{.COLLECTOR_OUTPUT}}/slim-otelcol --config {{.ROOT_DIR}}/collector-config.yaml"

  collector:test:
    desc: Run tests for the SLIM exporter
    dir: slimexporter
    cmds:
      - echo "Running slimexporter tests..."
      - go test -v

  # Docker tasks
  docker:build:
    desc: Build Docker image for the SLIM OpenTelemetry Collector
    cmds:
      - echo "Building Docker image {{.DOCKER_IMAGE}}:{{.DOCKER_TAG}}..."
      - docker build -t {{.DOCKER_IMAGE}}:{{.DOCKER_TAG}} .
      - echo "Cleaning up temporary bindings..."
      - echo "Docker image built successfully"

  docker:run:
    desc: Run the SLIM collector in Docker
    cmds:
      - echo "Starting SLIM OpenTelemetry Collector container..."
      - >
        docker run --rm -p 4317:4317 -p 4318:4318
        -v {{.ROOT_DIR}}/collector-config.yaml:/etc/otel/config.yaml:ro
        {{.DOCKER_IMAGE}}:{{.DOCKER_TAG}}

  # Examples
  test:app:participant:
    desc: Run the test app
    dir: testapp
    cmds:
      - echo "Running test app in participant mode..."
      - >
        go run .
        --app-name "agntcy/otel/receiver-app"
        --server "http://localhost:46357"
        --secret "a-very-long-shared-secret-0123456789-abcdefg"

  test:app:initiator:
    desc: Run the test app
    dir: testapp
    cmds:
      - echo "Running test app in initiator mode..."
      - >
        go run .
        --app-name "agntcy/otel/receiver-app"
        --server "http://localhost:46357"
        --secret "a-very-long-shared-secret-0123456789-abcdefg"
        --exporter-name "agntcy/otel/exporter"
        --channel-name "agntcy/otel/initiator-channel"

  test:slim:run:
    desc: Run a SLIM node for testing
    dir: ../data-plane
    cmds:
      - cargo run --bin slim -- --config ./config/base/server-config.yaml
