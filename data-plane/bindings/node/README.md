# SLIM Node.js Bindings

Node.js bindings for SLIM (Secure Lightweight Identity Messaging) using UniFFI.

## Overview

This directory contains standalone Node.js bindings for the SLIM Rust core, generated using [`uniffi-bindgen-node`](https://github.com/livekit/uniffi-bindgen-node). These bindings are completely independent from the React Native bindings in `bindings/react-native/`.

### Architecture

```
bindings/rust (Shared UniFFI Core)
    ├── uniffi-bindgen-go → bindings/go/
    ├── Maturin + UniFFI → bindings/python/
    ├── uniffi-bindgen-react-native → bindings/react-native/
    └── uniffi-bindgen-node → bindings/node/ (THIS DIRECTORY)
```

## Quick Start

### Prerequisites

- Rust toolchain (for building the native library)
- Node.js >= 18
- [Task](https://taskfile.dev/) (task runner)
- `uniffi-bindgen-node` (installed automatically)

### Generate Bindings

```bash
# From this directory (data-plane/bindings/node)
task generate
```

This will:
1. Build the Rust library as a dynamic library (`.dylib`/`.so`/`.dll`)
2. Install `uniffi-bindgen-node` if not present
3. Generate TypeScript bindings
4. Copy the dynamic library to `generated/`
5. Apply necessary patches (FfiConverterBytes → FfiConverterArrayBuffer)

### Run Examples

```bash
# Terminal 1: Start the server
npm run example:server

# Terminal 2: Start Alice (receiver)
npm run example:alice

# Terminal 3: Start Bob (sender) from Go bindings
cd ../go
go run examples/point_to_point/main.go
```

## What Works

✅ **Server functionality** - Full working Node.js server implementation  
✅ **Receiving messages** - Alice can connect, subscribe, and receive messages  
✅ **Connection management** - App creation, connection, subscription  

## Known Limitations

### uniffi-bindgen-node Issues

⚠️ **Message sending is currently blocked** due to bugs in `uniffi-bindgen-node`:

- **Error**: `Object property 'capacity' type mismatch. Expect value to be Number, but received Undefined`
- **Root cause**: The tool imports types from `uniffi-bindgen-react-native` (designed for React Native's JSI bridge) but uses `ffi-rs` for Node.js FFI. These type systems are incompatible.
- **Impact**: Cannot send messages or replies from Node.js
- **Workaround**: Use Go or Python bindings for sending messages

### Fixed Issues

The following issues have been worked around in the build process:

1. **FfiConverterBytes undefined** → Automatically patched to use `FfiConverterArrayBuffer`
2. **Type mismatches** → Examples use explicit `BigInt()` conversions and `undefined` instead of `null`
3. **Server lifecycle** → Examples keep event loop alive with `setInterval`

## Project Structure

```
data-plane/bindings/node/
├── Taskfile.yaml              # Build automation
├── package.json               # Package definition
├── tsconfig.json              # TypeScript configuration
├── .gitignore                 # Git ignore patterns
├── README.md                  # This file
├── generated/                 # Auto-generated bindings (git-ignored)
│   ├── package.json          # Generated by uniffi-bindgen-node
│   ├── slim-bindings-node.ts # TypeScript bindings
│   ├── slim-bindings-sys.ts  # FFI layer
│   └── libslim_bindings.*    # Dynamic library
└── examples/                  # Example applications
    ├── common.ts             # Shared utilities
    ├── server.ts             # Server implementation
    ├── point-to-point-alice.ts # Receiver example
    ├── package.json          # Examples dependencies
    ├── tsconfig.json         # Examples TypeScript config
    └── README.md             # Examples documentation
```

## Comparison with Other Bindings

| Aspect | bindings/react-native | bindings/node |
|--------|----------------------|---------------|
| **Target** | React Native mobile | Node.js server |
| **Bindgen** | uniffi-bindgen-react-native | uniffi-bindgen-node |
| **Library** | Static lib (.a) | Dynamic lib (.dylib/.so/.dll) |
| **FFI** | JSI (C++) | ffi-rs (JavaScript) |
| **Use case** | Mobile apps | Server-side applications |

## Development

### Clean Build

```bash
task clean      # Remove generated files and node_modules
task generate   # Generate fresh bindings
```

### Testing

Currently, testing is manual:
1. Generate bindings
2. Run examples
3. Verify message flow between Node.js and Go

## Future Work

To achieve full functionality, one of these approaches is needed:

1. **Fix uniffi-bindgen-node**: Patch the tool to generate `ffi-rs`-compatible struct definitions
2. **Alternative FFI**: Use a different Node.js FFI library (e.g., `node-ffi-napi`)
3. **Native Module**: Build a proper N-API native module instead of using UniFFI
4. **Wait for Updates**: Monitor `uniffi-bindgen-node` for bug fixes

## Resources

- [uniffi-bindgen-node](https://github.com/livekit/uniffi-bindgen-node)
- [UniFFI Documentation](https://mozilla.github.io/uniffi-rs/)
- [ffi-rs](https://www.npmjs.com/package/ffi-rs)
- [SLIM Core](https://github.com/agntcy/slim)

## License

Apache License 2.0 - See LICENSE file in the repository root.
