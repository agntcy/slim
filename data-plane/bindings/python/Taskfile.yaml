# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

---
version: '3'

silent: true
set: [pipefail]
shopt: [globstar]

verbose: false

includes:
  rust:
    taskfile: ../../../tasks/rust.yaml
    internal: true
    vars:
      PROFILE: '{{.PROFILE | default "release"}}'
  tools:
    taskfile: ../../../tasks/tools.yaml
    internal: true

env:
  SHARED_SECRET: "demo-secret-key-for-examples012345"

tasks:
  default:
    cmds:
      - task -l

  python:bindings:devdeps:
    internal: true
    cmds:
      - uv sync --group linting --group testing

  python:bindings:lint:
    desc: "Lint the Python bindings"
    deps:
       - python:bindings:devdeps
    cmds:
      - uv sync --group linting
      - uv run ruff check
      - uv run ruff format --check
      - uv run mypy --ignore-missing-imports --explicit-package-bases .

  python:bindings:build:
    desc: "Build the Python bindings using Maturin"
    vars:
      PROFILE: '{{.PROFILE | default "debug"}}'
      RELEASE:
        sh: '[[ {{.PROFILE}} == "release" ]] && echo "--release" || echo ""'
    cmds:
      - echo "ðŸ”¨ Building Python bindings..."
      - task: rust:run-command
        vars:
          COMMAND: |
            uv run maturin develop --uv {{.RELEASE}}
      - echo "âœ… Build complete"

  python:bindings:test:
    desc: "Test the Python bindings"
    deps:
      - python:bindings:build
      - python:bindings:devdeps
    cmds:
      - uv run pytest -s {{.TESTS}}
    vars:
      TARGET: '{{.TESTS | default ""}}'

  python:bindings:packaging:
    desc: "Generate Python wheels for multiple Python versions (3.10, 3.11, 3.12, 3.13, 3.14) using Maturin"
    deps:
      - tools:zig
    vars:
      INTERPRETERS: '{{.INTERPRETERS | default "3.10 3.11 3.12 3.13 3.14"}}'
    cmds:
      - |
        # Force aarch64 Python on Windows ARM64, as uv defaults to x86_64 even on ARM64
        if [[ "{{.TARGET_ARCH}}" = "aarch64" && "{{.TARGET_OS}}" = "windows" ]]; then
          uv python install "aarch64"
        else
          uv python install
        fi

        rustup target add {{.TARGET}}

        MATURIN_ARGS=(
          {{.RELEASE}}
          --out dist
          --target {{.TARGET}}
          --frozen
          -i {{.INTERPRETERS}}
        )

        if [[ "{{.TARGET_ABI}}" = "gnu" ]]; then
          MATURIN_ARGS+=(
            --compatibility manylinux_2_28
            --zig
          )
        elif [[ "{{.TARGET_ABI}}" = "musl" ]]; then
          MATURIN_ARGS+=(
            --compatibility musllinux_1_2
            --zig
          )
        fi

        # Workaround for windows
        if [[ "{{.TARGET_OS}}" = "windows" ]]; then
          uv sync ${UV_ARGS[@]}
          uv run ${UV_ARGS[@]} maturin develop --uv {{.RELEASE}}

          # This file is a leftover from the previous build, delete it otherwise
          # maturin will try to add it to the wheel, and it will fail
          rm -f slim_bindings/*.pyd
        fi

        echo "Running maturin with the following args: ${MATURIN_ARGS[@]}"

        PATH=${PATH}:{{.TOOLS_INSTALL_DIR}} \
        uv run                              \
          ${UV_ARGS[@]}                     \
          maturin build                     \
          ${MATURIN_ARGS[@]}

  python:bindings:test:wheel:
    desc: "Test wheel installation across Python versions 3.10-3.14"
    vars:
      WHEEL: '{{.WHEEL | default ""}}'
      VERSION:
        sh: grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/'
      INTERPRETERS: '{{.INTERPRETERS | default "3.10 3.11 3.12 3.13 3.14"}}'
    cmds:
      - |
        # Detect system and architecture
        OS=$(uname -s | tr '[:upper:]' '[:lower:]')
        ARCH=$(uname -m)

        # Normalize architecture names
        case "$ARCH" in
          x86_64|amd64)
            ARCH="x86_64"
            ;;
          aarch64|arm64)
            ARCH="aarch64"
            ;;
          *)
            echo "âŒ Unsupported architecture: $ARCH"
            exit 1
            ;;
        esac

        # Determine wheel file based on OS
        if [ -n "{{.WHEEL}}" ]; then
          WHEEL_FILE="{{.WHEEL}}"
        else
          case "$OS" in
            linux)
              WHEEL_FILE="dist/slim_bindings-{{.VERSION}}-py3-none-manylinux_2_28_${ARCH}.whl"
              ;;
            darwin)
              # macOS universal2 wheel
              WHEEL_FILE="dist/slim_bindings-{{.VERSION}}-py3-none-macosx_11_0_${ARCH}.whl"
              # Fallback to universal2
              if [ ! -f "$WHEEL_FILE" ]; then
                WHEEL_FILE="dist/slim_bindings-{{.VERSION}}-py3-none-macosx_11_0_universal2.whl"
              fi
              ;;
            mingw*|msys*|cygwin*)
              WHEEL_FILE="dist/slim_bindings-{{.VERSION}}-py3-none-win_${ARCH}.whl"
              ;;
            *)
              echo "âŒ Unsupported OS: $OS"
              exit 1
              ;;
          esac
        fi

        echo "ðŸ” Detected system: $OS ($ARCH)"
        echo "ðŸ§ª Testing wheel installation: $WHEEL_FILE"
        echo "Python versions: {{.INTERPRETERS}}"
        echo ""

        if [ ! -f "$WHEEL_FILE" ]; then
          echo "âŒ Wheel file not found: $WHEEL_FILE"
          echo ""
          echo "Available wheels in dist/:"
          ls -1 dist/*.whl 2>/dev/null || echo "  (no wheels found)"
          exit 1
        fi

        uv python install {{.INTERPRETERS}}

        FAILED=0
        for py_version in {{.INTERPRETERS}}; do
          echo "Testing Python ${py_version}..."

          VENV_DIR=".test-venv-${py_version}"
          rm -rf "$VENV_DIR"

          if uv venv "$VENV_DIR" --python "${py_version}" 2>&1; then
            if uv pip install --python "$VENV_DIR" "$WHEEL_FILE" 2>&1; then
              if uv run --python "$VENV_DIR" python -c "import slim_bindings; print('  âœ… Module imported successfully')" 2>&1; then
                echo "  âœ… Python ${py_version}: Installation and import successful"
              else
                echo "  âŒ Python ${py_version}: Import failed"
                FAILED=$((FAILED + 1))
              fi
            else
              echo "  âŒ Python ${py_version}: Installation failed"
              FAILED=$((FAILED + 1))
            fi
          else
            echo "  âŒ Python ${py_version}: Failed to create venv"
            FAILED=$((FAILED + 1))
          fi

          rm -rf "$VENV_DIR"
          echo ""
        done

        if [ $FAILED -eq 0 ]; then
          echo "âœ… All Python versions tested successfully!"
        else
          echo "âŒ $FAILED Python version(s) failed"
          exit 1
        fi

  python:bindings:clean:
    desc: Clean build artifacts
    cmds:
      - echo "ðŸ§¹ Cleaning build artifacts..."
      - uv pip uninstall -y slim-bindings 2>/dev/null || true
      - rm -rf ../rust/target/debug/libslim_bindings.so
      - rm -rf ../rust/target/debug/libslim_bindings.dylib
      - rm -rf ../rust/target/debug/libslim_bindings.dll
      - rm -rf ../rust/target/debug/deps/libslim_bindings.so
      - rm -rf ../rust/target/debug/deps/libslim_bindings.dylib
      - rm -rf ../rust/target/debug/deps/libslim_bindings.dll
      - rm -rf .venv/lib/python*/site-packages/slim_bindings/
      - rm -rf .venv/lib/python*/site-packages/slim_bindings-*.dist-info/
      - rm -rf dist/
      - rm -rf build/
      - rm -rf *.egg-info/
      - rm -rf .pytest_cache/
      - rm -rf __pycache__/
      - rm -rf slim_bindings/__pycache__/
      - rm -rf slim_bindings/*.so
      - rm -rf slim_bindings/*.dylib
      - rm -rf slim_bindings/*.dll
      - rm -rf slim_bindings/*.pyd
      - rm -rf examples/__pycache__/
      - rm -rf examples/*/__pycache__/
      - rm -rf tests/__pycache__/
      - echo "âœ… Clean complete"

  python:bindings:install-examples:
    desc: "Install slim-bindings with examples dependencies"
    cmds:
      - uv pip install 'slim-bindings[examples]'

  python:example:server:
    desc: "Run the server example"
    env:
      SLIM_INSTANCE_ID: server
    cmds:
      - uv run slim-bindings-server --slim "127.0.0.1:46357" {{.EXTRA_ARGS}}
    vars:
      EXTRA_ARGS: '{{.EXTRA_ARGS | default ""}}'

  python:example:p2p:alice:
    desc: "Point to Point example - Alice will listen for messages and echo them"
    deps:
      - python:bindings:install-examples
    cmds:
      - |
        uv run slim-bindings-p2p                                                      \
          --local agntcy/ns/alice                                                     \
          --shared-secret $SHARED_SECRET {{.EXTRA_ARGS}}
    vars:
      EXTRA_ARGS: '{{.EXTRA_ARGS | default ""}}'

  python:example:p2p:no-mls:bob:
    desc: "Point to Point example - Bob will send unencrypted messages to Alice"
    deps:
      - python:bindings:install-examples
    env:
      SLIM_INSTANCE_ID: bob
    cmds:
      - |
        uv run slim-bindings-p2p                                                      \
          --local agntcy/ns/bob                                                       \
          --shared-secret $SHARED_SECRET                                              \
          --remote agntcy/ns/alice                                                    \
          --message "hey there"                                                       \
    vars:
      EXTRA_ARGS: '{{.EXTRA_ARGS | default ""}}'

  python:example:p2p:mls:bob:
    desc: "Point to Point example - Bob will send encrypted messages to Alice"
    deps:
      - python:bindings:install-examples
    env:
      SLIM_INSTANCE_ID: bob
    cmds:
      - |
        uv run slim-bindings-p2p                                                      \
          --local agntcy/ns/bob                                                       \
          --shared-secret $SHARED_SECRET                                              \
          --remote agntcy/ns/alice                                                    \
          --message "hey there"                                                       \
          --enable-mls                                                                \
    vars:
      EXTRA_ARGS: '{{.EXTRA_ARGS | default ""}}'

  python:example:group:moderator:
    desc: "group moderator example - Creates a channel, invites participants, and sends encrypted messages"
    deps:
      - python:bindings:install-examples
    cmds:
      - |
        uv run slim-bindings-group                                                    \
          --local agntcy/ns/moderator                                                 \
          --shared-secret $SHARED_SECRET                                              \
          --remote agntcy/ns/chat                                                     \
          --invites agntcy/ns/client-1                                                \
          --invites agntcy/ns/client-2                                                \
          --enable-mls {{.EXTRA_ARGS}}
    vars:
      EXTRA_ARGS: '{{.EXTRA_ARGS | default ""}}'

  python:example:group:client-1:
    desc: "Group client example - Waits to be invited to a channel and receives encrypted messages"
    deps:
      - python:bindings:install-examples
    cmds:
      - |
        uv run slim-bindings-group                                                    \
          --local agntcy/ns/client-1                                                  \
          --shared-secret $SHARED_SECRET{{.EXTRA_ARGS}}
    vars:
      EXTRA_ARGS: '{{.EXTRA_ARGS | default ""}}'

  python:example:group:client-2:
    desc: "Group client example - Waits to be invited to a channel and receives encrypted messages"
    deps:
      - python:bindings:install-examples
    cmds:
      - |
        uv run slim-bindings-group                                                    \
          --local agntcy/ns/client-2                                                  \
          --shared-secret $SHARED_SECRET{{.EXTRA_ARGS}}
    vars:
      EXTRA_ARGS: '{{.EXTRA_ARGS | default ""}}'

  python:generate-proto:
    desc: "Generate proto files for the Python bindings"
    deps:
      - task: rust:toolchain:run-command
        vars:
          COMMAND: |
            cargo build --package agntcy-protoc-slimrpc-plugin --bin protoc-gen-slimrpc-python --release
      - task: tools:buf
    cmds:
      - |
        # Find all the buf.gen.yaml files in the current directory and its subdirectories
        find . -name 'buf.gen.yaml' | while read -r file; do
          # Generate the proto files using buf
          echo "Generating proto files for $file"
          # get folder name
          folder=$(dirname "$file")
          pushd > /dev/null ${folder} && {{.TOOLS_INSTALL_DIR}}/buf generate && popd > /dev/null
        done
