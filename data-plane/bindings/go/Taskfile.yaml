# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

version: '3'

vars:
  # The Rust UniFFI bindings crate - in bindings/adapter (sibling to bindings/go)
  BINDINGS_DIR: ../adapter
  SERVICE_TARGET: ../../target/release
  LIB_NAME: slim_bindings
  # Get absolute path for CGO flags
  ROOT_DIR:
    sh: pwd
  LIB_PATH: "{{.ROOT_DIR}}/{{.SERVICE_TARGET}}/lib{{.LIB_NAME}}.dylib"
  LIB_DIR: "{{.ROOT_DIR}}/{{.SERVICE_TARGET}}"
  CGO_LDFLAGS: "-L{{.LIB_DIR}} -l{{.LIB_NAME}}"
  DYLD_PATH: "{{.LIB_DIR}}:{{.ENV.DYLD_LIBRARY_PATH}}"
  LD_PATH: "{{.LIB_DIR}}:{{.ENV.LD_LIBRARY_PATH}}"
  # Windows PATH extension for DLL loading and MinGW compiler
  MINGW_BIN: "{{.ENV.LOCALAPPDATA}}/Microsoft/WinGet/Packages/BrechtSanders.WinLibs.POSIX.UCRT_Microsoft.Winget.Source_8wekyb3d8bbwe/mingw64/bin"
  WIN_PATH: "{{.MINGW_BIN}}:{{.LIB_DIR}}:{{.ENV.PATH}}"

tasks:
  default:
    cmds:
      - task -l

  rust-build:
    desc: Build the Rust library with UniFFI (release mode)
    dir: "{{.BINDINGS_DIR}}"
    cmds:
      - echo "ðŸ¦€ Building Rust bindings library with UniFFI (release mode)..."
      - cargo build --release
    silent: true

  ensure-lib:
    desc: Ensure the UniFFI library is built
    cmds:
      - |
        # Check for library (platform-specific)
        if [ -f "{{.LIB_DIR}}/{{.LIB_NAME}}.dll" ]; then
          echo "âœ… Found UniFFI library: {{.LIB_DIR}}/{{.LIB_NAME}}.dll"
        elif [ -f "{{.LIB_DIR}}/lib{{.LIB_NAME}}.dylib" ]; then
          echo "âœ… Found UniFFI library: {{.LIB_DIR}}/lib{{.LIB_NAME}}.dylib"
        elif [ -f "{{.LIB_DIR}}/lib{{.LIB_NAME}}.so" ]; then
          echo "âœ… Found UniFFI library: {{.LIB_DIR}}/lib{{.LIB_NAME}}.so"
        else
          echo "âš ï¸  UniFFI library not found, building now..."
          task rust-build
        fi
    silent: true

  generate:
    desc: Generate Go bindings from compiled library
    deps: [ensure-lib]
    cmds:
      - echo "ðŸ”§ Generating Go bindings from compiled library..."
      - |
        # Platform-specific library path
        if [ -f "{{.SERVICE_TARGET}}/{{.LIB_NAME}}.dll" ]; then
          LIB_FILE="{{.SERVICE_TARGET}}/{{.LIB_NAME}}.dll"
        elif [ -f "{{.SERVICE_TARGET}}/lib{{.LIB_NAME}}.dylib" ]; then
          LIB_FILE="{{.SERVICE_TARGET}}/lib{{.LIB_NAME}}.dylib"
        elif [ -f "{{.SERVICE_TARGET}}/lib{{.LIB_NAME}}.so" ]; then
          LIB_FILE="{{.SERVICE_TARGET}}/lib{{.LIB_NAME}}.so"
        else
          echo "âŒ Library not found"
          exit 1
        fi
        uniffi-bindgen-go --library "$LIB_FILE" --out-dir generated
      - cd generated && go mod init github.com/agntcy/slim/bindings/generated 2>/dev/null || true
      - echo "âœ… Bindings generated in generated/"
    silent: true

  install-uniffi-bindgen-go:
    desc: Install uniffi-bindgen-go
    cmds:
      - cargo install uniffi-bindgen-go --git https://github.com/NordSecurity/uniffi-bindgen-go.git --tag v0.4.0+v0.28.3 --config net.git-fetch-with-cli=true

  test:
    desc: Run all tests
    deps: [ensure-lib]
    env:
      CGO_LDFLAGS: "{{.CGO_LDFLAGS}}"
      DYLD_LIBRARY_PATH: "{{.DYLD_PATH}}"
      LD_LIBRARY_PATH: "{{.LD_PATH}}"
    cmds:
      - echo "ðŸ§ª Running all tests..."
      - go test -v ./...
      - echo "âœ… All Go tests passed"
    silent: true

  test-coverage:
    desc: Run tests with coverage report
    deps: [ensure-lib]
    env:
      CGO_LDFLAGS: "{{.CGO_LDFLAGS}}"
      DYLD_LIBRARY_PATH: "{{.DYLD_PATH}}"
      LD_LIBRARY_PATH: "{{.LD_PATH}}"
    cmds:
      - echo "ðŸ“Š Running tests with coverage..."
      - go test -v -coverprofile=coverage.out ./...
      - go tool cover -html=coverage.out -o coverage.html
      - echo "âœ… Coverage report generated in coverage.html"
    silent: true

  clean:
    desc: Clean build artifacts
    cmds:
      - echo "ðŸ§¹ Cleaning build artifacts..."
      - cd {{.BINDINGS_DIR}} && cargo clean
      - rm -rf generated/
      - echo "âœ… Clean complete"
    silent: true

  # Examples
  example:
    desc: Run the simple example
    deps: [ensure-lib]
    dir: examples/simple
    env:
      CGO_LDFLAGS: "{{.CGO_LDFLAGS}}"
      DYLD_LIBRARY_PATH: "{{.DYLD_PATH}}"
      LD_LIBRARY_PATH: "{{.LD_PATH}}"
    cmds:
      - echo "ðŸš€ Running simple example..."
      - go run .
    silent: true

  example:server:
    desc: Run the SLIM server
    deps: [ensure-lib]
    dir: cmd/server
    env:
      CGO_LDFLAGS: "{{.CGO_LDFLAGS}}"
      DYLD_LIBRARY_PATH: "{{.DYLD_PATH}}"
      LD_LIBRARY_PATH: "{{.LD_PATH}}"
    cmds:
      - echo "ðŸš€ Starting SLIM server..."
      - go run . {{.CLI_ARGS}}
    silent: true

  example:p2p:alice:
    desc: Run Alice (receiver) for point-to-point example
    deps: [ensure-lib]
    dir: examples/point_to_point
    env:
      CGO_LDFLAGS: "{{.CGO_LDFLAGS}}"
      DYLD_LIBRARY_PATH: "{{.DYLD_PATH}}"
      LD_LIBRARY_PATH: "{{.LD_PATH}}"
    cmds:
      - echo "ðŸ‘© Starting Alice (receiver)..."
      - go run . --local="org/alice/app" --server="http://localhost:46357" {{.CLI_ARGS}}
    silent: true

  example:p2p:bob:
    desc: Run Bob (sender) for point-to-point example
    deps: [ensure-lib]
    dir: examples/point_to_point
    env:
      CGO_LDFLAGS: "{{.CGO_LDFLAGS}}"
      DYLD_LIBRARY_PATH: "{{.DYLD_PATH}}"
      LD_LIBRARY_PATH: "{{.LD_PATH}}"
    cmds:
      - echo "ðŸ‘¨ Starting Bob (sender)..."
      - go run . --local="org/bob/app" --remote="org/alice/app" --message="Hello SLIM" --iterations=5 --server="http://localhost:46357" {{.CLI_ARGS}}
    silent: true

  example:group:moderator:
    desc: Run group moderator (creates session and invites participants)
    deps: [ensure-lib]
    dir: examples/group
    env:
      CGO_LDFLAGS: "{{.CGO_LDFLAGS}}"
      DYLD_LIBRARY_PATH: "{{.DYLD_PATH}}"
      LD_LIBRARY_PATH: "{{.LD_PATH}}"
    cmds:
      - echo "ðŸ‘‘ Starting group moderator..."
      - go run . --local="org/moderator/app" --remote="org/default/chat-room" --invites="org/alice/app,org/bob/app" --server="http://localhost:46357" {{.CLI_ARGS}}
    silent: true

  example:group:participant:alice:
    desc: Run group participant (waits for invitation)
    deps: [ensure-lib]
    dir: examples/group
    env:
      CGO_LDFLAGS: "{{.CGO_LDFLAGS}}"
      DYLD_LIBRARY_PATH: "{{.DYLD_PATH}}"
      LD_LIBRARY_PATH: "{{.LD_PATH}}"
    cmds:
      - echo "ðŸ‘¤ Starting group participant..."
      - go run . --local="org/alice/app" --server="http://localhost:46357" {{.CLI_ARGS}}
    silent: true
  
  example:group:participant:bob:
    desc: Run group participant (waits for invitation)
    deps: [ensure-lib]
    dir: examples/group
    env:
      CGO_LDFLAGS: "{{.CGO_LDFLAGS}}"
      DYLD_LIBRARY_PATH: "{{.DYLD_PATH}}"
      LD_LIBRARY_PATH: "{{.LD_PATH}}"
    cmds:
      - echo "ðŸ‘¤ Starting group participant..."
      - go run . --local="org/bob/app" --server="http://localhost:46357" {{.CLI_ARGS}}
    silent: true

  # Chat example tasks
  example:chat:create:
    desc: Create a chat room (moderator mode)
    deps: [ensure-lib]
    dir: examples/chat
    env:
      CGO_ENABLED: "1"
      CGO_LDFLAGS: "{{.CGO_LDFLAGS}}"
      DYLD_LIBRARY_PATH: "{{.DYLD_PATH}}"
      LD_LIBRARY_PATH: "{{.LD_PATH}}"
      PATH: "{{.WIN_PATH}}"
    cmds:
      - echo "ðŸ’¬ Creating chat room..."
      # Copy DLL for Windows runtime (only if not exists, to avoid locking issues)
      - test -f "{{.LIB_NAME}}.dll" || cp "{{.LIB_DIR}}/{{.LIB_NAME}}.dll" . 2>/dev/null || true
      - go build -o chat{{exeExt}} .
      - ./chat{{exeExt}} --room="{{.ROOM | default "general"}}" --user="{{.USER | default "moderator"}}" --create {{.CLI_ARGS}}
    silent: true

  example:chat:join:
    desc: Join an existing chat room
    deps: [ensure-lib]
    dir: examples/chat
    env:
      CGO_ENABLED: "1"
      CGO_LDFLAGS: "{{.CGO_LDFLAGS}}"
      DYLD_LIBRARY_PATH: "{{.DYLD_PATH}}"
      LD_LIBRARY_PATH: "{{.LD_PATH}}"
      PATH: "{{.WIN_PATH}}"
    cmds:
      - echo "ðŸ’¬ Joining chat room..."
      # Copy DLL for Windows runtime (only if not exists, to avoid locking issues)
      - test -f "{{.LIB_NAME}}.dll" || cp "{{.LIB_DIR}}/{{.LIB_NAME}}.dll" . 2>/dev/null || true
      - go build -o chat{{exeExt}} .
      - ./chat{{exeExt}} --room="{{.ROOM | default "general"}}" --user="{{.USER}}" {{.CLI_ARGS}}
    silent: true

  example:sessionmgr:
    desc: Run the SLIM session manager web UI
    deps: [ensure-lib]
    dir: examples/sessionmgr
    env:
      CGO_ENABLED: "1"
      CGO_LDFLAGS: "{{.CGO_LDFLAGS}}"
      DYLD_LIBRARY_PATH: "{{.DYLD_PATH}}"
      LD_LIBRARY_PATH: "{{.LD_PATH}}"
      PATH: "{{.WIN_PATH}}"
    cmds:
      - echo "ðŸ–¥ï¸  Starting SLIM Session Manager..."
      # Copy DLL for Windows runtime (only if not exists, to avoid locking issues)
      - test -f "{{.LIB_NAME}}.dll" || cp "{{.LIB_DIR}}/{{.LIB_NAME}}.dll" . 2>/dev/null || true
      - go build -o sessionmgr{{exeExt}} ./cmd
      - ./sessionmgr{{exeExt}} --port={{.PORT | default "8081"}} --local="{{.LOCAL | default "org/sessionmgr/app"}}" {{.CLI_ARGS}}
    silent: true

  example:sessionclient:
    desc: Run the SLIM session client web UI (joins sessions)
    deps: [ensure-lib]
    dir: examples/sessionclient
    env:
      CGO_ENABLED: "1"
      CGO_LDFLAGS: "{{.CGO_LDFLAGS}}"
      DYLD_LIBRARY_PATH: "{{.DYLD_PATH}}"
      LD_LIBRARY_PATH: "{{.LD_PATH}}"
      PATH: "{{.WIN_PATH}}"
    cmds:
      - echo "ðŸ‘¤ Starting SLIM Session Client..."
      # Copy DLL for Windows runtime (only if not exists, to avoid locking issues)
      - test -f "{{.LIB_NAME}}.dll" || cp "{{.LIB_DIR}}/{{.LIB_NAME}}.dll" . 2>/dev/null || true
      - go build -o sessionclient{{exeExt}} ./cmd
      - ./sessionclient{{exeExt}} --port={{.PORT | default "8082"}} --local="{{.LOCAL | default "org/client/app"}}" --timeout={{.TIMEOUT | default "60"}} {{.CLI_ARGS}}
    silent: true
