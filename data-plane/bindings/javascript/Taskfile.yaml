# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

version: '3'

includes:
  adapter:
    taskfile: "../adapter/Taskfile.yaml"
    internal: false
  rust:
    taskfile: ../../../tasks/rust.yaml
    internal: true

vars:
  # The Rust UniFFI bindings crate - in bindings/adapter (sibling to bindings/javascript)
  BINDINGS_DIR: "{{.TASKFILE_DIR}}/../adapter"
  PROFILE: '{{.PROFILE | default "release"}}'
  CURRENT_TARGET:
    sh: 'rustc -vV | sed -n "s|host: ||p"'
  TARGET: "{{.TARGET | default .CURRENT_TARGET}}"
  SERVICE_TARGET: "{{.TASKFILE_DIR}}/../../target/{{.TARGET}}/{{.PROFILE}}"
  LIB_NAME: slim_bindings
  _DEFAULT_LIB_PATH:
    sh: |
      # Detect OS to determine library extension
      OS=$(uname -s 2>/dev/null | tr '[:upper:]' '[:lower:]')
      case "$OS" in
        mingw*|msys*|cygwin*)
          # Windows uses .lib without lib prefix
          echo "{{.SERVICE_TARGET}}/{{.LIB_NAME}}.lib"
          ;;
        *)
          # Unix/Linux/macOS use .a with lib prefix
          echo "{{.SERVICE_TARGET}}/lib{{.LIB_NAME}}.a"
          ;;
      esac
  LIB_PATH: "{{.LIB_PATH | default ._DEFAULT_LIB_PATH}}"

tasks:
  default:
    cmds:
      - task -l

  install-uniffi-bindgen-react-native:
    desc: Install uniffi-bindgen-react-native tool
    status:
      - which ubrn
    cmds:
      - echo "ğŸ“¦ Installing uniffi-bindgen-react-native..."
      - npm install -g uniffi-bindgen-react-native
    silent: true

  install-wasm-tools:
    desc: Install wasm-bindgen-cli and wasm-pack
    status:
      - which wasm-bindgen
      - which wasm-pack
    cmds:
      - echo "ğŸ“¦ Installing WASM tools..."
      - cargo install wasm-bindgen-cli --version 0.2.92
      - cargo install wasm-pack
    silent: true

  generate:
    desc: Generate all JavaScript/TypeScript bindings (React Native + WASM)
    deps:
      - task: adapter:bindings:build:all
        vars:
          PROFILE: release
      - task: install-uniffi-bindgen-react-native
    cmds:
      - task: generate:react-native
      - task: generate:wasm
      - echo "âœ… All bindings generated successfully"
    silent: true

  generate:react-native:
    desc: Generate React Native JSI bindings from compiled library
    deps:
      - task: adapter:bindings:build:all
        vars:
          PROFILE: release
      - task: install-uniffi-bindgen-react-native
    cmds:
      - echo "ğŸ”§ Generating React Native JSI bindings..."
      - mkdir -p generated/typescript generated/cpp
      - |
        cd {{.BINDINGS_DIR}} && ubrn generate jsi bindings \
          --ts-dir ../javascript/generated/typescript \
          --cpp-dir ../javascript/generated/cpp \
          --library \
          '{{.LIB_PATH}}'
      - echo "âœ… React Native bindings generated in generated/"
    silent: true

  generate:wasm:
    desc: Generate WASM bindings from compiled library
    deps:
      - task: adapter:bindings:build:all
        vars:
          PROFILE: release
      - task: install-uniffi-bindgen-react-native
    cmds:
      - echo "ğŸ”§ Generating WASM crate structure..."
      - mkdir -p generated/wasm generated/typescript
      - |
        ubrn generate wasm wasm-crate \
          --out-dir generated/wasm \
          --library \
          '{{.LIB_PATH}}'
      - echo "ğŸ”§ Generating WASM TypeScript bindings..."
      - |
        ubrn generate wasm bindings \
          --ts-dir generated/typescript \
          --out-dir generated/wasm \
          --library \
          '{{.LIB_PATH}}'
      - echo "âœ… WASM bindings generated in generated/wasm/"
    silent: true

  build:wasm:
    desc: Build WASM module from generated bindings
    deps:
      - task: generate:wasm
      - task: install-wasm-tools
    cmds:
      - echo "ğŸ¦€ Building WASM module..."
      - echo "âš ï¸  Note - WASM build requires adapter crate to support wasm32-unknown-unknown target"
      - echo "âš ï¸  The adapter currently uses tokio which doesn't support WASM without feature flags"
      - echo "âš ï¸  Bindings are generated but WASM compilation is not yet supported"
      - echo "âŒ WASM build skipped - see README for details"
    silent: true

  build:wasm:nodejs:
    desc: Build WASM module for Node.js environment
    deps:
      - task: generate:wasm
      - task: install-wasm-tools
    cmds:
      - echo "ğŸ¦€ Building WASM module for Node.js..."
      - cd generated/wasm && wasm-pack build --target nodejs --release
      - echo "âœ… WASM module built for Node.js in generated/wasm/pkg/"
    silent: true

  install:
    desc: Install npm dependencies
    cmds:
      - echo "ğŸ“¦ Installing npm dependencies..."
      - npm install
    silent: true

  test:
    desc: Run all tests
    deps:
      - task: generate
      - task: build:wasm:nodejs
      - task: install
    cmds:
      - echo "ğŸ§ª Running all tests..."
      - npm test
      - echo "âœ… All tests passed"
    silent: true

  test:unit:
    desc: Run unit tests only
    deps:
      - task: build:wasm:nodejs
      - task: install
    cmds:
      - echo "ğŸ§ª Running unit tests..."
      - npm run test:unit
    silent: true

  test:integration:
    desc: Run integration tests only
    deps:
      - task: build:wasm:nodejs
      - task: install
    cmds:
      - echo "ğŸ§ª Running integration tests..."
      - npm run test:integration
    silent: true

  test:coverage:
    desc: Run tests with coverage report
    deps:
      - task: build:wasm:nodejs
      - task: install
    cmds:
      - echo "ğŸ“Š Running tests with coverage..."
      - npm run test:coverage
      - echo "âœ… Coverage report generated"
    silent: true

  clean:
    desc: Clean build artifacts
    cmds:
      - echo "ğŸ§¹ Cleaning build artifacts..."
      - rm -rf generated/
      - rm -rf node_modules/
      - rm -rf dist/
      - rm -rf coverage/
      - cd {{.BINDINGS_DIR}} && cargo clean
      - echo "âœ… Clean complete"
    silent: true

  # React Native Examples
  example:react-native:simple:
    desc: Run simple React Native example
    deps:
      - task: generate:react-native
    dir: examples/react-native/simple
    cmds:
      - echo "ğŸš€ Running React Native simple example..."
      - echo "Note - This requires a React Native environment setup"
      - npm install
      - npx react-native run-ios
    silent: true

  example:react-native:p2p:
    desc: Run React Native point-to-point example
    deps:
      - task: generate:react-native
    dir: examples/react-native/point-to-point
    cmds:
      - echo "ğŸš€ Running React Native point-to-point example..."
      - npm install
      - npx react-native run-ios
    silent: true

  example:react-native:group:
    desc: Run React Native group messaging example
    deps:
      - task: generate:react-native
    dir: examples/react-native/group
    cmds:
      - echo "ğŸš€ Running React Native group example..."
      - npm install
      - npx react-native run-ios
    silent: true

  # Web/WASM Examples
  example:web:simple:
    desc: Run simple web/WASM example
    deps:
      - task: build:wasm
    dir: examples/web/simple
    cmds:
      - echo "ğŸŒ Running web simple example..."
      - npm install
      - npm run dev
    silent: true

  example:web:p2p:
    desc: Run web point-to-point example
    deps:
      - task: build:wasm
    dir: examples/web/point-to-point
    cmds:
      - echo "ğŸŒ Running web point-to-point example..."
      - npm install
      - npm run dev
    silent: true

  example:web:group:
    desc: Run web group messaging example
    deps:
      - task: build:wasm
    dir: examples/web/group
    cmds:
      - echo "ğŸŒ Running web group example..."
      - npm install
      - npm run dev
    silent: true

  # Development helpers
  watch:
    desc: Watch for changes and rebuild
    cmds:
      - echo "ğŸ‘€ Watching for changes..."
      - |
        while true; do
          inotifywait -r -e modify,create,delete {{.BINDINGS_DIR}}/src || fswatch -o {{.BINDINGS_DIR}}/src || true
          task generate
        done

  format:
    desc: Format TypeScript code
    cmds:
      - npx prettier --write "**/*.{ts,tsx,js,jsx,json}"

  lint:
    desc: Lint TypeScript code
    cmds:
      - npx eslint "**/*.{ts,tsx,js,jsx}"
