# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

version: '3'

includes:
  adapter:
    taskfile: "../rust/Taskfile.yaml"
    internal: false
  rust:
    taskfile: ../../../tasks/rust.yaml
    internal: true

vars:
  # The Rust UniFFI bindings crate - in bindings/rust (sibling to bindings/javascript)
  BINDINGS_DIR: "{{.TASKFILE_DIR}}/../rust"
  PROFILE: '{{.PROFILE | default "release"}}'
  CURRENT_TARGET:
    sh: 'rustc -vV | sed -n "s|host: ||p"'
  TARGET: "{{.TARGET | default .CURRENT_TARGET}}"
  SERVICE_TARGET: "{{.TASKFILE_DIR}}/../../target/{{.TARGET}}/{{.PROFILE}}"
  LIB_NAME: slim_bindings
  _DEFAULT_LIB_PATH:
    sh: |
      # Detect OS to determine library extension
      OS=$(uname -s 2>/dev/null | tr '[:upper:]' '[:lower:]')
      case "$OS" in
        mingw*|msys*|cygwin*)
          # Windows uses .lib without lib prefix
          echo "{{.SERVICE_TARGET}}/{{.LIB_NAME}}.lib"
          ;;
        *)
          # Unix/Linux/macOS use .a with lib prefix
          echo "{{.SERVICE_TARGET}}/lib{{.LIB_NAME}}.a"
          ;;
      esac
  LIB_PATH: "{{.LIB_PATH | default ._DEFAULT_LIB_PATH}}"

tasks:
  default:
    cmds:
      - task -l

  install-uniffi-bindgen-react-native:
    desc: Install uniffi-bindgen-react-native tool
    status:
      - which ubrn
    cmds:
      - echo "ðŸ“¦ Installing uniffi-bindgen-react-native..."
      - npm install -g uniffi-bindgen-react-native
    silent: true

  install-wasm-tools:
    desc: Install wasm-bindgen-cli and wasm-pack
    status:
      - which wasm-bindgen
      - which wasm-pack
    cmds:
      - echo "ðŸ“¦ Installing WASM tools..."
      - cargo install wasm-bindgen-cli --version 0.2.92
      - cargo install wasm-pack
    silent: true

  generate:
    desc: Generate React Native JSI bindings
    deps:
      - task: adapter:bindings:build:all
        vars:
          PROFILE: release
      - task: install-uniffi-bindgen-react-native
    cmds:
      - task: generate:react-native
      # WASM generation disabled - tokio incompatibility with WASM targets
      # - task: generate:wasm
      - echo "âœ… React Native bindings generated successfully"
    silent: true

  build:ios-simulator:
    desc: Build Rust library for iOS simulator
    cmds:
      - task: adapter:bindings:build:all
        vars:
          TARGET: aarch64-apple-ios-sim
          PROFILE: debug

  generate:react-native:
    desc: Generate React Native JSI bindings from compiled library
    dir: "{{.TASKFILE_DIR}}"
    deps:
      - task: adapter:bindings:build:all
        vars:
          PROFILE: release
      - task: install-uniffi-bindgen-react-native
    cmds:
      - echo "ðŸ”§ Generating React Native JSI bindings..."
      - mkdir -p generated/typescript generated/cpp
      - |
        cd {{.BINDINGS_DIR}} && ubrn generate jsi bindings \
          --ts-dir ../javascript/generated/typescript \
          --cpp-dir ../javascript/generated/cpp \
          --library \
          '{{.LIB_PATH}}'
      - echo "ðŸ”§ Fixing generator bug (async public â†’ public async)... {{.TASKFILE_DIR}}"
      - sed -i '' 's/async public/public async/g' {{.TASKFILE_DIR}}/generated/typescript/slim_bindings.ts
      - sed -i '' 's/async static/static async/g' {{.TASKFILE_DIR}}/generated/typescript/slim_bindings.ts
      - echo "âœ… React Native bindings generated in generated/"
    silent: true

  # WASM generation disabled due to tokio incompatibility with WASM targets
  # generate:wasm:
  #   desc: Generate WASM bindings from compiled library (note - compilation not supported yet)
  #   deps:
  #     - task: adapter:bindings:build:all
  #       vars:
  #         PROFILE: release
  #     - task: install-uniffi-bindgen-react-native
  #   cmds:
  #     - echo "ðŸ”§ Generating WASM bindings..."
  #     - echo "âš ï¸  Note - WASM generation is placeholder (tokio incompatibility)"
  #     - mkdir -p generated/wasm generated/typescript
  #     - |
  #       cd {{.BINDINGS_DIR}} && ubrn generate wasm bindings \
  #         --ts-dir ../javascript/generated/typescript \
  #         --cpp-dir ../javascript/generated/wasm \
  #         --library \
  #         '{{.LIB_PATH}}'
  #     - echo "ðŸ”§ Fixing generator bug (async public â†’ public async)... {{.TASKFILE_DIR}}"
  #     - sed -i '' 's/async public/public async/g' {{.TASKFILE_DIR}}/generated/typescript/slim_bindings.ts
  #     - sed -i '' 's/async static/static async/g' {{.TASKFILE_DIR}}/generated/typescript/slim_bindings.ts
  #     - echo "âœ… WASM TypeScript bindings generated (module compilation skipped)"
  #   silent: true

  # WASM build disabled - see generate:wasm above
  # build:wasm:
  #   desc: Build WASM module from generated bindings
  #   deps:
  #     - task: generate:wasm
  #     - task: install-wasm-tools
  #   cmds:
  #     - echo "ðŸ¦€ Building WASM module..."
  #     - echo "âš ï¸  Note - WASM build requires adapter crate to support wasm32-unknown-unknown target"
  #     - echo "âš ï¸  The adapter currently uses tokio which doesn't support WASM without feature flags"
  #     - echo "âš ï¸  Bindings are generated but WASM compilation is not yet supported"
  #     - echo "âŒ WASM build skipped - see README for details"
  #   silent: true

  # build:wasm:nodejs:
  #   desc: Build WASM module for Node.js environment
  #   deps:
  #     - task: generate:wasm
  #     - task: install-wasm-tools
  #   cmds:
  #     - echo "ðŸ¦€ Building WASM module for Node.js..."
  #     - cd generated/wasm && wasm-pack build --target nodejs --release
  #     - echo "âœ… WASM module built for Node.js in generated/wasm/pkg/"
  #   silent: true

  install:
    desc: Install npm dependencies
    cmds:
      - echo "ðŸ“¦ Installing npm dependencies..."
      - npm install
    silent: true

  test:
    desc: Run all tests (unit + E2E)
    deps:
      - install
    cmds:
      - echo "ðŸ§ª Running all tests..."
      - npm test  # Unit tests
      - task: test:e2e

  check-prerequisites:ios:
    desc: Check if iOS E2E prerequisites are installed
    cmds:
      - |
        echo "ðŸ” Checking iOS E2E prerequisites..."
        
        # Check for Xcode (not just Command Line Tools)
        if ! xcodebuild -version > /dev/null 2>&1; then
          echo "âŒ ERROR: Xcode is not installed or not properly configured"
          echo "iOS E2E tests require the FULL Xcode application (not Command Line Tools)."
          echo "Install: https://apps.apple.com/app/xcode/id497799835"
          echo "Then run: sudo xcodebuild -license accept"
          exit 1
        fi
        
        # Check for iOS SDK
        if ! xcrun --show-sdk-path --sdk iphoneos > /dev/null 2>&1; then
          echo "âŒ ERROR: iOS SDK not found"
          echo "Run: sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer"
          exit 1
        fi
        
        # Check for CocoaPods
        if ! command -v pod > /dev/null 2>&1; then
          echo "âŒ ERROR: CocoaPods is not installed"
          echo "Install: sudo gem install cocoapods"
          exit 1
        fi
        
        # Check for Maestro
        if ! command -v maestro > /dev/null 2>&1; then
          echo "âŒ ERROR: Maestro is not installed"
          echo 'Install: curl -Ls "https://get.maestro.mobile.dev" | bash'
          exit 1
        fi
        
        echo "âœ… All iOS E2E prerequisites are installed"
    silent: true

  check-prerequisites:android:
    desc: Check if Android E2E prerequisites are installed
    cmds:
      - |
        echo "ðŸ” Checking Android E2E prerequisites..."
        
        # Check for Android SDK
        if ! command -v adb > /dev/null 2>&1; then
          echo "âŒ ERROR: Android SDK is not installed"
          echo ""
          echo "Android E2E tests require Android SDK and tools."
          echo ""
          echo "To install:"
          echo "  1. Install Android Studio: https://developer.android.com/studio"
          echo "  2. Open Android Studio and install SDK tools via SDK Manager"
          echo "  3. Add to PATH: export PATH=\$PATH:\$ANDROID_HOME/platform-tools"
          echo ""
          exit 1
        fi
        
        # Check for Maestro
        if ! command -v maestro > /dev/null 2>&1; then
          echo "âŒ ERROR: Maestro is not installed"
          echo ""
          echo "Maestro is required to run E2E tests."
          echo ""
          echo "To install:"
          echo '  curl -Ls "https://get.maestro.mobile.dev" | bash'
          echo ""
          exit 1
        fi
        
        echo "âœ… All Android E2E prerequisites are installed"
    silent: true

  test:e2e:setup:
    desc: Set up React Native test app
    dir: examples/react-native/test-app
    cmds:
      - echo "ðŸ“± Setting up React Native test app..."
      - npm install
      - |
        if [ -d "ios" ]; then
          cd ios && pod install && cd ..
        fi
      - echo "âœ… Test app ready"
    silent: true

  test:e2e:ios:
    desc: Run E2E tests on iOS simulator
    deps:
      - check-prerequisites:ios
      - build:ios-simulator
      - generate:react-native
      - test:e2e:setup
    dir: examples/react-native/test-app
    cmds:
      - echo "ðŸŽ Running iOS E2E tests..."
      - echo "Starting Metro bundler..."
      - npx react-native start --reset-cache > /tmp/metro.log 2>&1 &
      - sleep 5
      - echo "Building and launching app on iOS simulator (Debug mode for faster builds)..."
      - echo "This may take 2-3 minutes on first run..."
      - npx react-native run-ios --mode Debug > /tmp/rn-ios.log 2>&1 &
      - echo "Waiting for app to launch (120s)..."
      - sleep 120
      - echo "Running Maestro tests..."
      - maestro test maestro/smoke-tests.yaml || (echo "Tests failed"; exit 1)
      - echo "Cleaning up..."
      - killall node || true
      - killall Simulator || true
      - echo "âœ… iOS E2E tests passed"

  test:e2e:android:
    desc: Run E2E tests on Android emulator
    deps:
      - check-prerequisites:android
      - generate:react-native
      - test:e2e:setup
    dir: examples/react-native/test-app
    cmds:
      - echo "ðŸ¤– Running Android E2E tests..."
      - echo "Starting Android app..."
      - npx react-native run-android --mode release > /tmp/rn-android.log 2>&1 &
      - echo "Waiting for app to launch (30s)..."
      - sleep 30
      - echo "Running Maestro tests..."
      - maestro test maestro/smoke-tests.yaml || (echo "Tests failed"; exit 1)
      - echo "Cleaning up..."
      - adb emu kill || true
      - echo "âœ… Android E2E tests passed"

  test:e2e:
    desc: Run E2E tests on current platform
    cmds:
      - |
        if [ "$(uname)" = "Darwin" ]; then
          echo "Detected macOS - running iOS tests"
          task test:e2e:ios
        else
          echo "Detected Linux - running Android tests"
          task test:e2e:android
        fi

  test:unit:
    desc: Run unit tests only
    deps:
      - install
    cmds:
      - echo "ðŸ§ª Running unit tests..."
      - npm run test:unit
    silent: true

  test:integration:
    desc: Run integration tests (requires native bindings)
    deps:
      - install
    cmds:
      - echo "ðŸ§ª Running integration tests..."
      - npm run test:integration
    silent: true

  test:watch:
    desc: Run tests in watch mode
    deps:
      - install
    cmds:
      - echo "ðŸ‘€ Running tests in watch mode..."
      - npm run test:watch

  test:coverage:
    desc: Run tests with coverage report
    deps:
      - install
    cmds:
      - echo "ðŸ“Š Running tests with coverage..."
      - npm run test:coverage
    silent: true

  clean:
    desc: Clean build artifacts
    cmds:
      - echo "ðŸ§¹ Cleaning build artifacts..."
      - rm -rf generated/
      - rm -rf node_modules/
      - rm -rf dist/
      - rm -rf coverage/
      - cd {{.BINDINGS_DIR}} && cargo clean
      - echo "âœ… Clean complete"
    silent: true

  # Development helpers
  watch:
    desc: Watch for changes and rebuild
    cmds:
      - echo "ðŸ‘€ Watching for changes..."
      - |
        while true; do
          inotifywait -r -e modify,create,delete {{.BINDINGS_DIR}}/src || fswatch -o {{.BINDINGS_DIR}}/src || true
          task generate
        done

  format:
    desc: Format TypeScript code
    cmds:
      - npx prettier --write "**/*.{ts,tsx,js,jsx,json}"

  lint:
    desc: Lint TypeScript code
    cmds:
      - npx eslint "**/*.{ts,tsx,js,jsx}"
