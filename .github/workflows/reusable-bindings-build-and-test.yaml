# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

---
name: go-bindings-build-and-test
on:
  workflow_call:
    inputs:
      runner:
        description: Github hosted runner or Self hosted runner
        required: false
        type: string
        default: ubuntu-latest
      tag-name:
        description: Git tag name for version extraction (e.g., slim-bindings-1.2.3)
        required: false
        type: string
        default: ""
      rust-workspace:
        description: Rust workspace directory for caching
        required: false
        type: string
        default: ./data-plane
      library-output-dir:
        description: Directory where the compiled library will be located
        required: false
        type: string
        default: ./data-plane/target/release
      library-name:
        description: Name of the compiled library (without lib prefix and extension)
        required: false
        type: string
        default: slim_bindings
      uniffi-bindgen-go-version:
        description: Version tag for uniffi-bindgen-go
        required: false
        type: string
        default: v0.4.0+v0.28.3
env:
  LIBRARY_NAME: slim_bindings
  PYTHON_VERSION: '3.11'

jobs:
  generate-matrix:
    name: Generate Platform Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      matrix-no-windows-gnu: ${{ steps.set-matrix.outputs.matrix-no-windows-gnu }}
    steps:
      - name: Generate matrix
        id: set-matrix
        run: |
          # Define the complete platform matrix
          MATRIX='{
            "platform": [
              {
                "runner": "ubuntu-24.04",
                "os": "linux",
                "target": "x86_64-unknown-linux-musl",
                "python-platform": "musllinux_1_2_x86_64",
                "exclude": false
              },
              {
                "runner": "ubuntu-24.04",
                "os": "linux",
                "target": "x86_64-unknown-linux-gnu",
                "python-platform": "manylinux_2_28_x86_64",
                "exclude": false
              },
              {
                "runner": "windows-11-arm",
                "os": "windows",
                "target": "aarch64-pc-windows-msvc",
                "python-platform": "win_arm64",
                "exclude": false
              },
              {
                "runner": "ubuntu-24.04",
                "os": "linux",
                "target": "aarch64-unknown-linux-musl",
                "python-platform": "musllinux_1_2_aarch64",
                "use_qemu": true,
                "exclude": false
              },
              {
                "runner": "ubuntu-24.04",
                "os": "linux",
                "target": "aarch64-unknown-linux-gnu",
                "python-platform": "manylinux_2_28_aarch64",
                "use_qemu": true,
                "exclude": false
              },
              {
                "runner": "windows-latest",
                "os": "windows",
                "target": "x86_64-pc-windows-msvc",
                "python-platform": "win_amd64",
                "exclude": false
              },
              {
                "runner": "ubuntu-24.04",
                "os": "linux",
                "target": "x86_64-pc-windows-gnu",
                "exclude": false
              },
              {
                "runner": "macos-15-intel",
                "os": "macos",
                "target": "x86_64-apple-darwin",
                "python-platform": "macosx_10_12_x86_64",
                "exclude": false
              },
              {
                "runner": "macos-15",
                "os": "macos",
                "target": "aarch64-apple-darwin",
                "python-platform": "macosx_11_0_arm64",
                "exclude": false
              }
            ],
            "exclude": [
              {
                "platform": {
                  "exclude": true
                }
              }
            ]
          }'

          # Output full matrix for build job
          echo "matrix=$(echo $MATRIX | jq -c .)" >> $GITHUB_OUTPUT

          # Create filtered matrix (exclude windows-gnu for Python tests)
          MATRIX_NO_WIN_GNU=$(echo $MATRIX | jq -c '{platform: [.platform[] | select(.target != "x86_64-pc-windows-gnu")], exclude: .exclude}')
          echo "matrix-no-windows-gnu=$(echo $MATRIX_NO_WIN_GNU | jq -c .)" >> $GITHUB_OUTPUT

  build-libraries:
    needs: generate-matrix
    name: "${{ matrix.platform.target }}"
    runs-on: ${{ matrix.platform.runner }}
    defaults:
      run:
        shell: bash
        working-directory: ./data-plane/bindings/rust
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: ./data-plane
      - name: Build library
        working-directory: ./data-plane/bindings/rust
        run: |
          task bindings:build:all TARGET=${{ matrix.platform.target }} PROFILE=release
      - name: Strip and rename artifacts
        run: |
          ls -lah ../../target/${{ matrix.platform.target }}/release/

          # Split target and use in filename
          TARGET="${{ matrix.platform.target }}"
          ARCH=$(echo "$TARGET" | cut -d'-' -f1)
          OS=$(echo "$TARGET" | cut -d'-' -f3)
          ABI=$(echo "$TARGET" | cut -d'-' -f4)

          echo "Architecture: $ARCH"
          echo "OS: $OS"
          echo "ABI: $ABI"

          # Build the library name with arch_os_abi if ABI is present, otherwise arch_os
          if [ -n "$ABI" ] && [ "$ABI" != "" ]; then
            LIB_NAME="slim_bindings_${ARCH}_${OS}_${ABI}"
          else
            LIB_NAME="slim_bindings_${ARCH}_${OS}"
          fi

          # Handle both libslim_bindings* (Unix) and slim_bindings* (Windows)
          for file in ../../target/${{ matrix.platform.target }}/release/libslim_bindings* ../../target/${{ matrix.platform.target }}/release/slim_bindings.*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")

              # Replace slim_bindings with arch_os_abi version, keeping any existing prefix
              new_filename="${filename/slim_bindings/${LIB_NAME}}"

              if [ "$filename" != "$new_filename" ]; then
                mv "$file" "../../target/${{ matrix.platform.target }}/release/${new_filename}"
              fi
            fi
          done

          echo "üìÅ Renamed files:"
          ls -lah ../../target/${{ matrix.platform.target }}/release/*slim_bindings*
      - name: Upload libs
        uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ matrix.platform.target }}
          path: ./data-plane/target/${{ matrix.platform.target }}/release/*slim_bindings*
      - name: Install uv
        if: "!contains(matrix.platform.target, 'windows-gnu')"
        uses: ./.github/actions/setup-python
        with:
          uv-install: 'true'
      - name: Generate python wheels
        if: "!contains(matrix.platform.target, 'windows-gnu')"
        working-directory: ./data-plane/bindings/python
        run: task python:bindings:packaging TARGET=${{ matrix.platform.target }} PROFILE=release
      - name: Upload wheels
        if: "!contains(matrix.platform.target, 'windows-gnu')"
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.platform.target }}
          path: ./data-plane/bindings/python/dist

  go-bindings-build-and-test:
    runs-on: ${{ inputs.runner }}
    needs:
      - generate-matrix
      - build-libraries

    defaults:
      run:
        shell: bash
        working-directory: ./data-plane/bindings/go

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: ${{ inputs.rust-workspace }}

      - name: Setup Go
        uses: ./.github/actions/setup-go

      # Download all library artifacts
      - name: Download libraries
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          pattern: bindings-*
          path: ./data-plane/bindings/go/artifacts/

      - name: List downloaded artifacts
        run: |
          echo "üì¶ Downloaded artifacts:"
          find ./artifacts -type f -ls

      - name: Generate Go bindings
        run: |
          task generate LIB_PATH=./artifacts/lib${{ env.LIBRARY_NAME }}_x86_64_linux_gnu.a

          echo "üìÅ Generated files:"
          find ./generated -type f

      - name: Make sure generation did not modify source files
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "‚ùå Generated Go bindings differ from committed files. Please commit the updated bindings."
            git status
            git --no-pager diff
            exit 1
          else
            echo "‚úÖ Generated Go bindings are up-to-date with committed files."
          fi

      - name: Run Go bindings tests
        run: |
          echo "Running Go bindings tests..."
          task test

      - name: Upload Generated Go code
        uses: actions/upload-artifact@v4
        with:
          name: go-bindings-generated-code
          path: |
            ./data-plane/bindings/go/generated/**/*.go
            ./data-plane/bindings/go/generated/**/*.h
          if-no-files-found: error

  python-bindings-test:
    name: Test Python Wheels (${{ matrix.platform.target }})
    runs-on: ${{ matrix.platform.runner }}
    needs:
      - generate-matrix
      - build-libraries
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix-no-windows-gnu) }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup QEMU for ARM64 emulation
        if: matrix.platform.use_qemu == true
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Setup Python (Windows/macOS only)
        if: matrix.platform.os != 'linux'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Download Python wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-${{ matrix.platform.target }}
          path: ./wheels/
          merge-multiple: true

      - name: List downloaded wheels
        run: |
          echo "üì¶ Downloaded wheels:"
          find ./wheels -type f -name "*.whl" -ls || echo "No wheels found"

      - name: Test wheel installation and usage (Linux with container)
        if: matrix.platform.os == 'linux'
        run: |
          echo "üì¶ Testing Python wheel"
          echo "üñ•Ô∏è  Platform: ${{ matrix.platform.target }}"

          # Determine platform for container selection
          if [[ "${{ matrix.platform.target }}" == *"aarch64"* ]]; then
            PLATFORM="linux/arm64"
            echo "üîß Using ARM64 platform"
          else
            PLATFORM="linux/amd64"
            echo "üîß Using AMD64 platform"
          fi

          # Determine libc variant for container selection
          if [[ "${{ matrix.platform.target }}" == *"musl"* ]]; then
            CONTAINER_IMAGE="python:${{ env.PYTHON_VERSION }}-alpine"
          else
            CONTAINER_IMAGE="python:${{ env.PYTHON_VERSION }}-slim"
          fi

          # Define Docker flags
          DOCKER_FLAGS=(
            --rm
            --platform "$PLATFORM"
            -v "$(pwd)/wheels:/wheels"
            -v "$(pwd):/repo:ro"
            -w /workspace
          )

          # Define test script
          TEST_SCRIPT='
            # Create test directory
            TEST_DIR=$(mktemp -d)
            cd $TEST_DIR
            echo "üìÇ Testing in: $TEST_DIR"

            # Find and install the wheel
            WHEEL=$(find /wheels -name "*${{ matrix.platform.python-platform }}*.whl" | head -1)
            if [ -z "$WHEEL" ]; then
              echo "‚ùå No wheel found for platform ${{ matrix.platform.python-platform }}"
              exit 1
            fi

            echo "üì¶ Installing wheel: $WHEEL"
            pip install "$WHEEL"
            echo "‚úÖ Wheel installed successfully"

            # Run installation test
            python /repo/.github/tests/python/test_installation.py

            echo ""
            echo "üéâ All tests passed on ${{ matrix.platform.target }}!"
          '

          # Run test in container
          docker run "${DOCKER_FLAGS[@]}" "$CONTAINER_IMAGE" sh -c "$TEST_SCRIPT"

      - name: Test wheel installation and usage (Windows/macOS)
        if: matrix.platform.os != 'linux'
        run: |
          echo "üì¶ Testing Python wheel"
          echo "üñ•Ô∏è  Platform: ${{ matrix.platform.target }}"
          echo "üèÉ Runner: ${{ matrix.platform.runner }}"
          echo "üìÇ Testing in current directory"

          # Find and install the wheel for this platform
          WHEEL=$(find ./wheels -name "*${{ matrix.platform.python-platform }}*.whl" | head -1)
          if [ -z "$WHEEL" ]; then
            echo "‚ùå No wheel found for platform ${{ matrix.platform.python-platform }}"
            echo "Available wheels:"
            find ./wheels -name "*.whl"
            exit 1
          fi

          echo "üì¶ Installing wheel: $WHEEL"
          pip install "$WHEEL"
          echo "‚úÖ Wheel installed successfully"

          # Run installation test
          python ./.github/tests/python/test_installation.py

          echo ""
          echo "üéâ All tests passed on ${{ matrix.platform.target }}!"

      - name: Test result summary
        if: success()
        run: |
          echo "‚úÖ Python wheel verification completed successfully on ${{ matrix.platform.target }}"
          echo "The wheel can be safely published."

  dotnet-bindings-build-and-test:
    name: Build .NET Bindings
    runs-on: ${{ inputs.runner }}
    needs:
      - generate-matrix
      - build-libraries

    defaults:
      run:
        shell: bash
        working-directory: ./data-plane/bindings/dotnet

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: ${{ inputs.rust-workspace }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Task
        uses: ./.github/actions/setup-task
        with:
          version: latest
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # Download all library artifacts from the build-libraries job
      - name: Download library artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: bindings-*
          path: ./data-plane/bindings/dotnet/artifacts/

      - name: List downloaded artifacts
        run: |
          echo "üì¶ Downloaded artifacts:"
          find ./artifacts -type f -name "*.so" -o -name "*.dll" -o -name "*.dylib" -o -name "*.a" | sort

      # Run complete CI pipeline using task command
      # This generates bindings, copies runtimes, builds, tests, and packs
      - name: Run CI pipeline
        run: |
          TAG_NAME_PARAM=""
          if [[ -n "${{ inputs.tag-name }}" ]]; then
            TAG_NAME_PARAM="TAG_NAME=${{ inputs.tag-name }}"
          fi
          
          task ci \
            ARTIFACTS_DIR=./artifacts \
            OUTPUT_DIR=./nupkg \
            BINDGEN_TARGET=x86_64-unknown-linux-gnu \
            $TAG_NAME_PARAM

      - name: Upload NuGet package
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-bindings-nuget
          path: ./data-plane/bindings/dotnet/nupkg/*.nupkg
          if-no-files-found: error
