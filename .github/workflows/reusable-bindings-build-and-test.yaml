# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

---
name: go-bindings-build-and-test
on:
  workflow_call:
    inputs:
      runner:
        description: Github hosted runner or Self hosted runner
        required: false
        type: string
        default: ubuntu-latest
      rust-workspace:
        description: Rust workspace directory for caching
        required: false
        type: string
        default: ./data-plane
      library-output-dir:
        description: Directory where the compiled library will be located
        required: false
        type: string
        default: ./data-plane/target/release
      library-name:
        description: Name of the compiled library (without lib prefix and extension)
        required: false
        type: string
        default: slim_bindings
      uniffi-bindgen-go-version:
        description: Version tag for uniffi-bindgen-go
        required: false
        type: string
        default: v0.4.0+v0.28.3
env:
  LIBRARY_NAME: slim_bindings

jobs:
  build-libraries:
    name: "${{ matrix.platform.target }}"
    runs-on: ${{ matrix.platform.runner }}
    defaults:
      run:
        shell: bash
        working-directory: ./data-plane/bindings/rust
    strategy:
      fail-fast: false
      matrix:
        platform:
          - runner: ubuntu-24.04
            os: linux
            target: x86_64-unknown-linux-musl
            exclude: false
          - runner: ubuntu-24.04
            os: linux
            target: x86_64-unknown-linux-gnu
            exclude: ${{ github.event_name == 'pull_request' }}
          - runner: ubuntu-24.04
            os: linux
            target: aarch64-unknown-linux-musl
            exclude: ${{ github.event_name == 'pull_request' }}
          - runner: ubuntu-24.04
            os: linux
            target: aarch64-unknown-linux-gnu
            exclude: ${{ github.event_name == 'pull_request' }}
          - runner: windows-latest
            os: windows
            target: x86_64-pc-windows-msvc
            exclude: ${{ github.event_name == 'pull_request' }}
          - runner: ubuntu-24.04
            os: linux
            target: x86_64-pc-windows-gnu
            exclude: ${{ github.event_name == 'pull_request' }}
          # https://github.com/astral-sh/uv/issues/12906
          # - runner: windows-11-arm
          #   os: windows
          #   target: aarch64
          - runner: macos-15-intel
            os: macos
            target: x86_64-apple-darwin
            exclude: ${{ github.event_name == 'pull_request' }}
          - runner: macos-15
            os: macos
            target: aarch64-apple-darwin
            exclude: ${{ github.event_name == 'pull_request' }}
        exclude:
          - platform:
              exclude: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: ./data-plane
      - name: Build library
        run: |
          task bindings:build:all TARGET=${{ matrix.platform.target }} PROFILE=release
      - name: Strip and rename artifacts
        run: |
          ls -lah ../../target/${{ matrix.platform.target }}/release/

          # Split target and use in filename
          TARGET="${{ matrix.platform.target }}"
          ARCH=$(echo "$TARGET" | cut -d'-' -f1)
          OS=$(echo "$TARGET" | cut -d'-' -f3)
          ABI=$(echo "$TARGET" | cut -d'-' -f4)

          echo "Architecture: $ARCH"
          echo "OS: $OS"
          echo "ABI: $ABI"

          # Build the library name with arch_os_abi if ABI is present, otherwise arch_os
          if [ -n "$ABI" ] && [ "$ABI" != "" ]; then
            LIB_NAME="slim_bindings_${ARCH}_${OS}_${ABI}"
          else
            LIB_NAME="slim_bindings_${ARCH}_${OS}"
          fi

          # Handle both libslim_bindings* (Unix) and slim_bindings* (Windows)
          for file in ../../target/${{ matrix.platform.target }}/release/libslim_bindings* ../../target/${{ matrix.platform.target }}/release/slim_bindings.*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")

              # Replace slim_bindings with arch_os_abi version, keeping any existing prefix
              new_filename="${filename/slim_bindings/${LIB_NAME}}"

              if [ "$filename" != "$new_filename" ]; then
                mv "$file" "../../target/${{ matrix.platform.target }}/release/${new_filename}"
              fi
            fi
          done

          echo "üìÅ Renamed files:"
          ls -lah ../../target/${{ matrix.platform.target }}/release/*slim_bindings*
      - name: Upload libs
        uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ matrix.platform.target }}
          path: ./data-plane/target/${{ matrix.platform.target }}/release/*slim_bindings*

  go-bindings-build-and-test:
    runs-on: ${{ inputs.runner }}
    needs: build-libraries

    defaults:
      run:
        shell: bash
        working-directory: ./data-plane/bindings/go

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: ${{ inputs.rust-workspace }}

      - name: Setup Go
        uses: ./.github/actions/setup-go

      # Download all library artifacts
      - name: Download libraries
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          pattern: bindings-*
          path: ./data-plane/bindings/go/artifacts/

      - name: List downloaded artifacts
        run: |
          echo "üì¶ Downloaded artifacts:"
          find ./artifacts -type f -ls

      - name: Generate Go bindings
        run: |
          task generate LIB_PATH=./artifacts/lib${{ env.LIBRARY_NAME }}_x86_64_linux_musl.a

          echo "üìÅ Generated files:"
          find ./generated -type f

      - name: Make sure generation did not modify source files
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "‚ùå Generated Go bindings differ from committed files. Please commit the updated bindings."
            git status
            git --no-pager diff
            exit 1
          else
            echo "‚úÖ Generated Go bindings are up-to-date with committed files."
          fi

      - name: Run Go bindings tests
        run: |
          echo "Running Go bindings tests..."
          task test

      - name: Upload Generated Go code
        uses: actions/upload-artifact@v4
        with:
          name: go-bindings-generated-code
          path: |
            ./data-plane/bindings/go/generated/**/*.go
            ./data-plane/bindings/go/generated/**/*.h
          if-no-files-found: error

  dotnet-bindings-build-and-test:
    runs-on: ${{ inputs.runner }}
    needs: build-libraries

    defaults:
      run:
        shell: bash
        working-directory: ./data-plane/bindings/dotnet

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: ${{ inputs.rust-workspace }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Task
        uses: arduino/setup-task@b91d5d2c96a56797b48ac1e0e89220bf64044611 # v2.0.0
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      # Download all library artifacts
      - name: Download library artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          pattern: bindings-*
          path: ./data-plane/bindings/dotnet/artifacts/

      - name: List downloaded artifacts
        run: |
          echo "üì¶ Downloaded artifacts:"
          find ./artifacts -type f -ls

      - name: Generate bindings and build
        run: task ci ARTIFACTS_DIR=./artifacts

      - name: Run smoke tests
        run: task test:smoke

      - name: Upload NuGet package
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: ./data-plane/bindings/dotnet/packages/*.nupkg
