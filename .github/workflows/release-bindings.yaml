# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

---
name: Release Bindings

on:
  pull_request:
    paths:
      - 'data-plane/**'
      - '.github/workflows/release-bindings.yaml'

  push:
    tags:
      - 'slim-test-bindings-*'

  workflow_dispatch:
    inputs:
      version:
        # TODO: make this required
        description: 'Release version (e.g., v0.7.0)'
        required: false
        type: string
        default: 'v0.0.0-dev'

env:
  LIBRARY_NAME: slim_bindings
  GO_BINDINGS_REPO: agntcy/slim-bindings-go
  UNIFFI_BINDGEN_GO_VERSION: v0.4.0+v0.28.3
  # Computed values with defaults for pull_request events
  RELEASE_VERSION: ${{ inputs.version || 'v0.0.0-pr' }}

jobs:
  # ==========================================================================
  # Job 1: Build native libraries for all platforms
  # ==========================================================================
  build-libraries:
    name: "${{ matrix.platform.target }}"
    runs-on: ${{ matrix.platform.runner }}
    defaults:
      run:
        shell: bash
        working-directory: ./data-plane/bindings/adapter
    strategy:
      fail-fast: false
      matrix:
        platform:
          - runner: ubuntu-24.04
            os: linux
            target: x86_64-unknown-linux-musl
          - runner: ubuntu-24.04
            os: linux
            target: x86_64-unknown-linux-gnu
          - runner: ubuntu-24.04
            os: linux
            target: aarch64-unknown-linux-musl
          - runner: ubuntu-24.04
            os: linux
            target: aarch64-unknown-linux-gnu
          - runner: windows-latest
            os: windows
            target: x86_64-pc-windows-msvc
          - runner: ubuntu-24.04
            os: linux
            target: x86_64-pc-windows-gnu
          # https://github.com/astral-sh/uv/issues/12906
          # - runner: windows-11-arm
          #   os: windows
          #   target: aarch64
          - runner: macos-15-intel
            os: macos
            target: x86_64-apple-darwin
          - runner: macos-15
            os: macos
            target: aarch64-apple-darwin
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: ./data-plane
      - name: Build library
        run: |
          task bindings:build:all TARGET=${{ matrix.platform.target }} PROFILE=release
      - name: Strip and rename artifacts
        run: |
          ls -lah ../../target/${{ matrix.platform.target }}/release/

          # Split target and use in filename
          TARGET="${{ matrix.platform.target }}"
          ARCH=$(echo "$TARGET" | cut -d'-' -f1)
          OS=$(echo "$TARGET" | cut -d'-' -f3)
          ABI=$(echo "$TARGET" | cut -d'-' -f4)

          echo "Architecture: $ARCH"
          echo "OS: $OS"
          echo "ABI: $ABI"

          # Build the library name with arch_os_abi if ABI is present, otherwise arch_os
          if [ -n "$ABI" ] && [ "$ABI" != "" ]; then
            LIB_NAME="slim_bindings_${ARCH}_${OS}_${ABI}"
          else
            LIB_NAME="slim_bindings_${ARCH}_${OS}"
          fi

          # Handle both libslim_bindings* (Unix) and slim_bindings* (Windows)
          for file in ../../target/${{ matrix.platform.target }}/release/libslim_bindings* ../../target/${{ matrix.platform.target }}/release/slim_bindings.*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              extension="${filename##*.}"

              if [[ "$filename" == libslim_bindings.* ]]; then
                # Unix-like: keep 'lib' prefix
                mv "$file" "../../target/${{ matrix.platform.target }}/release/lib${LIB_NAME}.${extension}"
              else
                # Windows: no 'lib' prefix
                mv "$file" "../../target/${{ matrix.platform.target }}/release/${LIB_NAME}.${extension}"
              fi
            fi
          done

          echo "üìÅ Renamed files:"
          ls -lah ../../target/${{ matrix.platform.target }}/release/*slim_bindings*
      - name: Upload libs
        uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ matrix.platform.target }}
          path: ./data-plane/target/${{ matrix.platform.target }}/release/*slim_bindings*



  # ==========================================================================
  # Job 2: Create GitHub release with library artifacts (for test tags)
  # ==========================================================================
  release-libraries:
    name: Release Libraries
    runs-on: ubuntu-latest
    needs: build-libraries
    if: startsWith(github.ref, 'refs/tags/slim-test-bindings-')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Download all library artifacts from build-libraries job
      - name: Download all library artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts/
          pattern: bindings-*

      - name: List downloaded artifacts
        run: |
          echo "üì¶ Downloaded artifacts:"
          find ./artifacts -type f -ls

      - name: Prepare release artifacts
        run: |
          mkdir -p ./release-artifacts

          # The download-artifact action already organizes files by artifact name
          # Each platform's libraries are in ./artifacts/bindings-<target>/
          # We'll zip each platform's libraries separately

          for platform_dir in ./artifacts/bindings-*/; do
            if [ -d "$platform_dir" ]; then
              platform_name=$(basename "$platform_dir" | sed 's/^bindings-//')
              echo "üì¶ Zipping libraries for platform: $platform_name"

              cd "$platform_dir"
              zip -r "../../release-artifacts/slim-bindings-${platform_name}.zip" *
              cd - > /dev/null

              echo "‚úÖ Created slim-bindings-${platform_name}.zip"
            fi
          done

          echo "üìã Release artifacts:"
          ls -lah ./release-artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Test Bindings ${{ github.ref_name }}"
          body: |
            Test release of SLIM native bindings libraries.

            **Platforms included:**
            - Linux x86_64 (GNU and musl)
            - Linux aarch64 (GNU and musl)
            - macOS x86_64 (Intel)
            - macOS aarch64 (Apple Silicon)
            - Windows x86_64

            Built from commit: ${{ github.sha }}
          files: ./release-artifacts/*.zip
          draft: false
          prerelease: true

  # ==========================================================================
  # Job 3: Generate and publish Go bindings
  # ==========================================================================
  release-go-bindings:
    name: Release Go Bindings
    runs-on: ubuntu-latest
    needs: build-libraries
    defaults:
      run:
        shell: bash
        working-directory: ./data-plane/bindings/go
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: ./data-plane

      # Download all library artifacts
      - name: Download libraries
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          path: ./data-plane/bindings/go/artifacts/

      - name: List downloaded artifacts
        run: |
          echo "üì¶ Downloaded artifacts:"
          find ./artifacts -type f -ls

      - name: Generate Go bindings
        run: |
          task generate LIB_PATH=./artifacts/lib${{ env.LIBRARY_NAME }}_x86_64_linux_musl.a

          echo "üìÅ Generated files:"
          find ./generated -type f

      - name: Make sure generation did not modify source files
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "‚ùå Generated Go bindings differ from committed files. Please commit the updated bindings."
            git status
            git --no-pager diff
            exit 1
          else
            echo "‚úÖ Generated Go bindings are up-to-date with committed files."
          fi

      - name: Clone target repository
        run: |
          git clone https://x-access-token:${{ secrets.AGNTCY_BUILD_BOT_GH_TOKEN }}@github.com/${{ env.GO_BINDINGS_REPO }}.git ./target-repo

      - name: Update target repository
        run: |
          pushd ./target-repo

          # Preserve .git directory and manual files like LICENSE, README
          # Remove only the generated files (*.go, *.h, *.a) and cmd directory
          rm -f ./*.go ./*.h ./*.a
          rm -rf ./cmd

          # Copy generated Go bindings (excluding .a files)
          cp ../generated/${{ env.LIBRARY_NAME }}/*.{go,h} ./

          # Copy CLI tool (self-contained, includes download logic)
          mkdir -p ./cmd/slim-bindings-setup
          cp ../release-files/cmd/slim-bindings-setup/main.go ./cmd/slim-bindings-setup/

          # Create go.mod if it doesn't exist
          if [ ! -f go.mod ]; then
            echo "üì¶ Creating go.mod for target repository..."
            go mod init github.com/${{ env.GO_BINDINGS_REPO }}
          fi

          # Show what will be committed
          echo "üìã Files to be committed:"
          git status

          popd

      - name: Commit and push
        run: |
          pushd ./target-repo

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "‚úÖ No changes to commit - bindings are up-to-date"
            exit 0
          fi

          git commit -m "Release ${{ env.RELEASE_VERSION }}

          Generated from https://github.com/${{ github.repository }}/commit/${{ github.sha }}

          Platforms:
          - linux/amd64 (x86_64-unknown-linux-gnu)
          - linux/arm64 (aarch64-unknown-linux-gnu)
          - linux/amd64-musl (x86_64-unknown-linux-musl)
          - linux/arm64-musl (aarch64-unknown-linux-musl)
          - darwin/arm64 (aarch64-apple-darwin)
          - darwin/amd64 (x86_64-apple-darwin)
          - windows/amd64 (x86_64-pc-windows-msvc)"

          # TODO: uncomment this before merge
          # git tag -a "${{ env.RELEASE_VERSION }}" -m "Release ${{ env.RELEASE_VERSION }}"

          git push origin main
          # git push origin "${{ env.RELEASE_VERSION }}"

          echo "‚úÖ Successfully pushed Go bindings to https://github.com/${{ env.GO_BINDINGS_REPO }}"

          popd

  # ==========================================================================
  # Job 4: Test the published Go bindings work as expected
  # ==========================================================================
  test-go-bindings:
    name: Test Go Bindings (${{ matrix.platform.target }})
    runs-on: ${{ matrix.platform.runner }}
    needs: release-go-bindings
    if: github.event_name != 'pull_request'  # Skip on PRs since bindings aren't actually published
    strategy:
      fail-fast: false
      matrix:
        platform:
          # Test on native runners for each platform we build for
          - runner: ubuntu-24.04
            os: linux
            target: x86_64-unknown-linux-gnu
          - runner: windows-latest
            os: windows
            target: x86_64-pc-windows-msvc
          - runner: macos-15-intel
            os: macos
            target: x86_64-apple-darwin
          - runner: macos-15
            os: macos
            target: aarch64-apple-darwin
          # Note: We build for aarch64-linux and musl variants via cross-compilation,
          # but GitHub Actions doesn't provide free ARM64 Linux runners for testing.
          # The setup tool will automatically select the correct binary for the platform.
    defaults:
      run:
        shell: bash
    steps:
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Wait for GitHub to update (package propagation)
        run: |
          echo "‚è≥ Waiting 30 seconds for GitHub package index to update..."
          sleep 30

      - name: Test bindings installation and usage
        run: |
          # Create a temporary test directory
          if [ "$RUNNER_OS" = "Windows" ]; then
            TEST_DIR=$(mktemp -d -p "$RUNNER_TEMP")
          else
            TEST_DIR=$(mktemp -d)
          fi
          cd "$TEST_DIR"
          echo "üìÇ Testing in: $TEST_DIR"
          echo "üñ•Ô∏è  Platform: ${{ matrix.platform.target }}"
          echo "üèÉ Runner: ${{ matrix.platform.runner }}"

          # Initialize a test Go module
          go mod init test
          echo "‚úÖ Created test module"

          # Fetch the bindings from GitHub (use main branch for now)
          go get github.com/${{ env.GO_BINDINGS_REPO }}@main
          echo "‚úÖ Fetched bindings package"

          # Run the setup tool to download native libraries
          go run github.com/${{ env.GO_BINDINGS_REPO }}/cmd/slim-bindings-setup@main
          echo "‚úÖ Downloaded native libraries"

          # Create a test program
          cat << 'EOF' > main.go
          package main

          import (
          	"fmt"

          	slim "github.com/${{ env.GO_BINDINGS_REPO }}"
          )

          func main() {
          	fmt.Println("üöÄ SLIM Go Bindings Test")
          	fmt.Println("========================")

          	// Initialize crypto provider (required before any operations)
          	slim.InitializeCryptoProvider()
          	fmt.Println("‚úÖ Crypto initialized successfully")

          	fmt.Println("‚úÖ Test passed!")
          }
          EOF

          echo "‚úÖ Created test program"

          # Run the test program
          go run main.go

          echo ""
          echo "üéâ All tests passed on ${{ matrix.platform.target }}!"

      - name: Test result summary
        if: success()
        run: |
          echo "‚úÖ Go bindings verification completed successfully on ${{ matrix.platform.target }}"
          echo "The published bindings can be safely tagged for release."
