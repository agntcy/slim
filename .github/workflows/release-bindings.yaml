# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

---
name: Release Bindings

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.7.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (do not push to external repos)'
        required: false
        type: boolean
        default: false

env:
  LIBRARY_NAME: slim_bindings
  GO_BINDINGS_REPO: agntcy/slim-bindings-go
  UNIFFI_BINDGEN_GO_VERSION: v0.4.0+v0.28.3

jobs:
  # ==========================================================================
  # Job 1: Build native libraries for all platforms
  # ==========================================================================
  build-libraries:
    name: Build Libraries
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            lib_ext: so
          - os: macos-latest
            target: x86_64-apple-darwin
            lib_ext: dylib
          - os: macos-latest
            target: aarch64-apple-darwin
            lib_ext: dylib
          # TODO: Add other platforms as needed

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # TODO: Implement actual build steps
      # - name: Setup Rust
      #   uses: ./.github/actions/setup-rust
      #   with:
      #     workspace: ./data-plane

      # - name: Add Rust target
      #   run: rustup target add ${{ matrix.target }}

      # - name: Build library
      #   working-directory: ./data-plane
      #   run: cargo build --release --target ${{ matrix.target }} -p agntcy-slim-bindings

      # - name: Upload artifact
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: lib-${{ matrix.target }}
      #     path: ./data-plane/target/${{ matrix.target }}/release/lib${{ env.LIBRARY_NAME }}.${{ matrix.lib_ext }}
      #     retention-days: 1

      - name: Placeholder
        run: echo "TODO - Build for ${{ matrix.target }}"

  # ==========================================================================
  # Job 2: Generate and publish Go bindings
  # ==========================================================================
  release-go-bindings:
    name: Release Go Bindings
    runs-on: ubuntu-latest
    needs: build-libraries

    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: ./data-plane

      # Download all library artifacts
      # TODO: Uncomment when build-libraries job is implemented
      # - name: Download Linux x86_64 library
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: lib-x86_64-unknown-linux-gnu
      #     path: ./artifacts/linux-x86_64

      # - name: Download macOS x86_64 library
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: lib-x86_64-apple-darwin
      #     path: ./artifacts/darwin-x86_64

      # - name: Download macOS arm64 library
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: lib-aarch64-apple-darwin
      #     path: ./artifacts/darwin-arm64

      # For now, build the library locally for generating bindings
      - name: Build library for binding generation
        working-directory: ./data-plane
        run: cargo build --release -p agntcy-slim-bindings

      - name: Install uniffi-bindgen-go
        run: |
          go install github.com/AryeeLabGroup/uniffi-bindgen-go/bindgen/uniffi-bindgen-go@${{ env.UNIFFI_BINDGEN_GO_VERSION }}

      - name: Generate Go bindings
        run: |
          mkdir -p ./generated-go-bindings

          # Generate Go bindings from the library
          uniffi-bindgen-go \
            --library ./data-plane/target/release/lib${{ env.LIBRARY_NAME }}.so \
            --out-dir ./generated-go-bindings

          echo "Generated files:"
          find ./generated-go-bindings -type f

      - name: Prepare Go module
        working-directory: ./generated-go-bindings
        run: |
          # Initialize Go module for the bindings package
          cd ${{ env.LIBRARY_NAME }}
          go mod init github.com/${{ env.GO_BINDINGS_REPO }}/${{ env.LIBRARY_NAME }}
          go mod tidy || true

          # Create a top-level go.mod for the repo
          cd ..
          cat > go.mod << 'EOF'
          module github.com/${{ env.GO_BINDINGS_REPO }}

          go 1.22
          EOF

      - name: Copy native libraries
        run: |
          # Create lib directories for each platform
          mkdir -p ./generated-go-bindings/lib/linux-x86_64
          mkdir -p ./generated-go-bindings/lib/darwin-x86_64
          mkdir -p ./generated-go-bindings/lib/darwin-arm64

          # TODO: Copy from artifacts when build job is implemented
          # cp ./artifacts/linux-x86_64/lib${{ env.LIBRARY_NAME }}.so ./generated-go-bindings/lib/linux-x86_64/
          # cp ./artifacts/darwin-x86_64/lib${{ env.LIBRARY_NAME }}.dylib ./generated-go-bindings/lib/darwin-x86_64/
          # cp ./artifacts/darwin-arm64/lib${{ env.LIBRARY_NAME }}.dylib ./generated-go-bindings/lib/darwin-arm64/

          # For now, copy the locally built library
          cp ./data-plane/target/release/lib${{ env.LIBRARY_NAME }}.so ./generated-go-bindings/lib/linux-x86_64/

      - name: Clone target repository
        run: |
          git clone https://x-access-token:${{ secrets.GO_BINDINGS_PUSH_TOKEN }}@github.com/${{ env.GO_BINDINGS_REPO }}.git ./target-repo

      - name: Update target repository
        working-directory: ./target-repo
        run: |
          # Remove old generated files (keep .git and any non-generated files)
          find . -maxdepth 1 -not -name '.git' -not -name '.' -exec rm -rf {} +

          # Copy new generated files
          cp -r ../generated-go-bindings/* .

          # Show what will be committed
          echo "Files to be committed:"
          git status

      - name: Commit and push
        if: ${{ !inputs.dry_run }}
        working-directory: ./target-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Release ${{ inputs.version }}

          Generated from https://github.com/${{ github.repository }}/commit/${{ github.sha }}"

          git tag -a "${{ inputs.version }}" -m "Release ${{ inputs.version }}"

          git push origin main
          git push origin "${{ inputs.version }}"

          echo "âœ… Successfully pushed Go bindings to https://github.com/${{ env.GO_BINDINGS_REPO }}"

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        working-directory: ./target-repo
        run: |
          echo "ðŸ” DRY RUN - Would commit the following changes:"
          git status
          echo ""
          echo "Generated files:"
          find . -type f -not -path './.git/*' | head -50

