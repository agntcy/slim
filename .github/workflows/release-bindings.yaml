# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

---
name: Release Bindings

on:
  pull_request:
    paths:
      - 'data-plane/**'
      - '.github/workflows/release-bindings.yaml'

  workflow_dispatch:
    inputs:
      version:
        # TODO: make this required
        description: 'Release version (e.g., v0.7.0)'
        required: false
        type: string
        default: 'v0.0.0-dev'

env:
  LIBRARY_NAME: slim_bindings
  GO_BINDINGS_REPO: agntcy/slim-bindings-go
  UNIFFI_BINDGEN_GO_VERSION: v0.4.0+v0.28.3
  # Computed values with defaults for pull_request events
  RELEASE_VERSION: ${{ inputs.version || 'v0.0.0-pr' }}

jobs:
  # ==========================================================================
  # Job 1: Build native libraries for all platforms
  # ==========================================================================
  build-libraries:
    name: Build ${{ matrix.target }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            lib_prefix: lib
            lib_ext: so
          # TODO: re-enable x86_64-apple-darwin
          # - os: macos-latest
          #   target: x86_64-apple-darwin
          #   lib_prefix: lib
          #   lib_ext: dylib
          - os: macos-latest
            target: aarch64-apple-darwin
            lib_prefix: lib
            lib_ext: dylib

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: ./data-plane

      - name: Add Rust target
        run: rustup target add ${{ matrix.target }}

      - name: Build library
        working-directory: ./data-plane
        run: cargo build --release --target ${{ matrix.target }} -p agntcy-slim-bindings

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: ./data-plane/target/${{ matrix.target }}/release/${{ matrix.lib_prefix }}${{ env.LIBRARY_NAME }}.${{ matrix.lib_ext }}
          retention-days: 7
          if-no-files-found: error

  # ==========================================================================
  # Job 2: Generate and publish Go bindings
  # ==========================================================================
  release-go-bindings:
    name: Release Go Bindings
    runs-on: ubuntu-latest
    needs: build-libraries

    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: ./data-plane

      # Download all library artifacts
      - name: Download Linux x86_64 library
        uses: actions/download-artifact@v4
        with:
          name: x86_64-unknown-linux-gnu
          path: ./artifacts/linux-x86_64

      # TODO: re-enable x86_64-apple-darwin
      # - name: Download macOS x86_64 library
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: x86_64-apple-darwin
      #     path: ./artifacts/darwin-x86_64

      - name: Download macOS arm64 library
        uses: actions/download-artifact@v4
        with:
          name: aarch64-apple-darwin
          path: ./artifacts/darwin-arm64

      - name: List downloaded artifacts
        run: |
          echo "üì¶ Downloaded artifacts:"
          find ./artifacts -type f -ls

      - name: Install uniffi-bindgen-go
        run: |
          cargo install uniffi-bindgen-go \
            --git https://github.com/NordSecurity/uniffi-bindgen-go.git \
            --tag ${{ env.UNIFFI_BINDGEN_GO_VERSION }} \
            --config net.git-fetch-with-cli=true

      - name: Generate Go bindings
        working-directory: ./data-plane
        run: |
          mkdir -p ../generated-go-bindings

          # Generate Go bindings from the Linux library
          # (uniffi-bindgen-go reads metadata from the .so file and needs Cargo.toml)
          uniffi-bindgen-go \
            --library ../artifacts/linux-x86_64/lib${{ env.LIBRARY_NAME }}.so \
            --out-dir ../generated-go-bindings

          echo "üìÅ Generated files:"
          find ../generated-go-bindings -type f

      - name: Prepare Go module
        working-directory: ./generated-go-bindings/${{ env.LIBRARY_NAME }}
        run: |
          # Initialize Go module for the bindings package
          go mod init github.com/${{ env.GO_BINDINGS_REPO }}/${{ env.LIBRARY_NAME }}
          go mod tidy || true

      - name: Organize native libraries
        run: |
          # Create platform-specific lib directories inside the Go package
          LIBDIR="./generated-go-bindings/${{ env.LIBRARY_NAME }}/lib"
          mkdir -p "$LIBDIR/linux-x86_64"
          # mkdir -p "$LIBDIR/darwin-x86_64"  # TODO: re-enable
          mkdir -p "$LIBDIR/darwin-arm64"

          # Copy libraries from artifacts
          cp ./artifacts/linux-x86_64/lib${{ env.LIBRARY_NAME }}.so "$LIBDIR/linux-x86_64/"
          # cp ./artifacts/darwin-x86_64/lib${{ env.LIBRARY_NAME }}.dylib "$LIBDIR/darwin-x86_64/"  # TODO: re-enable
          cp ./artifacts/darwin-arm64/lib${{ env.LIBRARY_NAME }}.dylib "$LIBDIR/darwin-arm64/"

          echo "üì¶ Organized library structure:"
          find "$LIBDIR" -type f -ls

      - name: Clone target repository
        run: |
          git clone https://x-access-token:${{ secrets.AGNTCY_BUILD_BOT_GH_TOKEN }}@github.com/${{ env.GO_BINDINGS_REPO }}.git ./target-repo

      - name: Update target repository
        working-directory: ./target-repo
        run: |
          # Preserve .git directory and any manual files like LICENSE, README
          # Remove only the generated package directory
          rm -rf ./${{ env.LIBRARY_NAME }}

          # Copy the generated package
          cp -r ../generated-go-bindings/${{ env.LIBRARY_NAME }} ./

          # Show what will be committed
          echo "üìã Files to be committed:"
          git status

      - name: Commit and push
        working-directory: ./target-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "‚úÖ No changes to commit - bindings are up-to-date"
            exit 0
          fi

          git commit -m "Release ${{ env.RELEASE_VERSION }}

          Generated from https://github.com/${{ github.repository }}/commit/${{ github.sha }}

          Platforms:
          - linux/amd64 (x86_64-unknown-linux-gnu)
          - darwin/arm64 (aarch64-apple-darwin)"

          git tag -a "${{ env.RELEASE_VERSION }}" -m "Release ${{ env.RELEASE_VERSION }}"

          git push origin main
          git push origin "${{ env.RELEASE_VERSION }}"

          echo "‚úÖ Successfully pushed Go bindings to https://github.com/${{ env.GO_BINDINGS_REPO }}"
