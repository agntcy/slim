# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

---
name: Release Bindings

on:
  push:
    tags:
      - 'slim-bindings-*'

env:
  LIBRARY_NAME: slim_bindings
  GO_BINDINGS_REPO: agntcy/slim-bindings-go
  NUGET_PACKAGE_NAME: Agntcy.Slim
  UNIFFI_BINDGEN_GO_VERSION: v0.4.0+v0.28.3
  UNIFFI_BINDGEN_CS_VERSION: v0.9.0+v0.28.3
  DOTNET_VERSION: "8.0.x"

jobs:
  # ==========================================================================
  # Job 1: Build and test bindings libraries for all languages and platforms
  # ==========================================================================
  build-and-test-bindings:
    name: "Build and Test Bindings"
    uses: ./.github/workflows/reusable-bindings-build-and-test.yaml
    with:
      tag-name: ${{ github.ref_name }}

  # ==========================================================================
  # Job 2: Create GitHub release with library artifacts (for test tags)
  # ==========================================================================
  release-libraries:
    name: Release Libraries
    runs-on: ubuntu-latest
    needs: build-and-test-bindings
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Download all library artifacts from build-libraries job
      - name: Download all library artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts/
          pattern: bindings-*

      - name: List downloaded artifacts
        run: |
          echo "ðŸ“¦ Downloaded artifacts:"
          find ./artifacts -type f -ls

      - name: Prepare release artifacts
        run: |
          mkdir -p ./release-artifacts

          # Strip symbols from Unix dynamic (.so) libraries to reduce size
          echo "Stripping Unix dynamic libraries..."
          find ./artifacts -type f -name "*.so" -exec strip --strip-unneeded {} \;
          echo "Stripped .so files"

          # The download-artifact action already organizes files by artifact name
          # Each platform's libraries are in ./artifacts/bindings-<target>/
          # We'll zip each platform's libraries separately

          for platform_dir in ./artifacts/bindings-*/; do
            if [ -d "$platform_dir" ]; then
              platform_name=$(basename "$platform_dir" | sed 's/^bindings-//')
              echo "ðŸ“¦ Zipping libraries for platform: $platform_name"

              cd "$platform_dir"
              zip -r "../../release-artifacts/slim-bindings-${platform_name}.zip" *
              cd - > /dev/null

              echo "âœ… Created slim-bindings-${platform_name}.zip"
            fi
          done

          echo "ðŸ“‹ Release artifacts:"
          ls -lah ./release-artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ github.ref_name }}"
          body: |
            Release of SLIM native bindings libraries.

            **Platforms included:**
            - Linux x86_64 (GNU and musl)
            - Linux aarch64 (GNU and musl)
            - macOS x86_64 (Intel)
            - macOS aarch64 (Apple Silicon)
            - Windows x86_64 (GNU and MSVC)
            - Windows aarch64 (MSVC)

            Built from commit: ${{ github.sha }}
          files: ./release-artifacts/*.zip
          draft: false

  # ==========================================================================
  # Job 3: Generate and publish Go bindings
  # ==========================================================================
  # release-go-bindings:
  #   name: "Release Go Bindings"
  #   needs: build-and-test-bindings
  #   uses: ./.github/workflows/reusable-go-bindings-release.yaml
  #   secrets:
  #     gh-token: ${{ secrets.AGNTCY_BUILD_BOT_GH_TOKEN }}

  # ==========================================================================
  # Job 4: Release Python bindings to PyPI
  # ==========================================================================
  # release-python-bindings:
  #   name: Upload release to PyPI
  #   runs-on: ubuntu-latest
  #   needs:
  #     - build-and-test-bindings
  #   permissions:
  #     # IMPORTANT: this permission is mandatory for Trusted Publishing
  #     id-token: write
  #     contents: read
  #   steps:
  #     - name: Download artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         merge-multiple: true
  #         path: dist
  #         pattern: wheels-*

  #     - name: Show files
  #       run: ls -l dist

  #     - name: Publish package distributions to PyPI
  #       uses: pypa/gh-action-pypi-publish@release/v1
  #       with:
  #         password: ${{ secrets.PYPI_API_TOKEN }}
  #         packages-dir: dist

  # ==========================================================================
  # Job 5: Release .NET bindings to NuGet
  # ==========================================================================
  # release-dotnet-bindings:
  #   name: "Release .NET Bindings"
  #   needs: build-and-test-bindings
  #   uses: ./.github/workflows/reusable-dotnet-bindings-release.yaml
  #   secrets:
  #     nuget-api-token: ${{ secrets.NUGET_API_TOKEN }}

  # ==========================================================================
  # Job 6: Release Kotlin bindings to GitHub Packages
  # ==========================================================================
  release-kotlin-bindings:
    name: "Release Kotlin Bindings"
    needs: build-and-test-bindings
    uses: ./.github/workflows/reusable-kotlin-bindings-release.yaml
    permissions:
      contents: read    
      packages: write
