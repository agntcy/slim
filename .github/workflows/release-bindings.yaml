# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

---
name: Release Bindings

on:
  push:
    tags:
      - 'slim-node-test-bindings-*'

env:
  LIBRARY_NAME: slim_bindings
  GO_BINDINGS_REPO: agntcy/slim-bindings-go
  UNIFFI_BINDGEN_GO_VERSION: v0.4.0+v0.28.3

jobs:
  # ==========================================================================
  # Job 1: Build and test bindings libraries for all languages and platforms
  # ==========================================================================
  build-and-test-bindings:
    name: "Build and Test Bindings"
    uses: ./.github/workflows/reusable-bindings-build-and-test.yaml

  # ==========================================================================
  # Job 2: Create GitHub release with library artifacts (for test tags)
  # ==========================================================================
  release-libraries:
    name: Release Libraries
    runs-on: ubuntu-latest
    needs: build-and-test-bindings
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Download all library artifacts from build-libraries job
      - name: Download all library artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts/
          pattern: bindings-*

      - name: List downloaded artifacts
        run: |
          echo "ðŸ“¦ Downloaded artifacts:"
          find ./artifacts -type f -ls

      - name: Prepare release artifacts
        run: |
          mkdir -p ./release-artifacts

          # The download-artifact action already organizes files by artifact name
          # Each platform's libraries are in ./artifacts/bindings-<target>/
          # We'll zip each platform's libraries separately

          for platform_dir in ./artifacts/bindings-*/; do
            if [ -d "$platform_dir" ]; then
              platform_name=$(basename "$platform_dir" | sed 's/^bindings-//')
              echo "ðŸ“¦ Zipping libraries for platform: $platform_name"

              cd "$platform_dir"
              zip -r "../../release-artifacts/slim-bindings-${platform_name}.zip" *
              cd - > /dev/null

              echo "âœ… Created slim-bindings-${platform_name}.zip"
            fi
          done

          echo "ðŸ“‹ Release artifacts:"
          ls -lah ./release-artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ github.ref_name }}"
          body: |
            Release of SLIM native bindings libraries.

            **Platforms included:**
            - Linux x86_64 (GNU and musl)
            - Linux aarch64 (GNU and musl)
            - macOS x86_64 (Intel)
            - macOS aarch64 (Apple Silicon)
            - Windows x86_64 (GNU and MSVC)
            - Windows aarch64 (MSVC)

            Built from commit: ${{ github.sha }}
          files: ./release-artifacts/*.zip
          draft: false

  # ==========================================================================
  # Job 3: Generate and publish Go bindings
  # ==========================================================================
  release-go-bindings:
    name: "Release Go Bindings"
    if: false  # Disabled for temporary npm testing
    needs: build-and-test-bindings
    uses: ./.github/workflows/reusable-go-bindings-release.yaml
    secrets:
      gh-token: ${{ secrets.AGNTCY_BUILD_BOT_GH_TOKEN }}

  # ==========================================================================
  # Job 4: Release Python bindings to PyPI
  # ==========================================================================
  release-python-bindings:
    name: Upload release to PyPI
    if: false  # Disabled for temporary npm testing
    runs-on: ubuntu-latest
    needs:
      - build-and-test-bindings
    permissions:
      # IMPORTANT: this permission is mandatory for Trusted Publishing
      id-token: write
      contents: read
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          path: dist
          pattern: wheels-*

      - name: Show files
        run: ls -l dist

      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages-dir: dist

  # ==========================================================================
  # Job 5: Generate Node bindings once (x86_64 Linux) for use by all pack jobs.
  # uniffi-bindgen-node must load the .so on the host; we only have native lib for
  # the runner, so we generate once then pack per target with each target's lib.
  # ==========================================================================
  generate-node-bindings-once:
    name: Generate Node bindings (once)
    runs-on: ubuntu-latest
    needs:
      - build-and-test-bindings
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: ./data-plane

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Task
        uses: ./.github/actions/setup-task

      - name: Download library artifact (x86_64 Linux)
        uses: actions/download-artifact@v4
        with:
          name: bindings-x86_64-unknown-linux-gnu
          path: .

      - name: Place library for Node generate
        run: |
          RELEASE_DIR="data-plane/target/x86_64-unknown-linux-gnu/release"
          mkdir -p "$RELEASE_DIR"
          if [ -n "$(ls -A "$RELEASE_DIR" 2>/dev/null)" ]; then
            echo "Library files (from artifact path):"
            ls -la "$RELEASE_DIR/"
            exit 0
          fi
          find . -name '*slim_bindings*' -type f -exec cp -v {} "$RELEASE_DIR/" \; 2>/dev/null
          [ -n "$(ls -A "$RELEASE_DIR" 2>/dev/null)" ] || { echo "No library files found."; ls -laR . 2>/dev/null | head -80; exit 1; }
          echo "Library files (copied):"
          ls -la "$RELEASE_DIR/"

      - name: Generate Node bindings
        working-directory: ./data-plane/bindings/node
        run: |
          npm install
          task generate TARGET=x86_64-unknown-linux-gnu

      - name: Upload generated bindings
        uses: actions/upload-artifact@v4
        with:
          name: node-generated-bindings
          path: ./data-plane/bindings/node/generated/

  # ==========================================================================
  # Job 6: Build Node platform packages (matrix: one per target with .so/.dylib/.dll).
  # Uses pre-generated bindings + each target's library (no uniffi-bindgen-node on non-native libs).
  # musl excluded: Rust build produces only static .a for musl, no .so.
  # ==========================================================================
  build-node-packages:
    name: Node ${{ matrix.target }}
    runs-on: ubuntu-latest
    needs:
      - build-and-test-bindings
      - generate-node-bindings-once
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-apple-darwin
          - x86_64-apple-darwin
          - x86_64-pc-windows-msvc
          - aarch64-unknown-linux-gnu
          - aarch64-pc-windows-msvc
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get bindings version
        id: version
        run: echo "version=$(bash .github/scripts/get-binding-version.sh)" >> $GITHUB_OUTPUT

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Task
        uses: ./.github/actions/setup-task

      - name: Download generated bindings
        uses: actions/download-artifact@v4
        with:
          name: node-generated-bindings
          path: ./data-plane/bindings/node/generated/

      - name: Download library artifact
        uses: actions/download-artifact@v4
        with:
          name: bindings-${{ matrix.target }}
          path: .

      - name: Place library for Node pack
        run: |
          RELEASE_DIR="data-plane/target/${{ matrix.target }}/release"
          mkdir -p "$RELEASE_DIR"
          if [ -n "$(ls -A "$RELEASE_DIR" 2>/dev/null)" ]; then
            echo "Library files (from artifact path):"
            ls -la "$RELEASE_DIR/"
            exit 0
          fi
          find . -name '*slim_bindings*' -type f -exec cp -v {} "$RELEASE_DIR/" \; 2>/dev/null
          if [ -n "$(ls -A "$RELEASE_DIR" 2>/dev/null)" ]; then
            echo "Library files (copied):"
            ls -la "$RELEASE_DIR/"
            exit 0
          fi
          echo "No library files found after download."
          ls -laR . 2>/dev/null | head -80
          exit 1

      - name: Pack Node platform package
        working-directory: ./data-plane/bindings/node
        run: |
          npm install
          task pack:platform:from-artifacts TARGET=${{ matrix.target }} VERSION=${{ steps.version.outputs.version }}

      - name: Upload Node platform package
        uses: actions/upload-artifact@v4
        with:
          name: node-platform-${{ matrix.target }}
          path: ./data-plane/bindings/node/dist/node-*.tgz

  # ==========================================================================
  # Job 7: Publish Node platform packages to npm
  # ==========================================================================
  publish-node-platform-packages:
    name: Publish Node platform packages
    runs-on: ubuntu-latest
    needs: build-node-packages
    permissions:
      contents: read
    steps:
      - name: Download all Node platform artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./node-packages
          pattern: node-platform-*

      - name: Configure npm auth
        run: echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" >> .npmrc
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm
        run: |
          for tgz in ./node-packages/node-platform-*/*.tgz; do
            [ -f "$tgz" ] || continue
            echo "Publishing $tgz..."
            npm publish "$tgz" --access public
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ==========================================================================
  # Job 8: Publish Node main package to npm
  # ==========================================================================
  publish-node-main:
    name: Publish Node main package
    runs-on: ubuntu-latest
    needs: publish-node-platform-packages
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get bindings version
        id: version
        run: echo "version=$(bash .github/scripts/get-binding-version.sh)" >> $GITHUB_OUTPUT

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: ./data-plane
      - name: Setup Task
        uses: ./.github/actions/setup-task

      - name: Download library artifact (for generate)
        uses: actions/download-artifact@v4
        with:
          name: bindings-x86_64-unknown-linux-gnu

      - name: Place library for Node generate
        run: |
          mkdir -p data-plane/target/x86_64-unknown-linux-gnu/release
          cp -v bindings-x86_64-unknown-linux-gnu/* data-plane/target/x86_64-unknown-linux-gnu/release/

      - name: Generate bindings and emit types (one platform for types)
        working-directory: ./data-plane/bindings/node
        run: |
          npm install
          task generate TARGET=x86_64-unknown-linux-gnu
          task emit-types

      - name: Set version in package.json
        working-directory: ./data-plane/bindings/node
        run: |
          npm pkg set version="${{ steps.version.outputs.version }}"
          node -e "
            const pkg = require('./package.json');
            const opt = pkg.optionalDependencies || {};
            for (const k of Object.keys(opt)) opt[k] = '${{ steps.version.outputs.version }}';
            pkg.optionalDependencies = opt;
            require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "

      - name: Configure npm auth
        run: echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" >> .npmrc
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish main package to npm
        working-directory: ./data-plane/bindings/node
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ==========================================================================
  # Job 9: Build and publish React Native bindings to npm
  # Runs on mac to build iOS static lib; requires NPM_TOKEN.
  # ==========================================================================
  publish-react-native:
    name: Publish React Native to npm
    runs-on: macos-15
    needs:
      - build-and-test-bindings
      - release-python-bindings
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get bindings version
        id: version
        run: echo "version=$(bash .github/scripts/get-binding-version.sh)" >> $GITHUB_OUTPUT

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: ./data-plane

      - name: Setup Task
        uses: ./.github/actions/setup-task

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build iOS static lib and generate bindings
        working-directory: ./data-plane/bindings/react-native
        run: |
          task adapter:bindings:build:all TARGET=aarch64-apple-ios-sim PROFILE=release
          task generate TARGET=aarch64-apple-ios-sim

      - name: Vendor iOS static lib
        working-directory: ./data-plane/bindings/react-native
        run: task vendor:ios

      - name: Set version in package.json
        working-directory: ./data-plane/bindings/react-native
        run: npm pkg set version="${{ steps.version.outputs.version }}"

      - name: Configure npm auth
        run: echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" >> .npmrc
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm
        working-directory: ./data-plane/bindings/react-native
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

