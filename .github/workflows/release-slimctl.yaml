# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

---
name: ci-release-slimctl

on:
  push:
    tags:
      - 'slimctl-v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  prepare:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create GitHub Release
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          gh release create "$TAG" --title "$TAG" --notes "Release $TAG" || echo "Release already exists"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-binaries:
    uses: ./.github/workflows/reusable-go-build-and-test.yaml
    with:
      # Skip lint, test, and coverage - only build binaries
      go-lint: false
      go-vuln: false
      go-test: false
      go-test-coverage: false
      # Enable cross-build with CGO for slimctl
      go-cross-build: true
      cgo-enabled: '1'
      use-local-bindings: true
      # Enable artifact upload for release
      upload-artifacts: true

  goreleaser-publish:
    runs-on: ubuntu-latest

    needs: [prepare, build-binaries]

    permissions:
      contents: write
      pull-requests: write

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          # Extract version from tag (e.g., slimctl-v1.0.0 -> 1.0.0)
          VERSION=${TAG#slimctl-v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create archives and checksums
        run: |
          mkdir -p .dist/archives
          VERSION="${{ steps.version.outputs.version }}"

          # Get absolute path to archives directory
          ARCHIVES_DIR="$(pwd)/.dist/archives"

          # Process each platform's binary
          for artifact_dir in artifacts/slimctl-*; do
            if [ -d "$artifact_dir" ]; then
              dir_name=$(basename "$artifact_dir")
              os=$(echo "$dir_name" | cut -d'-' -f2)
              arch=$(echo "$dir_name" | cut -d'-' -f3)

              archive_name="slimctl_${VERSION}_${os}_${arch}"

              # Create archives based on platform
              if [ "$os" = "windows" ]; then
                # Create zip for Windows
                if [ -f "$artifact_dir/slimctl.exe" ]; then
                  (cd "$artifact_dir" && zip "${ARCHIVES_DIR}/${archive_name}.zip" slimctl.exe)
                  echo "✓ Created ${archive_name}.zip"
                fi
              else
                # Create tar.gz for Unix systems (darwin, linux)
                if [ -f "$artifact_dir/slimctl" ]; then
                  tar -czf "${ARCHIVES_DIR}/${archive_name}.tar.gz" -C "$artifact_dir" slimctl
                  echo "✓ Created ${archive_name}.tar.gz"
                fi
              fi
            fi
          done

          # Generate checksums
          cd .dist/archives
          shasum -a 256 * > slimctl_checksums.txt
          echo ""
          echo "✓ Generated checksums:"
          cat slimctl_checksums.txt

          echo ""
          echo "Archives created:"
          ls -lh

      - name: Create Homebrew cask
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"

          # Calculate SHA256 for darwin amd64
          AMD64_SHA=$(shasum -a 256 .dist/archives/slimctl_${VERSION}_darwin_amd64.tar.gz | cut -d' ' -f1)
          ARM64_SHA=$(shasum -a 256 .dist/archives/slimctl_${VERSION}_darwin_arm64.tar.gz | cut -d' ' -f1)

          mkdir -p ./Casks

          cat > ./Casks/slimctl.rb << EOF
          cask "slimctl" do
            version "${VERSION}"

            if Hardware::CPU.intel?
              sha256 "${AMD64_SHA}"
              url "https://github.com/agntcy/slim/releases/download/${TAG}/slimctl_${VERSION}_darwin_amd64.tar.gz"
            else
              sha256 "${ARM64_SHA}"
              url "https://github.com/agntcy/slim/releases/download/${TAG}/slimctl_${VERSION}_darwin_arm64.tar.gz"
            end

            name "slimctl"
            desc "A CLI tool for managing SLIM Devices"
            homepage "https://github.com/agntcy/slim"

            binary "slimctl"

            postflight do
              system "chmod", "+x", "#{staged_path}/slimctl"
              system "/usr/bin/xattr", "-dr", "com.apple.quarantine", "#{staged_path}/slimctl" if MacOS.version >= :catalina
            end
          end
          EOF

          echo "✓ Created Homebrew cask"
          cat ./Casks/slimctl.rb

      - name: Upload archives to release
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          echo "Uploading archives to release $TAG"

          # Upload all archives and checksums
          gh release upload "$TAG" .dist/archives/* --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request for Homebrew cask
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: Update Homebrew cask for slimctl
          title: Update slimctl cask to latest version
          body: |
            Update Homebrew cask to reflect release changes

            Release: ${{ github.ref_name }}
          branch: update-slimctl-cask
          base: main
