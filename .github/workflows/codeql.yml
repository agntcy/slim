# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

name: "CodeQL Advanced"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '42 5 * * 6'
  workflow_dispatch:

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    # Runner size impacts CodeQL analysis time. To learn more, please see:
    #   - https://gh.io/recommended-hardware-resources-for-running-codeql
    #   - https://gh.io/supported-runners-and-hardware-resources
    #   - https://gh.io/using-larger-runners (GitHub.com only)
    # Consider using larger runners or machines with greater resources for possible analysis time improvements.
    runs-on: ubuntu-latest
    permissions:
      # required for all workflows
      security-events: write

      # required to fetch internal or private CodeQL packs
      packages: read

      # only required for workflows in private repositories
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
        - language: go
          build-mode: autobuild
        - language: rust
          build-mode: none
        - language: python
          build-mode: none
        # CodeQL supports the following values keywords for 'language': 'actions', 'c-cpp', 'csharp', 'go', 'java-kotlin', 'javascript-typescript', 'python', 'ruby', 'rust', 'swift'
        # Use `c-cpp` to analyze code written in C, C++ or both
        # Use 'java-kotlin' to analyze code written in Java, Kotlin or both
        # Use 'javascript-typescript' to analyze code written in JavaScript, TypeScript or both
        # To learn more about changing the languages that are analyzed or customizing the build mode for your analysis,
        # see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/customizing-your-advanced-setup-for-code-scanning.
        # If you are analyzing a compiled language, you can modify the 'build-mode' for that language to customize how
        # your codebase is analyzed, see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/codeql-code-scanning-for-compiled-languages
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4 # v4.2.2

    - name: Disk cleanup
      uses: ./.github/actions/cleanup-disk

    - name: Log language being analyzed
      run: |
        echo "üîç Starting CodeQL analysis for: ${{ matrix.language }}"
        echo "Build mode: ${{ matrix.build-mode }}"

    # Setup language environments BEFORE CodeQL initialization
    - name: Set up Go
      if: matrix.language == 'go'
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.5'
        cache: true

    - name: Install Task
      if: matrix.language == 'go'
      uses: arduino/setup-task@b91d5d2c96a56797b48ac1e0e89220bf64044611 # v2.0.0
      with:
        version: 3.x
        repo-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install buf CLI
      if: matrix.language == 'go'
      shell: bash
      run: |
        # Install buf for protobuf generation
        curl -sSL "https://github.com/bufbuild/buf/releases/latest/download/buf-$(uname -s)-$(uname -m)" -o /tmp/buf
        sudo mv /tmp/buf /usr/local/bin/buf
        sudo chmod +x /usr/local/bin/buf

    - name: Set up Rust
      if: matrix.language == 'rust'
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        components: rustfmt, clippy

    - name: Install LLVM and Clang
      if: matrix.language == 'rust'
      uses: KyleMayes/install-llvm-action@v2
      with:
        version: "19"

    - name: Rust Cache
      if: matrix.language == 'rust'
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: data-plane

    - name: Set up Python
      if: matrix.language == 'python'
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      if: matrix.language == 'python'
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true

    # Initializes the CodeQL tools for scanning.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4 # v4.0.0
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}
        queries: +security-extended,security-and-quality
        config: |
          name: "CodeQL Config"
          queries:
            - uses: security-extended
            - uses: security-and-quality
          query-filters:
            - exclude:
                # Helm values files use empty strings as defaults
                id: js/empty-password-in-configuration-file
          paths-ignore:
            - "**/*.pb.go"
            - "**/mock_*.go"
            - "**/*_pb2.py"
            - "**/*_pb2_grpc.py"
            - "**/testdata/**"
            - "**/vendor/**"
            - "**/target/**"
            - "**/examples/**"
            - "**/testing/**"
            - "**/tests/**"
            - "**/*_test.go"
            - "**/test_*.py"

    - name: Install Python dependencies
      if: matrix.language == 'python'
      shell: bash
      run: |
        echo "üì¶ Installing Python dependencies..."
        # Install dependencies for Python bindings
        if [ -f "data-plane/python/bindings/pyproject.toml" ]; then
          cd data-plane/python/bindings
          uv sync || echo "Failed to sync Python bindings dependencies"
          cd ../../..
        fi
        echo "‚úÖ Python dependencies installed"

    - name: Prepare Go environment for autobuild
      if: matrix.language == 'go'
      shell: bash
      run: |
        echo "Preparing Go environment for CodeQL autobuild..."
        echo "Go version: $(go version)"
        echo "GOPATH: $GOPATH"
        echo "GOROOT: $GOROOT"
        echo "Working directory: $(pwd)"

        # Download Go module dependencies for control-plane modules
        echo "Pre-downloading Go module dependencies..."
        for module_dir in control-plane/common control-plane/control-plane control-plane/token-service; do
          if [ -f "$module_dir/go.mod" ]; then
            echo "Downloading deps for $module_dir"
            (cd "$module_dir" && go mod download) || echo "Failed to download deps for $module_dir"
          fi
        done

        echo "Go environment prepared for autobuild"

    - name: Run manual build steps
      if: matrix.build-mode == 'manual'
      shell: bash
      run: |
        echo "‚ùå Manual build mode not configured for language: ${{ matrix.language }}"
        echo "‚ÑπÔ∏è  SLIM project uses autobuild for Go and Rust"
        exit 1

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:${{matrix.language}}"
