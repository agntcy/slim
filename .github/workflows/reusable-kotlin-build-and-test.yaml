# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

---
name: kotlin-build-and-test
on:
  workflow_call:
    inputs:
      runner:
        description: Github hosted runner or Self hosted runner
        required: false
        type: string
        default: ubuntu-latest
      rust-workspace:
        description: Rust workspace directory
        required: false
        type: string
        default: ./data-plane
      java-version:
        description: Java version to use
        required: false
        type: string
        default: '21'
      working-directory:
        description: The working directory to run the task
        required: false
        type: string
        default: ./data-plane/bindings/kotlin

jobs:
  kotlin-bindings-build-and-test:
    name: Kotlin Bindings Build and Test
    runs-on: ${{ inputs.runner }}

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: ${{ inputs.rust-workspace }}

      - name: Setup Java
        uses: ./.github/actions/setup-java
        with:
          java-version: ${{ inputs.java-version }}

      # Download all library artifacts from build-libraries job
      - name: Download library artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: bindings-*
          path: ${{ inputs.working-directory }}/artifacts/

      - name: List downloaded artifacts
        run: |
          echo "ðŸ“¦ Downloaded artifacts:"
          find ./artifacts -type f -name "*.so" -o -name "*.dll" -o -name "*.dylib" -o -name "*.a" | sort

      # Generate bindings and run tests
      - name: Generate bindings and run tests
        run: |
          echo "Generate bindings and run tests..."
          # Find the Linux x86_64 .so library for uniffi-bindgen
          LIB_FILE=$(find ./artifacts/bindings-x86_64-unknown-linux-gnu -name "*.so" | head -1)
          echo "Using library: $LIB_FILE"
          task test SKIP_BUILD=true ARTIFACTS_DIR=./artifacts LIB_PATH="$LIB_FILE"

      - name: Upload generated Kotlin code and JNI libraries
        uses: actions/upload-artifact@v4
        with:
          name: kotlin-bindings-generated-code
          path: |
            ${{ inputs.working-directory }}/generated/**/*.kt
            ${{ inputs.working-directory }}/generated/jniLibs/**/*
          if-no-files-found: error
