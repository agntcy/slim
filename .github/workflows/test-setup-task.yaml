# Test workflow for setup-task action
# This workflow is used to test the custom setup-task action
# and can be removed after verification

name: Test Setup Task Action

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/actions/setup-task/**'

jobs:
  test-setup-task:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        version: ['v3.39.2']

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test Setup Task
        id: setup-task
        uses: ./.github/actions/setup-task
        with:
          version: ${{ matrix.version }}

      - name: Verify Task Installation
        shell: bash
        run: |
          echo "Testing Task installation..."
          task --version
          echo "Task is working correctly!"

      - name: Test Task Execution
        shell: bash
        run: |
          # Create a simple Taskfile for testing
          cat > Taskfile.yml << 'EOF'
          version: '3'
          tasks:
            test:
              cmds:
                - echo "Task execution test successful!"
          EOF

          # Run the test task
          task test

      - name: Display outputs
        shell: bash
        run: |
          echo "Cache hit: ${{ steps.setup-task.outputs.cache-hit }}"
          echo "Version: ${{ steps.setup-task.outputs.version }}"

  test-cache-prime:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prime cache (download Task)
        id: prime
        uses: ./.github/actions/setup-task

      - name: Display outputs
        shell: bash
        run: |
          echo "Prime cache hit: ${{ steps.prime.outputs.cache-hit }}"
          echo "Version: ${{ steps.prime.outputs.version }}"

  test-cache-hit:
    runs-on: ubuntu-latest
    needs: [test-cache-prime]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore from cache
        id: cached
        uses: ./.github/actions/setup-task

      - name: Verify cache was used
        shell: bash
        run: |
          echo "Cache hit: ${{ steps.cached.outputs.cache-hit }}"
          if [[ "${{ steps.cached.outputs.cache-hit }}" == "true" ]]; then
            echo "✓ Cache is working correctly!"
          else
            echo "✗ Cache is not working as expected"
            exit 1
          fi
