# Test workflow for setup-task action
# This workflow is used to test the custom setup-task action
# and can be removed after verification

name: Test Setup Task Action

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/actions/setup-task/**'

jobs:
  test-setup-task:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        version: ['latest', '3.45.4']
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test Setup Task
        id: setup-task
        uses: ./.github/actions/setup-task
        with:
          version: ${{ matrix.version }}
          cache-enabled: 'true'
      
      - name: Verify Task Installation
        shell: bash
        run: |
          echo "Testing Task installation..."
          which task
          task --version
          echo "Task is working correctly!"
      
      - name: Test Task Execution
        shell: bash
        run: |
          # Create a simple Taskfile for testing
          cat > Taskfile.yml << 'EOF'
          version: '3'
          tasks:
            test:
              cmds:
                - echo "Task execution test successful!"
          EOF
          
          # Run the test task
          task test
      
      - name: Display outputs
        shell: bash
        run: |
          echo "Cache hit: ${{ steps.setup-task.outputs.cache-hit }}"
          echo "Version: ${{ steps.setup-task.outputs.version }}"
  
  test-cache-effectiveness:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: First run (should download)
        id: first-run
        uses: ./.github/actions/setup-task
        with:
          version: '3.45.4'
          cache-enabled: 'true'
      
      - name: Remove from PATH
        shell: bash
        run: |
          # Remove task from PATH to simulate fresh environment
          sudo rm -f $(which task)
      
      - name: Second run (should use cache)
        id: second-run
        uses: ./.github/actions/setup-task
        with:
          version: '3.45.4'
          cache-enabled: 'true'
      
      - name: Verify cache was used
        shell: bash
        run: |
          echo "First run cache hit: ${{ steps.first-run.outputs.cache-hit }}"
          echo "Second run cache hit: ${{ steps.second-run.outputs.cache-hit }}"
          
          # The second run should be a cache hit
          if [[ "${{ steps.second-run.outputs.cache-hit }}" == "true" ]]; then
            echo "✓ Cache is working correctly!"
          else
            echo "✗ Cache is not working as expected"
            exit 1
          fi