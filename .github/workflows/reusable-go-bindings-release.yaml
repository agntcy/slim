# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

---
name: Reusable Go Bindings Release

on:
  workflow_call:
    inputs:
      library-name:
        description: Name of the library
        required: false
        type: string
        default: slim_bindings
      go-bindings-repo:
        description: Target repository for Go bindings (org/repo format)
        required: false
        type: string
        default: agntcy/slim-bindings-go
      go-version:
        description: Go version to use
        required: false
        type: string
        default: '1.25'
      go-bindings-working-directory:
        description: Working directory for Go bindings
        required: false
        type: string
        default: ./data-plane/bindings/go
    secrets:
      gh-token:
        description: GitHub token for pushing to target repository
        required: true

env:
  LIBRARY_NAME: ${{ inputs.library-name }}
  GO_BINDINGS_REPO: ${{ inputs.go-bindings-repo }}
  FILES_TO_RELEASE: cmd slimrpc go.mod go.sum LICENSE README.md SLIMRPC.md slim_bindings.go slim_bindings.h
  TAG: slim-bindings-v1.1.1

jobs:
  # ==========================================================================
  # Job 1: Generate and publish Go bindings to pre-release branch
  # ==========================================================================
  release-go-bindings:
    name: Release Go Bindings
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.go-bindings-working-directory }}
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          ref: slim-bindings-v1.1.0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          workspace: ./data-plane

      # Download all library artifacts
      - name: Download Generated Go Binding Artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: "21987890035"
          github-token: ${{ secrets.gh-token }}
          merge-multiple: true
          path: ${{ inputs.go-bindings-working-directory }}/downloaded_slim_bindings

      - name: List downloaded go binding artifacts
        run: |
          echo "üì¶ Downloaded artifacts:"
          find ./downloaded_slim_bindings -type f -ls

      - name: Clone target repository
        run: |
          git clone https://x-access-token:${{ secrets.gh-token }}@github.com/${{ env.GO_BINDINGS_REPO }}.git ./target-repo

      - name: Update target repository
        run: |
          pushd ./target-repo

          # Copy Go bindings
          cp -r ../downloaded_slim_bindings/* ./

          # Show what will be committed
          echo "üìã Files to be committed:"
          git status

          popd

      - name: Commit and push to pre-release branch
        run: |
          pushd ./target-repo

          # Extract version from tag name (remove 'slim-bindings-' prefix)
          VERSION="${TAG}"
          VERSION="${VERSION#slim-bindings-}"
          echo "üì¶ Extracted version: $VERSION"

          # Create pre-release branch name
          PRE_RELEASE_BRANCH="pre-release-$VERSION"
          echo "üåø Pre-release branch: $PRE_RELEASE_BRANCH"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add ${{ env.FILES_TO_RELEASE }}

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "‚úÖ No changes to commit - bindings are up-to-date"
            exit 0
          fi

          git commit -m "Release $VERSION

          Generated from https://github.com/${{ github.repository }}/tree/${TAG}

          Platforms:
          - linux/amd64 (x86_64-unknown-linux-gnu)
          - linux/arm64 (aarch64-unknown-linux-gnu)
          - linux/amd64-musl (x86_64-unknown-linux-musl)
          - linux/arm64-musl (aarch64-unknown-linux-musl)
          - darwin/arm64 (aarch64-apple-darwin)
          - darwin/amd64 (x86_64-apple-darwin)
          - windows/amd64 (x86_64-pc-windows-msvc)"

          # Create pre-release tag so Go can resolve by version (not pseudo-version)
          git tag -a "$VERSION" -m "Pre-release $VERSION"

          # Create and push pre-release branch and tag
          git checkout -b "$PRE_RELEASE_BRANCH"
          git push origin "$PRE_RELEASE_BRANCH"
          git push origin "$VERSION"

          echo "‚úÖ Successfully pushed Go bindings to pre-release branch: $PRE_RELEASE_BRANCH"
          echo "‚úÖ Created pre-release tag: $VERSION"

          popd

  # ==========================================================================
  # Job 2: Test the published Go bindings work as expected
  # ==========================================================================
  test-go-bindings:
    name: Test Go Bindings (${{ matrix.platform.target }})
    runs-on: ${{ matrix.platform.runner }}
    needs: release-go-bindings
    strategy:
      fail-fast: false
      matrix:
        platform:
          # Linux x86_64 variants
          - runner: ubuntu-24.04
            os: linux
            target: x86_64-unknown-linux-gnu
          - runner: ubuntu-24.04
            os: linux
            target: x86_64-unknown-linux-musl
          # Linux ARM64 variants (using QEMU emulation)
          - runner: ubuntu-24.04
            os: linux
            target: aarch64-unknown-linux-gnu
            use_qemu: true
          - runner: ubuntu-24.04
            os: linux
            target: aarch64-unknown-linux-musl
            use_qemu: true
          # Windows variants
          - runner: windows-latest
            os: windows
            target: x86_64-pc-windows-msvc
          - runner: windows-latest
            os: windows
            target: x86_64-pc-windows-gnu
          # macOS variants
          - runner: macos-15-intel
            os: macos
            target: x86_64-apple-darwin
          - runner: macos-15
            os: macos
            target: aarch64-apple-darwin
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup QEMU for ARM64 emulation
        if: matrix.platform.use_qemu == true
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}

      - name: Wait for GitHub to update (package propagation)
        run: |
          echo "‚è≥ Waiting 60 seconds for GitHub package index to update..."
          sleep 60

      - name: Test bindings installation and usage (ARM64 with QEMU)
        if: matrix.platform.use_qemu == true
        run: |
          # Extract version from tag name
          VERSION="${TAG}"
          VERSION="${VERSION#slim-bindings-}"
          echo "üì¶ Testing version: $VERSION"
          echo "üñ•Ô∏è  Platform: ${{ matrix.platform.target }}"
          echo "üîß Using QEMU ARM64 emulation"

          # Determine Go arch for ARM64
          if [[ "${{ matrix.platform.target }}" == *"aarch64"* ]]; then
            GO_ARCH="arm64"
          else
            GO_ARCH="amd64"
          fi

          # Determine libc variant
          if [[ "${{ matrix.platform.target }}" == *"musl"* ]]; then
            ALPINE_VARIANT="alpine:latest"
          else
            ALPINE_VARIANT="arm64v8/ubuntu:22.04"
          fi

          # Run test in ARM64 container
          docker run --rm --platform linux/arm64 \
            -v $(pwd):/workspace \
            -v $(pwd):/repo:ro \
            -w /workspace \
            $ALPINE_VARIANT \
            sh -c "
              # Install dependencies
              if command -v apk >/dev/null; then
                apk add --no-cache go git
              else
                apt-get update && apt-get install -y golang git
              fi

              # Create test directory
              TEST_DIR=\$(mktemp -d)
              cd \$TEST_DIR
              echo 'üìÇ Testing in: '\$TEST_DIR

              # Initialize test module
              go mod init test
              echo '‚úÖ Created test module'

              # Fetch bindings
              go get github.com/${{ env.GO_BINDINGS_REPO }}@$VERSION
              echo '‚úÖ Fetched bindings package version $VERSION'

              # Run setup tool
              go run github.com/${{ env.GO_BINDINGS_REPO }}/cmd/slim-bindings-setup@$VERSION
              echo '‚úÖ Downloaded native libraries'

              # Copy test program from repo
              cp /repo/.github/tests/go/test_installation.go main.go

              # Run test
              go run main.go

              echo ''
              echo 'üéâ All tests passed on ${{ matrix.platform.target }}!'
            "

      - name: Test bindings installation and usage (Native)
        if: matrix.platform.use_qemu != true
        run: |
          # Extract version from tag name
          VERSION="${TAG}"
          VERSION="${VERSION#slim-bindings-}"
          echo "üì¶ Testing version: $VERSION"

          # Create a temporary test directory
          if [ "$RUNNER_OS" = "Windows" ]; then
            TEST_DIR=$(mktemp -d -p "$RUNNER_TEMP")
          else
            TEST_DIR=$(mktemp -d)
          fi
          cd "$TEST_DIR"
          echo "üìÇ Testing in: $TEST_DIR"
          echo "üñ•Ô∏è  Platform: ${{ matrix.platform.target }}"
          echo "üèÉ Runner: ${{ matrix.platform.runner }}"

          # For Windows MinGW, we need to ensure MinGW tools are in PATH
          if [[ "${{ matrix.platform.target }}" == "x86_64-pc-windows-gnu" ]]; then
            echo "üîß Setting up MinGW environment"
            # GitHub Windows runners have MinGW installed
            export PATH="/c/ProgramData/chocolatey/lib/mingw/tools/install/mingw64/bin:$PATH"
            gcc --version || echo "‚ö†Ô∏è  MinGW GCC not found in PATH"
          fi

          # Initialize a test Go module
          go mod init test
          echo "‚úÖ Created test module"

          # Fetch the bindings using the version tag
          go get github.com/${{ env.GO_BINDINGS_REPO }}@$VERSION
          echo "‚úÖ Fetched bindings package version $VERSION"

          # Run the setup tool to download native libraries
          go run github.com/${{ env.GO_BINDINGS_REPO }}/cmd/slim-bindings-setup@$VERSION
          echo "‚úÖ Downloaded native libraries"

          # Copy test program from repo
          cp $GITHUB_WORKSPACE/.github/tests/go/test_installation.go main.go

          # Run the test program
          go run main.go

          echo ""
          echo "üéâ All tests passed on ${{ matrix.platform.target }}!"

      - name: Test result summary
        if: success()
        run: |
          echo "‚úÖ Go bindings verification completed successfully on ${{ matrix.platform.target }}"
          echo "The published bindings can be safely tagged for release."

  # ==========================================================================
  # Job 3: Finalize release - merge to main, tag, and cleanup
  # ==========================================================================
  finalize-go-release:
    name: Finalize Release
    runs-on: ubuntu-latest
    needs: test-go-bindings
    steps:
      - name: Clone target repository
        run: |
          git clone https://x-access-token:${{ secrets.gh-token }}@github.com/${{ env.GO_BINDINGS_REPO }}.git ./target-repo

      - name: Merge to main and create tag
        run: |
          cd ./target-repo

          # Set git config locally
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Extract version from tag name
          VERSION="${TAG}"
          VERSION="${VERSION#slim-bindings-}"
          PRE_RELEASE_BRANCH="pre-release-$VERSION"

          echo "üì¶ Version: $VERSION"
          echo "üåø Pre-release branch: $PRE_RELEASE_BRANCH"

          # Fetch the pre-release branch
          git fetch origin "$PRE_RELEASE_BRANCH"

          # Checkout main and merge pre-release branch
          git checkout main
          git merge "origin/$PRE_RELEASE_BRANCH" --ff-only

          # Note: Version tag already exists from Job 1, so we force update it
          # to point to the merged commit on main
          git tag -f -a "$VERSION" -m "Release $VERSION"

          # Push main and tag
          git push origin main
          git push -f origin "$VERSION"

          echo "‚úÖ Merged pre-release branch to main"
          echo "‚úÖ Updated tag $VERSION to point to main"

      - name: Cleanup pre-release branch
        if: always()  # Run even if previous steps fail
        run: |
          cd ./target-repo

          # Extract version from tag name
          VERSION="${TAG}"
          VERSION="${VERSION#slim-bindings-}"
          PRE_RELEASE_BRANCH="pre-release-$VERSION"

          echo "üßπ Cleaning up pre-release artifacts..."

          # Delete the pre-release branch
          if git ls-remote --heads origin "$PRE_RELEASE_BRANCH" | grep -q "$PRE_RELEASE_BRANCH"; then
            git push origin --delete "$PRE_RELEASE_BRANCH" && echo "‚úÖ Deleted pre-release branch: $PRE_RELEASE_BRANCH" || echo "‚ö†Ô∏è  Failed to delete branch"
          else
            echo "‚ÑπÔ∏è  Pre-release branch doesn't exist (may have been deleted already)"
          fi

          # If the merge step failed, we need to delete the tag too
          # (it's pointing to pre-release branch, not main)
          if [ "${{ job.status }}" != "success" ]; then
            echo "‚ö†Ô∏è  Job failed - cleaning up pre-release tag as well"
            if git ls-remote --tags origin "$VERSION" | grep -q "$VERSION"; then
              git push origin --delete "$VERSION" && echo "‚úÖ Deleted pre-release tag: $VERSION" || echo "‚ö†Ô∏è  Failed to delete tag"
            else
              echo "‚ÑπÔ∏è  Tag doesn't exist (may have been deleted already)"
            fi
          fi

          echo "‚úÖ Cleanup complete"

      - name: Release complete
        run: |
          VERSION="${TAG}"
          VERSION="${VERSION#slim-bindings-}"
          echo ""
          echo "üéâ Release $VERSION complete!"
          echo "‚úÖ Go bindings published to https://github.com/${{ env.GO_BINDINGS_REPO }}"
          echo "‚úÖ Tagged as $VERSION"
          echo "‚úÖ All tests passed on 8 platforms"
