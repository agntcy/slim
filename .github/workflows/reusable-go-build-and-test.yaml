# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

---
name: go-build-and-test
on:
  workflow_call:
    inputs:
      runner:
        description: Github hosted runner or Self hosted runner
        required: false
        type: string
        default: ubuntu-latest
      continue-on-error:
        description: Whether to skip the status update for this job
        required: false
        type: boolean
        default: false
      go-version:
        description: Go version to use
        required: false
        type: string
        default: 1.25.5
      go-lint:
        description: Whether to run "task golint"
        required: false
        type: boolean
        default: true
      go-vuln:
        description: Whether to run "task govuln"
        required: false
        type: boolean
        default: true
      go-check-deps:
        description: Whether to check for go mod dependency changes
        required: false
        type: boolean
        default: true
      go-check-gencode:
        description: Whether to check for gencode changes
        required: false
        type: boolean
        default: true
      go-check-multimod:
        description: Whether to check for multimod changes
        required: false
        type: boolean
        default: true
      go-test:
        description: Whether to run "task coverage"
        required: false
        type: boolean
        default: true
      go-test-coverage:
        description: Whether to run "task coverage"
        required: false
        type: boolean
        default: true
      go-cross-build:
        description: Whether to run "task build"
        required: false
        type: boolean
        default: true
      use-local-bindings:
        description: Build bindings locally instead of downloading releases
        required: false
        type: boolean
        default: false
      cgo-enabled:
        description: Whether to enable CGO
        required: false
        type: string
        default: '0'
      go-fips:
        description: Whether to install GoFIPS
        required: false
        type: boolean
        default: false
      upload-artifacts:
        description: Whether to upload build artifacts (for releases)
        required: false
        type: boolean
        default: false
      working-directory:
        description: The working directory to run the task
        required: false
        type: string
        default: .

jobs:
  setup-environment:
    runs-on: ${{ inputs.runner }}

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Go
        id: setup-go
        uses: ./.github/actions/setup-go

      - name: Install dependencies
        if: steps.setup-go.outputs.cache-hit != 'true'
        run: |
          which go
          go env

          task control-plane:fetch

  bindings-cache:
    runs-on: ${{ inputs.runner }}

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    needs: [setup-environment]

    steps:
      - name: Checkout Repo
        if: ${{ inputs.use-local-bindings }}
        uses: actions/checkout@v4

      - name: Setup Go
        if: ${{ inputs.use-local-bindings }}
        uses: ./.github/actions/setup-go

      - name: Set GOPATH
        if: ${{ inputs.use-local-bindings }}
        run: |
          echo "GOPATH=$(go env GOPATH)" >> "$GITHUB_ENV"

      - name: Cache bindings build
        if: ${{ inputs.use-local-bindings }}
        id: bindings-cache
        uses: actions/cache@v4
        with:
          path: ${{ env.GOPATH }}/.cgo-cache/slim-bindings
          key: bindings-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('data-plane/**/Cargo.lock') }}
          restore-keys: |
            bindings-${{ runner.os }}-${{ runner.arch }}-

      - name: Setup Rust
        if: ${{ inputs.use-local-bindings }}
        uses: ./.github/actions/setup-rust
        with:
          workspace: ./data-plane

      - name: Ensure bindings cache
        if: ${{ inputs.use-local-bindings }}
        run: |
          set -euo pipefail

          which go
          go env

          TARGET_OS=$(go env GOOS)
          TARGET_ARCH=$(go env GOARCH)
          TARGET_ABI=""

          case "$TARGET_OS" in
            darwin)
              if [ "$TARGET_ARCH" = "arm64" ]; then
                LIB_ARCH="aarch64"
              else
                LIB_ARCH="x86_64"
              fi
              LIB_NAME="libslim_bindings_${LIB_ARCH}_darwin.a"
              ;;
            linux)
              TARGET_ABI="gnu"
              if [ "$TARGET_ARCH" = "arm64" ]; then
                LIB_ARCH="aarch64"
              else
                LIB_ARCH="x86_64"
              fi
              LIB_NAME="libslim_bindings_${LIB_ARCH}_linux_${TARGET_ABI}.a"
              ;;
            windows)
              TARGET_ABI="gnu"
              if [ "$TARGET_ARCH" != "amd64" ] && [ "$TARGET_ARCH" != "x86_64" ]; then
                echo "❌ Unsupported TARGETARCH for windows: $TARGET_ARCH"
                exit 1
              fi
              LIB_NAME="libslim_bindings_x86_64_windows_${TARGET_ABI}.a"
              ;;
            *)
              echo "❌ Unsupported TARGETOS: $TARGET_OS"
              exit 1
              ;;
          esac

          CACHE_DIR="$(go env GOPATH)/.cgo-cache/slim-bindings"
          LIB_PATH="$CACHE_DIR/$LIB_NAME"

          if [ ! -f "$LIB_PATH" ]; then
            echo "ℹ️  Missing cached bindings ($LIB_NAME); building..."
            task control-plane:go-bindings:install-local \
              TARGETOS="$TARGET_OS" \
              TARGETARCH="$TARGET_ARCH" \
              TARGETABI="$TARGET_ABI"
          fi

          if [ ! -f "$LIB_PATH" ]; then
            echo "❌ Expected cached bindings not found: $LIB_PATH"
            exit 1
          fi

      - name: Generate Go bindings
        if: ${{ inputs.use-local-bindings }}
        run: |
          task -d ../data-plane/bindings/go generate-from-cache \
            TARGETOS=$(go env GOOS) \
            TARGETARCH=$(go env GOARCH)

      - name: Pack bindings cache
        if: ${{ inputs.use-local-bindings }}
        run: |
          CACHE_DIR="$(go env GOPATH)/.cgo-cache"
          tar -czf /tmp/slim-bindings-cache.tgz -C "$CACHE_DIR" slim-bindings

      - name: Pack Go bindings
        if: ${{ inputs.use-local-bindings }}
        run: |
          tar -czf /tmp/slim-bindings-go-src.tgz \
            -C ../data-plane/bindings/go/slim_bindings \
            slim_bindings.go slim_bindings.h

      - name: Upload bindings cache
        if: ${{ inputs.use-local-bindings }}
        uses: actions/upload-artifact@v4
        with:
          name: slim-bindings-cache
          path: /tmp/slim-bindings-cache.tgz

      - name: Upload Go bindings
        if: ${{ inputs.use-local-bindings }}
        uses: actions/upload-artifact@v4
        with:
          name: slim-bindings-go-src
          path: /tmp/slim-bindings-go-src.tgz

  build:
    runs-on: ${{ inputs.runner }}

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    if: ${{ inputs.go-test || inputs.go-test-coverage || inputs.go-cross-build }}

    needs: [setup-environment, bindings-cache]

    env:
      USE_LOCAL_BINDINGS: ${{ inputs.use-local-bindings && 'true' || 'false' }}
      CGO_ENABLED: ${{ inputs.use-local-bindings && '1' || inputs.cgo-enabled }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: ./.github/actions/setup-go

      - name: Restore bindings cache
        if: ${{ inputs.use-local-bindings }}
        uses: actions/download-artifact@v4
        with:
          name: slim-bindings-cache
          path: /tmp

      - name: Restore Go bindings
        if: ${{ inputs.use-local-bindings }}
        uses: actions/download-artifact@v4
        with:
          name: slim-bindings-go-src
          path: /tmp

      - name: Restore bindings cache
        if: ${{ inputs.use-local-bindings }}
        uses: actions/download-artifact@v4
        with:
          name: slim-bindings-cache
          path: /tmp

      - name: Restore Go bindings
        if: ${{ inputs.use-local-bindings }}
        uses: actions/download-artifact@v4
        with:
          name: slim-bindings-go-src
          path: /tmp

      - name: Restore bindings cache
        if: ${{ inputs.use-local-bindings }}
        uses: actions/download-artifact@v4
        with:
          name: slim-bindings-cache
          path: /tmp

      - name: Restore Go bindings
        if: ${{ inputs.use-local-bindings }}
        uses: actions/download-artifact@v4
        with:
          name: slim-bindings-go-src
          path: /tmp

      - name: Build
        env:
          CGO_ENABLED: ${{ inputs.use-local-bindings && '1' || inputs.cgo-enabled }}
        run: |
          which go
          go env

          if [ "$USE_LOCAL_BINDINGS" = "true" ] && [ -f /tmp/slim-bindings-cache.tgz ]; then
            CACHE_DIR="$(go env GOPATH)/.cgo-cache"
            mkdir -p "$CACHE_DIR"
            tar -xzf /tmp/slim-bindings-cache.tgz -C "$CACHE_DIR"

            REPO_ROOT="$(git rev-parse --show-toplevel)"
            REPO_CACHE="$REPO_ROOT/../.cgo-cache"
            if [ -d "$CACHE_DIR/slim-bindings" ]; then
              mkdir -p "$REPO_CACHE"
              cp -a "$CACHE_DIR/slim-bindings" "$REPO_CACHE/"
            fi
          fi

          if [ "$USE_LOCAL_BINDINGS" = "true" ] && [ -f /tmp/slim-bindings-go-src.tgz ]; then
            tar -xzf /tmp/slim-bindings-go-src.tgz \
              -C ../data-plane/bindings/go/slim_bindings
          fi

          CGO_ENABLED="$CGO_ENABLED" task control-plane:build USE_LOCAL_BINDINGS=$USE_LOCAL_BINDINGS

  lint:
    runs-on: ${{ inputs.runner }}

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    if: ${{ inputs.go-lint }}

    needs: [setup-environment, bindings-cache]

    env:
      USE_LOCAL_BINDINGS: ${{ inputs.use-local-bindings && 'true' || 'false' }}
      CGO_ENABLED: ${{ inputs.use-local-bindings && '1' || inputs.cgo-enabled }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: ./.github/actions/setup-go

      - name: Restore bindings cache
        if: ${{ inputs.use-local-bindings }}
        uses: actions/download-artifact@v4
        with:
          name: slim-bindings-cache
          path: /tmp

      - name: Restore Go bindings
        if: ${{ inputs.use-local-bindings }}
        uses: actions/download-artifact@v4
        with:
          name: slim-bindings-go-src
          path: /tmp

      - name: golint
        env:
          CGO_ENABLED: ${{ inputs.use-local-bindings && '1' || inputs.cgo-enabled }}
        run: |
          which go
          go env

          if [ "$USE_LOCAL_BINDINGS" = "true" ] && [ -f /tmp/slim-bindings-cache.tgz ]; then
            CACHE_DIR="$(go env GOPATH)/.cgo-cache"
            mkdir -p "$CACHE_DIR"
            tar -xzf /tmp/slim-bindings-cache.tgz -C "$CACHE_DIR"

            REPO_ROOT="$(git rev-parse --show-toplevel)"
            REPO_CACHE="$REPO_ROOT/../.cgo-cache"
            if [ -d "$CACHE_DIR/slim-bindings" ]; then
              mkdir -p "$REPO_CACHE"
              cp -a "$CACHE_DIR/slim-bindings" "$REPO_CACHE/"
            fi
          fi

          if [ "$USE_LOCAL_BINDINGS" = "true" ] && [ -f /tmp/slim-bindings-go-src.tgz ]; then
            tar -xzf /tmp/slim-bindings-go-src.tgz \
              -C ../data-plane/bindings/go/slim_bindings
          fi

          CGO_ENABLED="$CGO_ENABLED" task control-plane:go-bindings:setup \
            TARGETOS=$(go env GOOS) \
            TARGETARCH=$(go env GOARCH) \
            USE_LOCAL_BINDINGS=$USE_LOCAL_BINDINGS

          CGO_ENABLED="$CGO_ENABLED" task control-plane:lint control-plane:impi

  govulncheck:
    runs-on: ${{ inputs.runner }}

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    if: ${{ inputs.go-vuln }}

    needs: [setup-environment, bindings-cache]

    env:
      USE_LOCAL_BINDINGS: ${{ inputs.use-local-bindings && 'true' || 'false' }}
      CGO_ENABLED: ${{ inputs.use-local-bindings && '1' || inputs.cgo-enabled }}

    timeout-minutes: 30
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: ./.github/actions/setup-go

      - name: Restore bindings cache
        if: ${{ inputs.use-local-bindings }}
        uses: actions/download-artifact@v4
        with:
          name: slim-bindings-cache
          path: /tmp

      - name: Restore Go bindings
        if: ${{ inputs.use-local-bindings }}
        uses: actions/download-artifact@v4
        with:
          name: slim-bindings-go-src
          path: /tmp

      - name: Run `govuln`
        env:
          CGO_ENABLED: ${{ inputs.use-local-bindings && '1' || inputs.cgo-enabled }}
        run: |
          which go
          go env

          if [ "$USE_LOCAL_BINDINGS" = "true" ] && [ -f /tmp/slim-bindings-cache.tgz ]; then
            CACHE_DIR="$(go env GOPATH)/.cgo-cache"
            mkdir -p "$CACHE_DIR"
            tar -xzf /tmp/slim-bindings-cache.tgz -C "$CACHE_DIR"

            REPO_ROOT="$(git rev-parse --show-toplevel)"
            REPO_CACHE="$REPO_ROOT/../.cgo-cache"
            if [ -d "$CACHE_DIR/slim-bindings" ]; then
              mkdir -p "$REPO_CACHE"
              cp -a "$CACHE_DIR/slim-bindings" "$REPO_CACHE/"
            fi
          fi

          if [ "$USE_LOCAL_BINDINGS" = "true" ] && [ -f /tmp/slim-bindings-go-src.tgz ]; then
            tar -xzf /tmp/slim-bindings-go-src.tgz \
              -C ../data-plane/bindings/go/slim_bindings
          fi

          CGO_ENABLED="$CGO_ENABLED" task control-plane:go-bindings:setup \
            TARGETOS=$(go env GOOS) \
            TARGETARCH=$(go env GOARCH) \
            USE_LOCAL_BINDINGS=$USE_LOCAL_BINDINGS

          CGO_ENABLED="$CGO_ENABLED" task control-plane:vuln

  unittest-matrix:
    runs-on: ${{ inputs.runner }}

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    if: ${{ inputs.go-test }}
    needs: [setup-environment, bindings-cache, build]
    env:
      USE_LOCAL_BINDINGS: ${{ inputs.use-local-bindings && 'true' || 'false' }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: ./.github/actions/setup-go

      - name: Restore bindings cache
        if: ${{ inputs.use-local-bindings }}
        uses: actions/download-artifact@v4
        with:
          name: slim-bindings-cache
          path: /tmp

      - name: Restore Go bindings
        if: ${{ inputs.use-local-bindings }}
        uses: actions/download-artifact@v4
        with:
          name: slim-bindings-go-src
          path: /tmp

      - name: Cache Build
        uses: actions/cache@v4
        with:
          path: ~/.cache/go-build
          key: unittest-${{ runner.os }}-go-build-${{ hashFiles('**/go.sum') }}
      - name: Run Unit Tests
        run: |
          which go
          go env

          if [ "$USE_LOCAL_BINDINGS" = "true" ] && [ -f /tmp/slim-bindings-cache.tgz ]; then
            CACHE_DIR="$(go env GOPATH)/.cgo-cache"
            mkdir -p "$CACHE_DIR"
            tar -xzf /tmp/slim-bindings-cache.tgz -C "$CACHE_DIR"

            REPO_ROOT="$(git rev-parse --show-toplevel)"
            REPO_CACHE="$REPO_ROOT/../.cgo-cache"
            if [ -d "$CACHE_DIR/slim-bindings" ]; then
              mkdir -p "$REPO_CACHE"
              cp -a "$CACHE_DIR/slim-bindings" "$REPO_CACHE/"
            fi
          fi

          if [ "$USE_LOCAL_BINDINGS" = "true" ] && [ -f /tmp/slim-bindings-go-src.tgz ]; then
            tar -xzf /tmp/slim-bindings-go-src.tgz \
              -C ../data-plane/bindings/go/slim_bindings
            export CGO_ENABLED=1
          fi

          task control-plane:test

  unittest:
    runs-on: ${{ inputs.runner }}

    if: ${{ inputs.go-test }}

    needs: [setup-environment, unittest-matrix]
    steps:
      - name: Print result
        run: echo ${{ needs.unittest-matrix.result }}
      - name: Interpret result
        run: |
          if [[ "success" == "${{ needs.unittest-matrix.result }}" ]]
          then
            echo "All matrix jobs passed!"
          else
            echo "One or more matrix jobs failed."
            false
          fi

  test-coverage:
    runs-on: ${{ inputs.runner }}

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    if: ${{ inputs.go-test-coverage }}

    needs: [setup-environment, bindings-cache, build]

    env:
      USE_LOCAL_BINDINGS: ${{ inputs.use-local-bindings && 'true' || 'false' }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: ./.github/actions/setup-go

      - name: Restore bindings cache
        if: ${{ inputs.use-local-bindings }}
        uses: actions/download-artifact@v4
        with:
          name: slim-bindings-cache
          path: /tmp

      - name: Restore Go bindings
        if: ${{ inputs.use-local-bindings }}
        uses: actions/download-artifact@v4
        with:
          name: slim-bindings-go-src
          path: /tmp

      - name: Cache Build
        uses: actions/cache@v4
        with:
          path: ~/.cache/go-build
          key: coverage-${{ runner.os }}-go-build-${{ hashFiles('**/go.sum') }}

      - name: Run Unit Tests With Coverage
        run: |
          which go
          go env

          if [ "$USE_LOCAL_BINDINGS" = "true" ] && [ -f /tmp/slim-bindings-cache.tgz ]; then
            CACHE_DIR="$(go env GOPATH)/.cgo-cache"
            mkdir -p "$CACHE_DIR"
            tar -xzf /tmp/slim-bindings-cache.tgz -C "$CACHE_DIR"

            REPO_ROOT="$(git rev-parse --show-toplevel)"
            REPO_CACHE="$REPO_ROOT/../.cgo-cache"
            if [ -d "$CACHE_DIR/slim-bindings" ]; then
              mkdir -p "$REPO_CACHE"
              cp -a "$CACHE_DIR/slim-bindings" "$REPO_CACHE/"
            fi
          fi

          if [ "$USE_LOCAL_BINDINGS" = "true" ] && [ -f /tmp/slim-bindings-go-src.tgz ]; then
            tar -xzf /tmp/slim-bindings-go-src.tgz \
              -C ../data-plane/bindings/go/slim_bindings
            export CGO_ENABLED=1
          fi

          task control-plane:coverage

  cross-build:
    runs-on: ${{ matrix.runner }}

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    if: ${{ inputs.go-cross-build }}

    needs: [setup-environment, bindings-cache, build]

    env:
      USE_LOCAL_BINDINGS: ${{ inputs.use-local-bindings && 'true' || 'false' }}

    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds
          - os: linux
            arch: amd64
            runner: ubuntu-latest
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm
          # macOS builds - use native runners for better performance
          - os: darwin
            arch: amd64
            runner: macos-15-intel  # Intel macOS
          - os: darwin
            arch: arm64
            runner: macos-15  # Apple Silicon macOS
          # Windows builds
          - os: windows
            arch: amd64
            runner: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: ./.github/actions/setup-go

      - name: Restore bindings cache
        if: ${{ inputs.use-local-bindings }}
        uses: actions/download-artifact@v4
        with:
          name: slim-bindings-cache
          path: /tmp

      - name: Restore Go bindings
        if: ${{ inputs.use-local-bindings }}
        uses: actions/download-artifact@v4
        with:
          name: slim-bindings-go-src
          path: /tmp

      - name: Setup Rust
        if: ${{ inputs.use-local-bindings }}
        uses: ./.github/actions/setup-rust
        with:
          workspace: ./data-plane

      - name: Check go executable
        run: |
          which go
      - name: Build
        env:
          GOOS: ${{matrix.os}}
          GOARCH: ${{matrix.arch}}
          CGO_ENABLED: ${{ inputs.use-local-bindings && '1' || inputs.cgo-enabled }}
        run: |
          which go
          go env

          if [ "$USE_LOCAL_BINDINGS" = "true" ] && [ -f /tmp/slim-bindings-cache.tgz ]; then
            CACHE_DIR="$(go env GOPATH)/.cgo-cache"
            mkdir -p "$CACHE_DIR"
            tar -xzf /tmp/slim-bindings-cache.tgz -C "$CACHE_DIR"

            REPO_ROOT="$(git rev-parse --show-toplevel)"
            REPO_CACHE="$REPO_ROOT/../.cgo-cache"
            if [ -d "$CACHE_DIR/slim-bindings" ]; then
              mkdir -p "$REPO_CACHE"
              cp -a "$CACHE_DIR/slim-bindings" "$REPO_CACHE/"
            fi
          fi

          if [ "$USE_LOCAL_BINDINGS" = "true" ] && [ -f /tmp/slim-bindings-go-src.tgz ]; then
            tar -xzf /tmp/slim-bindings-go-src.tgz \
              -C ../data-plane/bindings/go/slim_bindings
          fi

          task control-plane:build USE_LOCAL_BINDINGS=$USE_LOCAL_BINDINGS

      - name: Upload slimctl artifact
        if: ${{ inputs.upload-artifacts }}
        uses: actions/upload-artifact@v4
        with:
          name: slimctl-${{ matrix.os }}-${{ matrix.arch }}
          path: .dist/bin/slimctl${{ matrix.os == 'windows' && '.exe' || '' }}
          if-no-files-found: error
          retention-days: 1
