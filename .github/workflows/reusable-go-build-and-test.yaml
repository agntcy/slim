# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

---
name: go-build-and-test
on:
  workflow_call:
    inputs:
      runner:
        description: Github hosted runner or Self hosted runner
        required: false
        type: string
        default: ubuntu-latest
      continue-on-error:
        description: Whether to skip the status update for this job
        required: false
        type: boolean
        default: false
      go-version:
        description: Go version to use
        required: false
        type: string
        default: 1.25.5
      go-lint:
        description: Whether to run "task golint"
        required: false
        type: boolean
        default: true
      go-vuln:
        description: Whether to run "task govuln"
        required: false
        type: boolean
        default: true
      go-check-deps:
        description: Whether to check for go mod dependency changes
        required: false
        type: boolean
        default: true
      go-check-gencode:
        description: Whether to check for gencode changes
        required: false
        type: boolean
        default: true
      go-check-multimod:
        description: Whether to check for multimod changes
        required: false
        type: boolean
        default: true
      go-test:
        description: Whether to run "task coverage"
        required: false
        type: boolean
        default: true
      go-test-coverage:
        description: Whether to run "task coverage"
        required: false
        type: boolean
        default: true
      go-cross-build:
        description: Whether to run "task build"
        required: false
        type: boolean
        default: true
      use-local-bindings:
        description: Build bindings locally instead of downloading releases
        required: false
        type: boolean
        default: false
      cgo-enabled:
        description: Whether to enable CGO
        required: false
        type: string
        default: '0'
      go-fips:
        description: Whether to install GoFIPS
        required: false
        type: boolean
        default: false
      upload-artifacts:
        description: Whether to upload build artifacts (for releases)
        required: false
        type: boolean
        default: false
      working-directory:
        description: The working directory to run the task
        required: false
        type: string
        default: .

jobs:
  setup-environment:
    runs-on: ${{ inputs.runner }}

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Go
        id: setup-go
        uses: ./.github/actions/setup-go

      - name: Install dependencies
        if: steps.setup-go.outputs.cache-hit != 'true'
        run: |
          which go
          go env

          task control-plane:fetch

  lint:
    runs-on: ${{ inputs.runner }}

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    if: ${{ inputs.go-lint }}

    needs: [setup-environment]

    env:
      USE_LOCAL_BINDINGS: ${{ inputs.use-local-bindings && 'true' || 'false' }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: ./.github/actions/setup-go

      - name: Setup Rust
        if: ${{ inputs.use-local-bindings }}
        uses: ./.github/actions/setup-rust
        with:
          workspace: ./data-plane

      - name: golint
        run: |
          which go
          go env

          task control-plane:go-bindings:setup \
            TARGETOS=$(go env GOOS) \
            TARGETARCH=$(go env GOARCH) \
            USE_LOCAL_BINDINGS=$USE_LOCAL_BINDINGS

          task control-plane:lint control-plane:impi

  govulncheck:
    runs-on: ${{ inputs.runner }}

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    if: ${{ inputs.go-vuln }}

    needs: [setup-environment]

    env:
      USE_LOCAL_BINDINGS: ${{ inputs.use-local-bindings && 'true' || 'false' }}

    timeout-minutes: 30
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: ./.github/actions/setup-go

      - name: Setup Rust
        if: ${{ inputs.use-local-bindings }}
        uses: ./.github/actions/setup-rust
        with:
          workspace: ./data-plane

      - name: Run `govuln`
        run: |
          which go
          go env

          task control-plane:go-bindings:setup \
            TARGETOS=$(go env GOOS) \
            TARGETARCH=$(go env GOARCH) \
            USE_LOCAL_BINDINGS=$USE_LOCAL_BINDINGS

          task control-plane:vuln

  unittest-matrix:
    runs-on: ${{ inputs.runner }}

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    if: ${{ inputs.go-test }}
    needs: [setup-environment]
    env:
      USE_LOCAL_BINDINGS: ${{ inputs.use-local-bindings && 'true' || 'false' }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: ./.github/actions/setup-go

      - name: Cache Build
        uses: actions/cache@v4
        with:
          path: ~/.cache/go-build
          key: unittest-${{ runner.os }}-go-build-${{ hashFiles('**/go.sum') }}
      - name: Run Unit Tests
        run: |
          which go
          go env

          task control-plane:test

  unittest:
    runs-on: ${{ inputs.runner }}

    if: ${{ inputs.go-test }}

    needs: [setup-environment, unittest-matrix]
    steps:
      - name: Print result
        run: echo ${{ needs.unittest-matrix.result }}
      - name: Interpret result
        run: |
          if [[ "success" == "${{ needs.unittest-matrix.result }}" ]]
          then
            echo "All matrix jobs passed!"
          else
            echo "One or more matrix jobs failed."
            false
          fi

  test-coverage:
    runs-on: ${{ inputs.runner }}

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    if: ${{ inputs.go-test-coverage }}

    needs: [setup-environment]

    env:
      USE_LOCAL_BINDINGS: ${{ inputs.use-local-bindings && 'true' || 'false' }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: ./.github/actions/setup-go

      - name: Cache Build
        uses: actions/cache@v4
        with:
          path: ~/.cache/go-build
          key: coverage-${{ runner.os }}-go-build-${{ hashFiles('**/go.sum') }}

      - name: Run Unit Tests With Coverage
        run: |
          which go
          go env

          task control-plane:coverage

  cross-build:
    runs-on: ${{ matrix.runner }}

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    if: ${{ inputs.go-cross-build }}

    needs: [setup-environment]

    env:
      USE_LOCAL_BINDINGS: ${{ inputs.use-local-bindings && 'true' || 'false' }}

    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds
          - os: linux
            arch: amd64
            runner: ubuntu-latest
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm
          # macOS builds - use native runners for better performance
          - os: darwin
            arch: amd64
            runner: macos-15-intel  # Intel macOS
          - os: darwin
            arch: arm64
            runner: macos-15  # Apple Silicon macOS
          # Windows builds
          - os: windows
            arch: amd64
            runner: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: ./.github/actions/setup-go

      - name: Setup Rust
        if: ${{ inputs.use-local-bindings }}
        uses: ./.github/actions/setup-rust
        with:
          workspace: ./data-plane

      - name: Check go executable
        run: |
          which go
      - name: Build
        env:
          GOOS: ${{matrix.os}}
          GOARCH: ${{matrix.arch}}
          CGO_ENABLED: ${{ inputs.cgo-enabled }}
        run: |
          which go
          go env

          task control-plane:build USE_LOCAL_BINDINGS=$USE_LOCAL_BINDINGS

      - name: Upload slimctl artifact
        if: ${{ inputs.upload-artifacts }}
        uses: actions/upload-artifact@v4
        with:
          name: slimctl-${{ matrix.os }}-${{ matrix.arch }}
          path: .dist/bin/slimctl${{ matrix.os == 'windows' && '.exe' || '' }}
          if-no-files-found: error
          retention-days: 1
