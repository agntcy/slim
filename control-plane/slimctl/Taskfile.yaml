version: '3'

# Taskfile for slimctl
# Run from control-plane/slimctl directory or use: task -d control-plane/slimctl <task-name>

vars:
  # Binary location relative to this Taskfile (control-plane/slimctl/)
  SLIMCTL_BIN: ../../.dist/bin/slimctl
  TESTDATA_DIR: testdata
  TEST_CERTS_DIR: testdata/certs
  COVERAGE_FILE: coverage.out
  COVERAGE_HTML: coverage.html

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list
    silent: true

  help:manual:
    desc: Show manual testing help
    cmds:
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘     SLIM Manual Testing Guide                     â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - echo "ðŸŽ¯ Quick Start:"
      - echo "  task test:manual           - Complete guided workflow"
      - echo "  task test:manual:insecure  - Test insecure mode"
      - echo "  task test:manual:tls       - Test TLS mode"
      - echo "  task test:manual:quick     - Quick insecure test"
      - echo ""
      - echo "ðŸ“‹ Step-by-step:"
      - echo "  1. task setup:test-env     - Setup certs & configs"
      - echo "  2. Build binary            - cd ../.. && task -d control-plane slimctl:build"
      - echo "  3. task test:manual:tls    - Run TLS test"
      - echo ""
      - echo "ðŸ”§ Custom testing:"
      - echo "  task test:manual:custom CONFIG=my-config.yaml"
      - echo ""
      - echo "ðŸ§¹ Cleanup:"
      - echo "  task clean                 - Remove test files"
      - echo "  task clean:all             - Remove everything + binary"
      - echo ""
      - echo "For full command list - task --list"
    silent: true

  # Testing tasks (manual testing only - no unit tests currently)
  test:
    desc: Run manual tests (use test:manual for guided workflow)
    cmds:
      - task: test:manual

  # Certificate generation tasks
  certs:setup:
    desc: Generate test TLS certificates (X.509 v3)
    cmds:
      - task: certs:clean
      - task: certs:generate
      - task: certs:verify
    silent: false

  certs:generate:
    desc: Generate X.509 v3 certificates
    cmds:
      - echo "ðŸ” Generating test certificates..."
      - mkdir -p {{.TEST_CERTS_DIR}}
      - |
        # Generate private key
        openssl genrsa -out {{.TEST_CERTS_DIR}}/server-key.pem 2048 2>/dev/null
      - |
        # Create OpenSSL config for v3 extensions
        cat > {{.TEST_CERTS_DIR}}/openssl.cnf <<'EOF'
        [req]
        default_bits = 2048
        prompt = no
        default_md = sha256
        distinguished_name = dn
        x509_extensions = v3_req

        [dn]
        C = US
        ST = Test
        L = Test
        O = Test Organization
        CN = localhost

        [v3_req]
        subjectAltName = @alt_names
        basicConstraints = CA:FALSE
        keyUsage = digitalSignature, keyEncipherment
        extendedKeyUsage = serverAuth

        [alt_names]
        DNS.1 = localhost
        DNS.2 = *.localhost
        IP.1 = 127.0.0.1
        IP.2 = ::1
        EOF
        
        # Generate X.509 v3 certificate
        openssl req -new -x509 -key {{.TEST_CERTS_DIR}}/server-key.pem \
          -out {{.TEST_CERTS_DIR}}/server-cert.pem -days 365 \
          -config {{.TEST_CERTS_DIR}}/openssl.cnf \
          -extensions v3_req 2>/dev/null
        
        # Clean up config file
        rm {{.TEST_CERTS_DIR}}/openssl.cnf
        
        echo "âœ… Certificates generated in {{.TEST_CERTS_DIR}}/"
    silent: false
    status:
      - test -f {{.TEST_CERTS_DIR}}/server-cert.pem
      - test -f {{.TEST_CERTS_DIR}}/server-key.pem

  certs:verify:
    desc: Verify certificate version and details
    cmds:
      - |
        echo "ðŸ” Verifying certificate..."
        CERT_VERSION=$(openssl x509 -in {{.TEST_CERTS_DIR}}/server-cert.pem -noout -text | grep "Version:" | sed 's/.*Version: \([0-9]\).*/\1/')
        if [ "$CERT_VERSION" = "3" ]; then
          echo "   âœ… Certificate version: v3 (compatible with rustls)"
        else
          echo "   âŒ Warning: Certificate version v$CERT_VERSION may not be compatible"
          exit 1
        fi
      - echo "   Certificate details:"
      - openssl x509 -in {{.TEST_CERTS_DIR}}/server-cert.pem -noout -subject -dates
    silent: false
    preconditions:
      - test -f {{.TEST_CERTS_DIR}}/server-cert.pem

  certs:clean:
    desc: Remove test certificates
    cmds:
      - echo "ðŸ§¹ Cleaning test certificates..."
      - rm -rf {{.TEST_CERTS_DIR}}
      - echo "âœ… Certificates removed"
    silent: false

  certs:info:
    desc: Show certificate information
    cmds:
      - echo "ðŸ“œ Certificate Information:"
      - openssl x509 -in {{.TEST_CERTS_DIR}}/server-cert.pem -noout -text
    silent: false
    preconditions:
      - test -f {{.TEST_CERTS_DIR}}/server-cert.pem

  # Test configuration tasks
  configs:setup:
    desc: Generate test configuration files
    cmds:
      - echo "ðŸ“ Creating test configuration files..."
      - task: configs:insecure
      - task: configs:tls
      - echo "âœ… Test configuration files created"
    silent: false

  configs:insecure:
    desc: Create insecure test config
    cmds:
      - mkdir -p {{.TESTDATA_DIR}}
      - |
        cat > {{.TESTDATA_DIR}}/test-insecure.yaml <<'EOF'
        # Copyright AGNTCY Contributors (https://github.com/agntcy)
        # SPDX-License-Identifier: Apache-2.0
        
        # Test configuration - Insecure mode
        # This mirrors the production SLIM configuration format
        
        runtime:
          n_cores: 0  # 0 means use all available cores
          thread_name: "slimctl-worker"
          drain_timeout: 10s
        
        tracing:
          log_level: info
          display_thread_names: true
          display_thread_ids: true
        
        services:
          slim/0:
            dataplane:
              servers:
                - endpoint: "127.0.0.1:9090"
                  tls:
                    insecure: true
              clients: []
        EOF
        echo "   Created: {{.TESTDATA_DIR}}/test-insecure.yaml"
    silent: false

  configs:tls:
    desc: Create TLS test config
    cmds:
      - mkdir -p {{.TESTDATA_DIR}}
      - |
        cat > {{.TESTDATA_DIR}}/test-tls.yaml <<'EOF'
        # Copyright AGNTCY Contributors (https://github.com/agntcy)
        # SPDX-License-Identifier: Apache-2.0
        
        # Test configuration - TLS enabled
        # This mirrors the production SLIM configuration format
        
        runtime:
          n_cores: 0  # 0 means use all available cores
          thread_name: "slimctl-worker"
          drain_timeout: 10s
        
        tracing:
          log_level: debug  # Debug level for TLS troubleshooting
          display_thread_names: true
          display_thread_ids: true
        
        services:
          slim/0:
            dataplane:
              servers:
                - endpoint: "127.0.0.1:8443"
                  tls:
                    source:
                      type: file
                      cert: "testdata/certs/server-cert.pem"
                      key: "testdata/certs/server-key.pem"
              clients: []
        EOF
        echo "   Created: {{.TESTDATA_DIR}}/test-tls.yaml"
    silent: false

  configs:env-override:
    desc: Create env-override test config with environment variable placeholders
    cmds:
      - mkdir -p {{.TESTDATA_DIR}}
      - |
        cat > {{.TESTDATA_DIR}}/test-env-override.yaml <<'EOF'
        # Copyright AGNTCY Contributors (https://github.com/agntcy)
        # SPDX-License-Identifier: Apache-2.0
        
        # Test configuration with env var placeholders
        runtime:
          n_cores: 0
          thread_name: "slim-worker"
          drain_timeout: 10s
        
        tracing:
          log_level: info
          display_thread_names: true
          display_thread_ids: true
        
        services:
          slim/0:
            dataplane:
              servers:
                - endpoint: "${env:SLIM_ENDPOINT:-127.0.0.1:9090}"
                  tls:
                    insecure: "${env:SLIM_TLS_INSECURE:-true}"
              clients: []
        EOF
        echo "   Created: {{.TESTDATA_DIR}}/test-env-override.yaml"
    silent: false

  configs:clean:
    desc: Remove test configuration files
    cmds:
      - echo "ðŸ§¹ Cleaning test configuration files..."
      - rm -f {{.TESTDATA_DIR}}/test-insecure.yaml {{.TESTDATA_DIR}}/test-tls.yaml {{.TESTDATA_DIR}}/test-env-override.yaml
      - echo "âœ… Test configs removed"
    silent: false

  # Setup tasks
  setup:test-env:
    desc: Complete test environment setup (certificates + configs)
    cmds:
      - echo "ðŸ”§ Setting up test environment..."
      - task: certs:setup
      - task: configs:setup
      - echo ""
      - echo "âœ… Test environment ready!"
      - echo ""
      - echo "You can now test with:"
      - echo "  â€¢ task run:insecure"
      - echo "  â€¢ task run:tls"
      - echo "  â€¢ {{.SLIMCTL_BIN}} slim start --config {{.TESTDATA_DIR}}/test-insecure.yaml"
      - echo ""
    silent: false

  # Manual testing tasks
  test:manual:
    desc: Complete manual testing workflow (setup + run)
    cmds:
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘     SLIM Manual Testing Workflow                  â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - echo "ðŸ“‹ Step 1/4 - Setting up test environment..."
      - task: setup:test-env
      - echo ""
      - echo "ðŸ“‹ Step 2/4 - Verifying binary..."
      - task: verify:binary
      - echo ""
      - echo "ðŸ“‹ Step 3/4 - Environment ready!"
      - echo ""
      - echo "Available test scenarios:"
      - echo "  1ï¸âƒ£  Insecure mode - task test:manual:insecure"
      - echo "  2ï¸âƒ£  TLS mode - task test:manual:tls"
      - echo "  3ï¸âƒ£  Custom config - task test:manual:custom CONFIG=path/to/config.yaml"
      - echo ""
      - echo "Or run directly:"
      - echo "  {{.SLIMCTL_BIN}} slim start --endpoint 127.0.0.1:9090 --insecure"
      - echo "  {{.SLIMCTL_BIN}} slim start --config {{.TESTDATA_DIR}}/test-tls.yaml"
      - echo ""
      - echo "ðŸ“‹ Step 4/4 - Choose a test scenario above and run it! ðŸš€"
    silent: false

  test:manual:insecure:
    desc: Manual test - Run insecure mode workflow
    deps:
      - setup:test-env
      - verify:binary
    cmds:
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘     Manual Test - Insecure Mode                   â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - echo "ðŸ“Š Test Configuration:"
      - echo "  â€¢ Mode - Insecure (no TLS)"
      - echo "  â€¢ Endpoint - 127.0.0.1:9090"
      - echo "  â€¢ Config - CLI flags only"
      - echo ""
      - echo "ðŸš€ Starting server..."
      - echo "   (Press Ctrl+C to stop)"
      - echo ""
      - "{{.SLIMCTL_BIN}} slim start --endpoint 127.0.0.1:9090 --insecure"
    silent: false

  test:manual:tls:
    desc: Manual test - Run TLS mode workflow
    deps:
      - setup:test-env
      - verify:binary
    cmds:
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘     Manual Test - TLS Mode                        â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - echo "ðŸ“Š Test Configuration:"
      - echo "  â€¢ Mode - TLS enabled"
      - echo "  â€¢ Endpoint - 127.0.0.1:8443"
      - echo "  â€¢ Config file - {{.TESTDATA_DIR}}/test-tls.yaml"
      - echo "  â€¢ Certificate - {{.TEST_CERTS_DIR}}/server-cert.pem"
      - echo "  â€¢ Key - {{.TEST_CERTS_DIR}}/server-key.pem"
      - echo ""
      - echo "ðŸ” Certificate verification:"
      - task: certs:verify
      - echo ""
      - echo "ðŸš€ Starting server..."
      - echo "   (Press Ctrl+C to stop)"
      - echo ""
      - "{{.SLIMCTL_BIN}} slim start --config {{.TESTDATA_DIR}}/test-tls.yaml"
    silent: false

  test:manual:custom:
    desc: Manual test - Run with custom config file
    deps:
      - verify:binary
    cmds:
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘     Manual Test - Custom Configuration            â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - echo "ðŸ“Š Test Configuration:"
      - echo "  â€¢ Config file - {{.CONFIG}}"
      - echo ""
      - echo "ðŸ“„ Config contents:"
      - cat {{.CONFIG}}
      - echo ""
      - echo "ðŸš€ Starting server..."
      - echo "   (Press Ctrl+C to stop)"
      - echo ""
      - "{{.SLIMCTL_BIN}} slim start --config {{.CONFIG}}"
    silent: false
    requires:
      vars: [CONFIG]
    preconditions:
      - sh: test -f {{.CONFIG}}
        msg: "Config file not found: {{.CONFIG}}"

  test:manual:quick:
    desc: Quick manual test - insecure mode (minimal output)
    deps:
      - setup:test-env
      - verify:binary
    cmds:
      - "{{.SLIMCTL_BIN}} slim start --endpoint 127.0.0.1:9090 --insecure"
    silent: false

  # Run tasks (for quick testing)
  run:insecure:
    desc: Run slimctl in insecure mode (for testing)
    cmds:
      - echo "ðŸš€ Starting slimctl in insecure mode..."
      - "{{.SLIMCTL_BIN}} slim start --endpoint 127.0.0.1:9090 --insecure"
    silent: false
    preconditions:
      - sh: test -f {{.SLIMCTL_BIN}}
        msg: "slimctl binary not found at {{.SLIMCTL_BIN}}. Build it first with: cd ../.. && task -d control-plane slimctl:build"

  run:tls:
    desc: Run slimctl with TLS (for testing)
    deps:
      - certs:setup
      - configs:tls
    cmds:
      - echo "ðŸš€ Starting slimctl with TLS..."
      - "{{.SLIMCTL_BIN}} slim start --config {{.TESTDATA_DIR}}/test-tls.yaml"
    silent: false
    preconditions:
      - sh: test -f {{.SLIMCTL_BIN}}
        msg: "slimctl binary not found at {{.SLIMCTL_BIN}}. Build it first with: cd ../.. && task -d control-plane slimctl:build"

  run:config:
    desc: Run slimctl with custom config file
    cmds:
      - echo "ðŸš€ Starting slimctl with config:{{.CONFIG}}"
      - "{{.SLIMCTL_BIN}} slim start --config {{.CONFIG}}"
    silent: false
    preconditions:
      - sh: test -f {{.SLIMCTL_BIN}}
        msg: "slimctl binary not found at {{.SLIMCTL_BIN}}. Build it first with: cd ../.. && task -d control-plane slimctl:build"
      - sh: test -f {{.CONFIG}}
        msg: "Config file not found: {{.CONFIG}}"
    requires:
      vars: [CONFIG]

  run:override-endpoint:
    desc: Test endpoint override with CLI flag (env vars)
    cmds:
      - |
        echo "ðŸ§ª Testing endpoint override with CLI flag..."
        echo "   Config: examples/env-override.yaml"
        echo "   Override: --endpoint 127.0.0.1:19090"
        echo ""
      - "{{.SLIMCTL_BIN}} slim start --config examples/env-override.yaml --endpoint 127.0.0.1:19090"
    silent: false
    preconditions:
      - sh: test -f {{.SLIMCTL_BIN}}
        msg: "slimctl binary not found at {{.SLIMCTL_BIN}}. Build it first with: cd ../.. && task -d control-plane slimctl:build"
      - sh: test -f examples/env-override.yaml
        msg: "env-override.yaml not found in examples/"

  run:override-tls:
    desc: Test TLS override with CLI flags (env vars)
    deps: [certs:setup]
    cmds:
      - |
        echo "ðŸ§ª Testing TLS override with CLI flags..."
        echo "   Config: examples/env-override.yaml"
        echo "   Overrides: --endpoint, --tls-cert, --tls-key"
        echo ""
      - "{{.SLIMCTL_BIN}} slim start --config examples/env-override.yaml --endpoint 127.0.0.1:18443 --tls-cert testdata/certs/server-cert.pem --tls-key testdata/certs/server-key.pem"
    silent: false
    preconditions:
      - sh: test -f {{.SLIMCTL_BIN}}
        msg: "slimctl binary not found at {{.SLIMCTL_BIN}}. Build it first with: cd ../.. && task -d control-plane slimctl:build"
      - sh: test -f examples/env-override.yaml
        msg: "env-override.yaml not found in examples/"

  run:with-exports:
    desc: Test with manually exported environment variables
    cmds:
      - |
        echo "ðŸ§ª Testing with manually exported environment variables..."
        echo "   Setting: SLIM_ENDPOINT=127.0.0.1:29090"
        echo "   Setting: SLIM_TLS_INSECURE=true"
        echo "   Config: examples/env-override.yaml"
        echo ""
        export SLIM_ENDPOINT=127.0.0.1:29090
        export SLIM_TLS_INSECURE=true
        {{.SLIMCTL_BIN}} slim start --config examples/env-override.yaml
    silent: false
    preconditions:
      - sh: test -f {{.SLIMCTL_BIN}}
        msg: "slimctl binary not found at {{.SLIMCTL_BIN}}. Build it first with: cd ../.. && task -d control-plane slimctl:build"
      - sh: test -f examples/env-override.yaml
        msg: "env-override.yaml not found in examples/"

  # Clean tasks
  clean:
    desc: Clean all generated test files
    cmds:
      - echo "ðŸ§¹ Cleaning generated files..."
      - task: certs:clean
      - task: configs:clean
      - echo "âœ… Clean complete"
    silent: false

  clean:all:
    desc: Clean everything including binary
    cmds:
      - task: clean
      - rm -f {{.SLIMCTL_BIN}}
      - echo "âœ… All clean (including binary at {{.SLIMCTL_BIN}})"
    silent: false

  # Validation tasks
  validate:
    desc: Validate test environment setup
    cmds:
      - echo "ðŸ” Validating test environment..."
      - task: verify:binary
      - task: certs:verify
      - echo "âœ… Validation complete"
    silent: false

  verify:binary:
    desc: Verify slimctl binary exists and show version
    cmds:
      - |
        if [ ! -f "{{.SLIMCTL_BIN}}" ]; then
          echo "âŒ Binary not found at: {{.SLIMCTL_BIN}}"
          echo ""
          echo "Build it with:"
          echo "  cd ../.. && task -d control-plane slimctl:build"
          exit 1
        fi
        echo "âœ… Binary found: {{.SLIMCTL_BIN}}"
        echo ""
        echo "Version info:"
        {{.SLIMCTL_BIN}} version 2>/dev/null || echo "  (version command not available)"
    silent: false
