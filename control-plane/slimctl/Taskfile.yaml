version: '3'

# Taskfile for slimctl
# Run from control-plane/slimctl directory or use: task -d control-plane/slimctl <task-name>

vars:
  # Binary location relative to this Taskfile (control-plane/slimctl/)
  SLIMCTL_BIN: ../../.dist/bin/slimctl
  TEST_CERTS_DIR: examples/test-certs
  COVERAGE_FILE: coverage.out
  COVERAGE_HTML: coverage.html

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list
    silent: true

  help:manual:
    desc: Show manual testing help
    cmds:
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘     SLIM Manual Testing Guide                     â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - echo "ðŸŽ¯ Quick Start:"
      - echo "  task test:manual           - Complete guided workflow"
      - echo "  task test:manual:insecure  - Test insecure mode"
      - echo "  task test:manual:tls       - Test TLS mode"
      - echo "  task test:manual:quick     - Quick insecure test"
      - echo ""
      - echo "ðŸ“‹ Step-by-step:"
      - echo "  1. task setup:test-env     - Setup certs & configs"
      - echo "  2. Build binary            - cd ../.. && task -d control-plane slimctl:build"
      - echo "  3. task test:manual:tls    - Run TLS test"
      - echo ""
      - echo "ðŸ”§ Custom testing:"
      - echo "  task test:manual:custom CONFIG=my-config.yaml"
      - echo ""
      - echo "ðŸ§¹ Cleanup:"
      - echo "  task clean                 - Remove test files"
      - echo "  task clean:all             - Remove everything + binary"
      - echo ""
      - echo "For full command list - task --list"
    silent: true

  # Testing tasks
  test:
    desc: Run all unit tests
    cmds:
      - echo "ðŸ“¦ Running unit tests..."
      - go test ./internal/config ./internal/manager -v
      - echo "âœ… All tests passed!"
    silent: false

  test:coverage:
    desc: Run tests with coverage report
    cmds:
      - echo "ðŸ“Š Running tests with coverage..."
      - go test ./internal/config ./internal/manager -v -coverprofile={{.COVERAGE_FILE}}
      - task: coverage:summary
      - task: coverage:html
      - echo "âœ… Coverage report generated:{{.COVERAGE_HTML}}"
    silent: false

  coverage:summary:
    desc: Show coverage summary
    cmds:
      - echo "ðŸ“Š Coverage Summary:"
      - go tool cover -func={{.COVERAGE_FILE}} | grep total
    silent: false
    preconditions:
      - test -f {{.COVERAGE_FILE}}

  coverage:html:
    desc: Generate HTML coverage report
    cmds:
      - go tool cover -html={{.COVERAGE_FILE}} -o {{.COVERAGE_HTML}}
      - echo "ðŸ“„ HTML coverage report:{{.COVERAGE_HTML}}"
    silent: false
    preconditions:
      - test -f {{.COVERAGE_FILE}}

  coverage:open:
    desc: Open coverage report in browser
    cmds:
      - open {{.COVERAGE_HTML}}
    silent: false
    preconditions:
      - test -f {{.COVERAGE_HTML}}

  test:config:
    desc: Run configuration package tests only
    cmds:
      - echo "ðŸ§ª Testing config package..."
      - go test ./internal/config -v

  test:manager:
    desc: Run manager package tests only
    cmds:
      - echo "ðŸ§ª Testing manager package..."
      - go test ./internal/manager -v

  # Certificate generation tasks
  certs:setup:
    desc: Generate test TLS certificates (X.509 v3)
    cmds:
      - task: certs:clean
      - task: certs:generate
      - task: certs:verify
    silent: false

  certs:generate:
    desc: Generate X.509 v3 certificates
    cmds:
      - echo "ðŸ” Generating test certificates..."
      - mkdir -p {{.TEST_CERTS_DIR}}
      - |
        # Generate private key
        openssl genrsa -out {{.TEST_CERTS_DIR}}/server-key.pem 2048 2>/dev/null
      - |
        # Create OpenSSL config for v3 extensions
        cat > {{.TEST_CERTS_DIR}}/openssl.cnf <<'EOF'
        [req]
        default_bits = 2048
        prompt = no
        default_md = sha256
        distinguished_name = dn
        x509_extensions = v3_req

        [dn]
        C = US
        ST = Test
        L = Test
        O = Test Organization
        CN = localhost

        [v3_req]
        subjectAltName = @alt_names
        basicConstraints = CA:FALSE
        keyUsage = digitalSignature, keyEncipherment
        extendedKeyUsage = serverAuth

        [alt_names]
        DNS.1 = localhost
        DNS.2 = *.localhost
        IP.1 = 127.0.0.1
        IP.2 = ::1
        EOF
        
        # Generate X.509 v3 certificate
        openssl req -new -x509 -key {{.TEST_CERTS_DIR}}/server-key.pem \
          -out {{.TEST_CERTS_DIR}}/server-cert.pem -days 365 \
          -config {{.TEST_CERTS_DIR}}/openssl.cnf \
          -extensions v3_req 2>/dev/null
        
        # Clean up config file
        rm {{.TEST_CERTS_DIR}}/openssl.cnf
        
        echo "âœ… Certificates generated in {{.TEST_CERTS_DIR}}/"
    silent: false
    status:
      - test -f {{.TEST_CERTS_DIR}}/server-cert.pem
      - test -f {{.TEST_CERTS_DIR}}/server-key.pem

  certs:verify:
    desc: Verify certificate version and details
    cmds:
      - |
        echo "ðŸ” Verifying certificate..."
        CERT_VERSION=$(openssl x509 -in {{.TEST_CERTS_DIR}}/server-cert.pem -noout -text | grep "Version:" | sed 's/.*Version: \([0-9]\).*/\1/')
        if [ "$CERT_VERSION" = "3" ]; then
          echo "   âœ… Certificate version: v3 (compatible with rustls)"
        else
          echo "   âŒ Warning: Certificate version v$CERT_VERSION may not be compatible"
          exit 1
        fi
      - echo "   Certificate details:"
      - openssl x509 -in {{.TEST_CERTS_DIR}}/server-cert.pem -noout -subject -dates
    silent: false
    preconditions:
      - test -f {{.TEST_CERTS_DIR}}/server-cert.pem

  certs:clean:
    desc: Remove test certificates
    cmds:
      - echo "ðŸ§¹ Cleaning test certificates..."
      - rm -rf {{.TEST_CERTS_DIR}}
      - echo "âœ… Certificates removed"
    silent: false

  certs:info:
    desc: Show certificate information
    cmds:
      - echo "ðŸ“œ Certificate Information:"
      - openssl x509 -in {{.TEST_CERTS_DIR}}/server-cert.pem -noout -text
    silent: false
    preconditions:
      - test -f {{.TEST_CERTS_DIR}}/server-cert.pem

  # Test configuration tasks
  configs:setup:
    desc: Generate test configuration files
    cmds:
      - echo "ðŸ“ Creating test configuration files..."
      - task: configs:insecure
      - task: configs:tls
      - echo "âœ… Test configuration files created"
    silent: false

  configs:insecure:
    desc: Create insecure test config
    cmds:
      - |
        cat > examples/test-insecure.yaml <<'EOF'
        # Test configuration - Insecure mode
        endpoint: "127.0.0.1:9090"
        tls:
          insecure: true
        EOF
        echo "   Created: examples/test-insecure.yaml"
    silent: false

  configs:tls:
    desc: Create TLS test config
    cmds:
      - |
        cat > examples/test-tls.yaml <<'EOF'
        # Test configuration - TLS enabled
        endpoint: "127.0.0.1:8443"
        tls:
          insecure: false
          cert_file: "examples/test-certs/server-cert.pem"
          key_file: "examples/test-certs/server-key.pem"
        EOF
        echo "   Created: examples/test-tls.yaml"
    silent: false

  configs:clean:
    desc: Remove test configuration files
    cmds:
      - echo "ðŸ§¹ Cleaning test configuration files..."
      - rm -f examples/test-insecure.yaml examples/test-tls.yaml
      - echo "âœ… Test configs removed"
    silent: false

  # Setup tasks
  setup:test-env:
    desc: Complete test environment setup (certificates + configs)
    cmds:
      - echo "ðŸ”§ Setting up test environment..."
      - task: certs:setup
      - task: configs:setup
      - echo ""
      - echo "âœ… Test environment ready!"
      - echo ""
      - echo "You can now test with:"
      - echo "  â€¢ task run:insecure"
      - echo "  â€¢ task run:tls"
      - echo "  â€¢ {{.SLIMCTL_BIN}} slim start --config examples/test-insecure.yaml"
      - echo ""
    silent: false

  # Manual testing tasks
  test:manual:
    desc: Complete manual testing workflow (setup + run)
    cmds:
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘     SLIM Manual Testing Workflow                  â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - echo "ðŸ“‹ Step 1/4 - Setting up test environment..."
      - task: setup:test-env
      - echo ""
      - echo "ðŸ“‹ Step 2/4 - Verifying binary..."
      - task: verify:binary
      - echo ""
      - echo "ðŸ“‹ Step 3/4 - Environment ready!"
      - echo ""
      - echo "Available test scenarios:"
      - echo "  1ï¸âƒ£  Insecure mode - task test:manual:insecure"
      - echo "  2ï¸âƒ£  TLS mode - task test:manual:tls"
      - echo "  3ï¸âƒ£  Custom config - task test:manual:custom CONFIG=path/to/config.yaml"
      - echo ""
      - echo "Or run directly:"
      - echo "  {{.SLIMCTL_BIN}} slim start --endpoint 127.0.0.1:9090 --insecure"
      - echo "  {{.SLIMCTL_BIN}} slim start --config examples/test-tls.yaml"
      - echo ""
      - echo "ðŸ“‹ Step 4/4 - Choose a test scenario above and run it! ðŸš€"
    silent: false

  test:manual:insecure:
    desc: Manual test - Run insecure mode workflow
    deps:
      - setup:test-env
      - verify:binary
    cmds:
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘     Manual Test - Insecure Mode                   â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - echo "ðŸ“Š Test Configuration:"
      - echo "  â€¢ Mode - Insecure (no TLS)"
      - echo "  â€¢ Endpoint - 127.0.0.1:9090"
      - echo "  â€¢ Config - CLI flags only"
      - echo ""
      - echo "ðŸš€ Starting server..."
      - echo "   (Press Ctrl+C to stop)"
      - echo ""
      - "{{.SLIMCTL_BIN}} slim start --endpoint 127.0.0.1:9090 --insecure"
    silent: false

  test:manual:tls:
    desc: Manual test - Run TLS mode workflow
    deps:
      - setup:test-env
      - verify:binary
    cmds:
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘     Manual Test - TLS Mode                        â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - echo "ðŸ“Š Test Configuration:"
      - echo "  â€¢ Mode - TLS enabled"
      - echo "  â€¢ Endpoint - 127.0.0.1:8443"
      - echo "  â€¢ Config file - examples/test-tls.yaml"
      - echo "  â€¢ Certificate - {{.TEST_CERTS_DIR}}/server-cert.pem"
      - echo "  â€¢ Key - {{.TEST_CERTS_DIR}}/server-key.pem"
      - echo ""
      - echo "ðŸ” Certificate verification:"
      - task: certs:verify
      - echo ""
      - echo "ðŸš€ Starting server..."
      - echo "   (Press Ctrl+C to stop)"
      - echo ""
      - "{{.SLIMCTL_BIN}} slim start --config examples/test-tls.yaml"
    silent: false

  test:manual:custom:
    desc: Manual test - Run with custom config file
    deps:
      - verify:binary
    cmds:
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘     Manual Test - Custom Configuration            â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - echo "ðŸ“Š Test Configuration:"
      - echo "  â€¢ Config file - {{.CONFIG}}"
      - echo ""
      - echo "ðŸ“„ Config contents:"
      - cat {{.CONFIG}}
      - echo ""
      - echo "ðŸš€ Starting server..."
      - echo "   (Press Ctrl+C to stop)"
      - echo ""
      - "{{.SLIMCTL_BIN}} slim start --config {{.CONFIG}}"
    silent: false
    requires:
      vars: [CONFIG]
    preconditions:
      - sh: test -f {{.CONFIG}}
        msg: "Config file not found: {{.CONFIG}}"

  test:manual:quick:
    desc: Quick manual test - insecure mode (minimal output)
    deps:
      - setup:test-env
      - verify:binary
    cmds:
      - "{{.SLIMCTL_BIN}} slim start --endpoint 127.0.0.1:9090 --insecure"
    silent: false

  # Run tasks (for quick testing)
  run:insecure:
    desc: Run slimctl in insecure mode (for testing)
    cmds:
      - echo "ðŸš€ Starting slimctl in insecure mode..."
      - "{{.SLIMCTL_BIN}} slim start --endpoint 127.0.0.1:9090 --insecure"
    silent: false
    preconditions:
      - sh: test -f {{.SLIMCTL_BIN}}
        msg: "slimctl binary not found at {{.SLIMCTL_BIN}}. Build it first with: cd ../.. && task -d control-plane slimctl:build"

  run:tls:
    desc: Run slimctl with TLS (for testing)
    deps:
      - certs:setup
    cmds:
      - echo "ðŸš€ Starting slimctl with TLS..."
      - "{{.SLIMCTL_BIN}} slim start --config examples/test-tls.yaml"
    silent: false
    preconditions:
      - sh: test -f {{.SLIMCTL_BIN}}
        msg: "slimctl binary not found at {{.SLIMCTL_BIN}}. Build it first with: cd ../.. && task -d control-plane slimctl:build"

  run:config:
    desc: Run slimctl with custom config file
    cmds:
      - echo "ðŸš€ Starting slimctl with config:{{.CONFIG}}"
      - "{{.SLIMCTL_BIN}} slim start --config {{.CONFIG}}"
    silent: false
    preconditions:
      - sh: test -f {{.SLIMCTL_BIN}}
        msg: "slimctl binary not found at {{.SLIMCTL_BIN}}. Build it first with: cd ../.. && task -d control-plane slimctl:build"
      - sh: test -f {{.CONFIG}}
        msg: "Config file not found: {{.CONFIG}}"
    requires:
      vars: [CONFIG]

  # Clean tasks
  clean:
    desc: Clean all generated files
    cmds:
      - echo "ðŸ§¹ Cleaning generated files..."
      - task: certs:clean
      - task: configs:clean
      - task: clean:coverage
      - echo "âœ… Clean complete"
    silent: false

  clean:coverage:
    desc: Remove coverage files
    cmds:
      - rm -f {{.COVERAGE_FILE}} {{.COVERAGE_HTML}}
      - echo "ðŸ§¹ Coverage files removed"
    silent: false

  clean:all:
    desc: Clean everything including binary
    cmds:
      - task: clean
      - rm -f {{.SLIMCTL_BIN}}
      - echo "âœ… All clean (including binary at {{.SLIMCTL_BIN}})"
    silent: false

  # Validation tasks
  validate:
    desc: Run all validation checks
    cmds:
      - task: test
      - echo "âœ… All validations passed"
    silent: false

  verify:binary:
    desc: Verify slimctl binary exists and show version
    cmds:
      - |
        if [ ! -f "{{.SLIMCTL_BIN}}" ]; then
          echo "âŒ Binary not found at: {{.SLIMCTL_BIN}}"
          echo ""
          echo "Build it with:"
          echo "  cd ../.. && task -d control-plane slimctl:build"
          exit 1
        fi
        echo "âœ… Binary found: {{.SLIMCTL_BIN}}"
        echo ""
        echo "Version info:"
        {{.SLIMCTL_BIN}} version 2>/dev/null || echo "  (version command not available)"
    silent: false
