# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

---
version: "3"

silent: true

includes:
  tools:
    taskfile: ../tasks/tools.yaml
    internal: true

vars:
  REPO_ROOT:
    sh: git rev-parse --show-toplevel

  OUTPUT_DIR: "{{.REPO_ROOT}}/.dist"

  CONTROL_PLANE_DIR: control-plane

  MAIN_MODULE: github.com/agntcy/slim

  MODULES:
    sh: |
      find {{.REPO_ROOT}}/control-plane -type f -name "go.mod" ! -path "./third-party/*" -exec dirname {} \; | \
        sort | \
        tr '\n' ' '

env:
  GOTOOLCHAIN: "go1.25.0+auto"

tasks:
  control-plane:foreach-module:
    internal: true
    desc: Run task for each module
    cmds:
      - |
        for dir in {{.MODULES}}; do
          pushd ${dir} > /dev/null
          echo "${dir}: running {{.CMD}}"
          {{.CMD}}
          popd > /dev/null
        done

  control-plane:modtidy:
    desc: Install go modules
    cmds:
      - task: control-plane:foreach-module
        vars:
          CMD: go mod tidy

  control-plane:gogen:
    desc: Run go generate
    cmds:
      - task: control-plane:foreach-module
        vars:
          CMD: go generate ./...

  control-plane:lint:
    desc: Run go linter
    deps:
      - tools:all
    cmds:
      - task: control-plane:gogen
      - task: control-plane:foreach-module
        vars:
          CMD: "echo ${PWD} && {{.TOOLS_INSTALL_DIR}}/golangci-lint run"

  control-plane:impi:
    desc: Run go impi
    deps:
      - tools:all
    cmds:
      - task: control-plane:gogen
      - task: control-plane:foreach-module
        vars:
          CMD: |
            {{.TOOLS_INSTALL_DIR}}/impi \
              --local github.com/agntcy/slim \
              --ignore-generated=true \
              --scheme stdThirdPartyLocal \
              ./...

  control-plane:vuln:
    desc: Run go govulncheck
    deps:
      - tools:all
    cmds:
      - task: control-plane:gogen
      - task: control-plane:foreach-module
        vars:
          CMD: "{{.TOOLS_INSTALL_DIR}}/govulncheck ./..."

  control-plane:coverage-reports:
    desc: Check test coverage
    deps:
      - tools:all
    cmds:
      - task: control-plane:gogen
      - task: control-plane:foreach-module
        vars:
          CMD: |
            {{.TOOLS_INSTALL_DIR}}/go-acc --output=$(basename  ${dir})-coverage.out ./...

  control-plane:coverage:
    desc: Show coverage in browser
    deps:
      - control-plane:coverage-reports
    cmds:
      - echo find . -name '*coverage.out' -execdir go tool cover -html=./{} \;

  control-plane:test:
    desc: Run go tests
    deps:
      - tools:all
    cmds:
      - task: control-plane:gogen
      - task: control-plane:foreach-module
        vars:
          CMD: go test --tags=test -failfast -v 2>&1 ./...

  control-plane:fetch:
    desc: Download go modules
    deps:
      - tools:all
    cmds:
      - task: control-plane:gogen
      - task: control-plane:foreach-module
        vars:
          CMD: "echo ${PWD} && go env && go mod download"

  control-plane:proto:generate:
    desc: Generate Go protobuf and gRPC code
    deps:
      - tools:all
    cmds:
      - >
        {{.REPO_ROOT}}/.tools/protoc --proto_path=../proto \
          --go_out=paths=source_relative:./common/proto \
          --go-grpc_out=paths=source_relative:./common/proto \
          --plugin={{.REPO_ROOT}}/.tools/protoc-gen-go \
          --plugin={{.REPO_ROOT}}/.tools/protoc-gen-go-grpc \
          controller/v1/controller.proto controlplane/v1/controlplane.proto


  control-plane:go-bindings:setup:
    desc: Downloads the OS / Arch specific bindings library
    requires:
      vars: [TARGETOS, TARGETARCH]
    vars:
      TARGETABI: '{{.TARGETABI | default "gnu"}}'
    dir: slimctl
    cmds:
      - task: control-plane:modtidy
      - |
        echo "ðŸ“¦ Downloading bindings for {{.TARGETOS}}/{{.TARGETARCH}}/{{.TARGETABI}}"
        # Unset GOOS/GOARCH so the tool is built for the current platform
        unset GOOS
        unset GOARCH
        # But download bindings for the target platform
        go run \
          github.com/agntcy/slim-bindings-go/cmd/slim-bindings-setup \
          -os={{.TARGETOS}} \
          -arch={{.TARGETARCH}} \
          -abi={{.TARGETABI}}

  control-plane:slimctl:build:
    desc: Cross-compile slimctl using Zig (accepts TARGETOS and TARGETARCH, defaults to current platform)

    vars:
      CURRENT_OS:
        sh: go env GOHOSTOS
      CURRENT_ARCH:
        sh: go env GOHOSTARCH

      DETECTED_TARGETOS:
        sh: go env GOOS

      DETECTED_TARGETARCH:
        sh: go env GOARCH

      TARGETOS: '{{.TARGETOS | default .DETECTED_TARGETOS}}'
      TARGETARCH: '{{.TARGETARCH | default .DETECTED_TARGETARCH}}'

      TARGETABI: '{{.TARGETABI | default "gnu"}}'

      TOOLS_DIR: "{{.REPO_ROOT}}/.tools"
      ZIG_INSTALL_DIR: "{{.ZIG_INSTALL_DIR | default .TOOLS_DIR}}"

      GIT_COMMIT:
        sh: git log -n 1 --format=%h
      BUILD_DATE:
        sh: date -u +'%Y-%m-%dT%H:%M:%SZ'
      VERSION:
        sh: pushd {{.REPO_ROOT}} > /dev/null && task version && popd > /dev/null
      FLAGS: '{{.FLAGS | default ""}}'

    deps:
      - control-plane:proto:generate
      - task: control-plane:go-bindings:setup
        vars:
          TARGETOS: "{{.TARGETOS}}"
          TARGETARCH: "{{.TARGETARCH}}"
          TARGETABI: "{{.TARGETABI | default \"gnu\"}}"
      - task: tools:zig

    dir: slimctl/cmd
    cmds:
      - task: control-plane:gogen
      - |
        # Debug: Show detected and target platforms
        echo "ðŸ“Š Platform Detection:"
        echo "   CURRENT_OS:    {{.CURRENT_OS}}"
        echo "   CURRENT_ARCH:  {{.CURRENT_ARCH}}"
        echo "   TARGETOS:      {{.TARGETOS}}"
        echo "   TARGETARCH:    {{.TARGETARCH}}"
        # Determine output binary name
        BINARY="slimctl"
        [ "{{.TARGETOS}}" = "windows" ] && BINARY="slimctl.exe"

        # Setup build context based on native vs cross-compilation
        if [ "{{.TARGETOS}}" = "{{.CURRENT_OS}}" ] && [ "{{.TARGETARCH}}" = "{{.CURRENT_ARCH}}" ]; then
          # Native build
          echo "ðŸ”¨ Building slimctl for native platform ({{.TARGETOS}}/{{.TARGETARCH}})"
          BUILD_MODE="native"
          # Unset CC/CXX and CGO flags to use system defaults
          unset CC
          unset CXX
          unset CGO_CFLAGS
          unset CGO_LDFLAGS
        else
          # Cross-compilation - setup Zig compiler
          echo "ðŸ”¨ Cross-compiling slimctl from {{.CURRENT_OS}}/{{.CURRENT_ARCH}} to {{.TARGETOS}}/{{.TARGETARCH}}"
          BUILD_MODE="cross"
          # Map GOOS/GOARCH to Zig target triple
          case "{{.TARGETOS}}" in
            linux)
              case "{{.TARGETARCH}}" in
                amd64) ZIG_TARGET="x86_64-linux-gnu" ;;
                arm64) ZIG_TARGET="aarch64-linux-gnu" ;;
                x86_64) ZIG_TARGET="x86_64-linux-gnu" ;;

                *) echo "âŒ Unsupported TARGETARCH: {{.TARGETARCH}}"; exit 1 ;;
              esac
              ;;
            darwin)
              case "{{.TARGETARCH}}" in
                amd64) ZIG_TARGET="x86_64-macos" ;;
                arm64) ZIG_TARGET="aarch64-macos" ;;
                *) echo "âŒ Unsupported TARGETARCH: {{.TARGETARCH}}"; exit 1 ;;
              esac
              ;;
            windows)
              case "{{.TARGETARCH}}" in
                amd64) ZIG_TARGET="x86_64-windows-gnu" ;;
                arm64) ZIG_TARGET="x86_64-windows-gnu" ;;
                x86_64) ZIG_TARGET="x86_64-windows-gnu" ;;
                *) echo "âŒ Unsupported TARGETARCH: {{.TARGETARCH}}"; exit 1 ;;
              esac
              ;;
            *)
              echo "âŒ Unsupported TARGETOS: {{.TARGETOS}}"
              exit 1
              ;;
          esac

          # Verify Zig is available
          ZIG="{{.ZIG_INSTALL_DIR}}/zig"
          if [ ! -f "$ZIG" ]; then
            echo "âŒ Error: Zig binary not found at $ZIG"
            exit 1
          fi

          echo "Using Zig target: $ZIG_TARGET"

          # Configure Zig as the C/C++ compiler with explicit runtime library
          # Use -rtlib=compiler-rt to link Zig's compiler runtime which includes unwinding
          # Use --unwindlib=libunwind to link Zig's unwinding library for exception handling
          export CC="$ZIG cc -target $ZIG_TARGET -rtlib=compiler-rt -lunwind"
          export CXX="$ZIG c++ -target $ZIG_TARGET -rtlib=compiler-rt -lunwind"
        fi

        # Execute build with configured context
        CGO_ENABLED=1 \
        GOOS={{.TARGETOS}} \
        GOARCH={{.TARGETARCH}} \
        go build -o {{.OUTPUT_DIR}}/bin/$BINARY \
          -ldflags " \
            -X '{{.MAIN_MODULE}}/control-plane/slimctl/internal/cmd/version.semVersion={{.VERSION}}'
            -X '{{.MAIN_MODULE}}/control-plane/slimctl/internal/cmd/version.gitCommit={{.GIT_COMMIT}}'
            -X '{{.MAIN_MODULE}}/control-plane/slimctl/internal/cmd/version.buildDate={{.BUILD_DATE}}'
            {{.FLAGS}} \
          "

        # Report success
        if [ "$BUILD_MODE" = "native" ]; then
          echo "âœ… Successfully built $BINARY for {{.TARGETOS}}/{{.TARGETARCH}}"
        else
          echo "âœ… Successfully cross-compiled $BINARY for {{.TARGETOS}}/{{.TARGETARCH}}"
        fi

  control-plane:token-service:build:
    desc: Build token service
    dir: token-service/cmd
    cmds:
      - |
        go build -o \
          {{.OUTPUT_DIR}}/bin/slim-tks \
          -ldflags \
          " \
            -X '{{.MAIN_MODULE}}/control-plane/internal/cmd/version.semVersion={{.VERSION}}'
            -X '{{.MAIN_MODULE}}/control-plane/internal/cmd/version.gitCommit={{.GIT_COMMIT}}'
            -X '{{.MAIN_MODULE}}/control-plane/internal/cmd/version.buildDate={{.BUILD_DATE}}'
            {{.FLAGS}} \
          "
    vars:
      GIT_COMMIT:
        sh: git log -n 1 --format=%h
      BUILD_DATE:
        sh: date -u +'%Y-%m-%dT%H:%M:%SZ'
      VERSION:
        sh: pushd {{.REPO_ROOT}} > /dev/null && task version && popd > /dev/null

  control-plane:build:
    desc: Build go binaries
    deps:
      - control-plane:modtidy
    cmds:
      - task: control-plane:control-plane:build
      - task: control-plane:token-service:build
      - task: control-plane:slimctl:build


  #  control plane related tasks
  control-plane:control-plane:build:
    desc: Builds the control plane binary
    dir: control-plane/cmd
    deps:
      - control-plane:proto:generate
    cmds:
      - task: control-plane:modtidy
      - task: control-plane:gogen
      - |
        go build -o \
          {{.OUTPUT_DIR}}/bin/control-plane

  control-plane:control-plane:run:
    desc: Runs the control plane binary
    deps:
      - control-plane:control-plane:build
    cmds:
      - |
        {{.OUTPUT_DIR}}/bin/control-plane \
          --config {{.REPO_ROOT}}/control-plane/control-plane/config/config.yaml
