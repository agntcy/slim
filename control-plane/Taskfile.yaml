# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

---
version: "3"

silent: true

includes:
  tools:
    taskfile: ../tasks/tools.yaml
    internal: true

vars:
  REPO_ROOT:
    sh: git rev-parse --show-toplevel

  OUTPUT_DIR: "{{.REPO_ROOT}}/.dist"

  CONTROL_PLANE_DIR: control-plane

  MAIN_MODULE: github.com/agntcy/slim

  MODULES:
    sh: |
      find {{.REPO_ROOT}}/control-plane -type f -name "go.mod" ! -path "./third-party/*" -exec dirname {} \; | \
        sort | \
        tr '\n' ' '

env:
  GOTOOLCHAIN: "go1.25.0+auto"

tasks:
  control-plane:foreach-module:
    internal: true
    desc: Run task for each module
    cmds:
      - |
        for dir in {{.MODULES}}; do
          pushd ${dir} > /dev/null
          echo "${dir}: running {{.CMD}}"
          {{.CMD}}
          popd > /dev/null
        done

  control-plane:modtidy:
    desc: Install go modules
    vars:
      HOSTOS:
        sh: go env GOHOSTOS
      HOSTARCH:
        sh: go env GOHOSTARCH
      USE_LOCAL_BINDINGS: '{{.USE_LOCAL_BINDINGS | default "false"}}'
    cmds:
      - |
        if [ "{{.USE_LOCAL_BINDINGS}}" = "true" ]; then
          TARGETABI=""
          if [ "{{.HOSTOS}}" = "linux" ] || [ "{{.HOSTOS}}" = "windows" ]; then
            TARGETABI="gnu"
          fi
          task -d {{.REPO_ROOT}}/control-plane control-plane:go-bindings:install-local \
            TARGETOS={{.HOSTOS}} \
            TARGETARCH={{.HOSTARCH}} \
            TARGETABI="$TARGETABI"
        fi
      - task: control-plane:foreach-module
        vars:
          CMD: CGO_ENABLED=1 GOOS={{.HOSTOS}} GOARCH={{.HOSTARCH}} go mod tidy

  control-plane:gogen:
    desc: Run go generate
    cmds:
      - task: control-plane:foreach-module
        vars:
          CMD: go generate ./...

  control-plane:lint:
    desc: Run go linter
    deps:
      - tools:all
      - task: control-plane:go-bindings:setup
        vars:
          TARGETOS:
            sh: go env GOOS
          TARGETARCH:
            sh: go env GOARCH
    cmds:
      - task: control-plane:gogen
      - task: control-plane:foreach-module
        vars:
          CMD: "echo ${PWD} && CGO_ENABLED=1 {{.TOOLS_INSTALL_DIR}}/golangci-lint run"

  control-plane:impi:
    desc: Run go impi
    deps:
      - tools:all
    cmds:
      - task: control-plane:gogen
      - task: control-plane:foreach-module
        vars:
          CMD: |
            {{.TOOLS_INSTALL_DIR}}/impi \
              --local github.com/agntcy/slim \
              --ignore-generated=true \
              --scheme stdThirdPartyLocal \
              ./...

  control-plane:vuln:
    desc: Run go govulncheck
    deps:
      - tools:all
      - task: control-plane:go-bindings:setup
        vars:
          TARGETOS:
            sh: go env GOOS
          TARGETARCH:
            sh: go env GOARCH
    cmds:
      - task: control-plane:gogen
      - task: control-plane:foreach-module
        vars:
          CMD: "{{.TOOLS_INSTALL_DIR}}/govulncheck ./..."

  control-plane:coverage-reports:
    desc: Check test coverage
    deps:
      - tools:all
    cmds:
      - task: control-plane:gogen
      - task: control-plane:foreach-module
        vars:
          CMD: |
            {{.TOOLS_INSTALL_DIR}}/go-acc --output=$(basename  ${dir})-coverage.out ./...

  control-plane:coverage:
    desc: Show coverage in browser
    deps:
      - control-plane:coverage-reports
    cmds:
      - echo find . -name '*coverage.out' -execdir go tool cover -html=./{} \;

  control-plane:test:
    desc: Run go tests
    deps:
      - tools:all
    cmds:
      - task: control-plane:gogen
      - task: control-plane:foreach-module
        vars:
          CMD: go test --tags=test -failfast -v 2>&1 ./...

  control-plane:fetch:
    desc: Download go modules
    deps:
      - tools:all
    cmds:
      - task: control-plane:gogen
      - task: control-plane:foreach-module
        vars:
          CMD: "echo ${PWD} && go env && go mod download"

  control-plane:proto:generate:
    desc: Generate Go protobuf and gRPC code
    deps:
      - tools:all
    cmds:
      - >
        {{.REPO_ROOT}}/.tools/protoc --proto_path=../proto \
          --go_out=paths=source_relative:./common/proto \
          --go-grpc_out=paths=source_relative:./common/proto \
          --plugin={{.REPO_ROOT}}/.tools/protoc-gen-go \
          --plugin={{.REPO_ROOT}}/.tools/protoc-gen-go-grpc \
          controller/v1/controller.proto controlplane/v1/controlplane.proto


  control-plane:go-bindings:setup:
    desc: Downloads the OS / Arch specific bindings library
    requires:
      vars: [TARGETOS, TARGETARCH]
    vars:
      USE_LOCAL_BINDINGS: '{{.USE_LOCAL_BINDINGS | default "false"}}'
      FORCE_LOCAL_BINDINGS: '{{.FORCE_LOCAL_BINDINGS | default "false"}}'
      TARGETABI: '{{.TARGETABI | default "gnu"}}'
    dir: slimctl
    cmds:
      - |
        if [ "{{.USE_LOCAL_BINDINGS}}" = "true" ]; then
          task -d {{.REPO_ROOT}}/control-plane control-plane:go-bindings:install-local \
            TARGETOS={{.TARGETOS}} \
            TARGETARCH={{.TARGETARCH}} \
            TARGETABI={{.TARGETABI}} \
            FORCE_LOCAL_BINDINGS={{.FORCE_LOCAL_BINDINGS}}
          task -d {{.REPO_ROOT}}/data-plane/bindings/go generate-from-cache \
            TARGETOS={{.TARGETOS}} \
            TARGETARCH={{.TARGETARCH}} \
            TARGETABI={{.TARGETABI}}
        else
          echo "ðŸ“¦ Downloading bindings for {{.TARGETOS}}/{{.TARGETARCH}}/{{.TARGETABI}}"
          # Unset GOOS/GOARCH so the tool is built for the current platform
          unset GOOS
          unset GOARCH
          # But download bindings for the target platform
          go run \
            github.com/agntcy/slim-bindings-go/cmd/slim-bindings-setup \
            -os={{.TARGETOS}} \
            -arch={{.TARGETARCH}} \
            -abi={{.TARGETABI}}
        fi

        GOPATH_DIR=$(go env GOPATH)
        CACHE_DIR="$GOPATH_DIR/.cgo-cache/slim-bindings"
        if [ -d "$CACHE_DIR" ]; then
          REPO_CACHE="{{.REPO_ROOT}}/.cgo-cache"
          mkdir -p "$REPO_CACHE"
          cp -a "$CACHE_DIR" "$REPO_CACHE/"
        fi

        case "{{.TARGETOS}}" in
          darwin)
            if [ "{{.TARGETARCH}}" = "arm64" ]; then
              LIB_ARCH="aarch64"
            else
              LIB_ARCH="x86_64"
            fi
            LIB_NAME="libslim_bindings_${LIB_ARCH}_darwin.a"
            ;;
          linux)
            if [ "{{.TARGETARCH}}" = "arm64" ]; then
              LIB_ARCH="aarch64"
            else
              LIB_ARCH="x86_64"
            fi
            LIB_NAME="libslim_bindings_${LIB_ARCH}_linux_{{.TARGETABI}}.a"
            ;;
          windows)
            LIB_NAME="libslim_bindings_x86_64_windows_{{.TARGETABI}}.a"
            ;;
        esac

        if [ -n "${LIB_NAME:-}" ] && [ -f "$CACHE_DIR/$LIB_NAME" ]; then
          DEST_DIR="{{.REPO_ROOT}}/data-plane/bindings/go/slim_bindings"
          mkdir -p "$DEST_DIR"
          cp -a "$CACHE_DIR/$LIB_NAME" "$DEST_DIR/"
        fi

  control-plane:go-bindings:install-local:
    desc: Build bindings locally and install into the CGO cache
    requires:
      vars: [TARGETOS, TARGETARCH]
    vars:
      TARGETABI: '{{.TARGETABI | default ""}}'
      FORCE_LOCAL_BINDINGS: '{{.FORCE_LOCAL_BINDINGS | default "false"}}'
    cmds:
      - |
        set -euo pipefail

        TARGET_OS="{{.TARGETOS}}"
        TARGET_ARCH="{{.TARGETARCH}}"
        TARGET_ABI="{{.TARGETABI}}"

        case "$TARGET_OS" in
          darwin)
            if [ "$TARGET_ARCH" = "arm64" ]; then
              RUST_TARGET="aarch64-apple-darwin"
              LIB_ARCH="aarch64"
            else
              RUST_TARGET="x86_64-apple-darwin"
              LIB_ARCH="x86_64"
            fi
            LIB_NAME="libslim_bindings_${LIB_ARCH}_darwin.a"
            ;;
          linux)
            if [ -z "$TARGET_ABI" ]; then
              TARGET_ABI="gnu"
            fi
            if [ "$TARGET_ARCH" = "arm64" ]; then
              RUST_TARGET="aarch64-unknown-linux-$TARGET_ABI"
              LIB_ARCH="aarch64"
            else
              RUST_TARGET="x86_64-unknown-linux-$TARGET_ABI"
              LIB_ARCH="x86_64"
            fi
            LIB_NAME="libslim_bindings_${LIB_ARCH}_linux_${TARGET_ABI}.a"
            ;;
          windows)
            if [ "$TARGET_ARCH" != "amd64" ]; then
              echo "âŒ Unsupported TARGETARCH for windows: $TARGET_ARCH"
              exit 1
            fi
            if [ -z "$TARGET_ABI" ]; then
              TARGET_ABI="gnu"
            fi
            RUST_TARGET="x86_64-pc-windows-$TARGET_ABI"
            LIB_NAME="libslim_bindings_x86_64_windows_${TARGET_ABI}.a"
            ;;
          *)
            echo "âŒ Unsupported TARGETOS: $TARGET_OS"
            exit 1
            ;;
        esac

        GOPATH_DIR=$(go env GOPATH)
        CACHE_DIR="$GOPATH_DIR/.cgo-cache/slim-bindings"
        if [ -f "$CACHE_DIR/$LIB_NAME" ] && [ "{{.FORCE_LOCAL_BINDINGS}}" != "true" ]; then
          echo "âœ… Bindings already cached at $CACHE_DIR/$LIB_NAME"
          exit 0
        fi

        if [ -f "$CACHE_DIR/$LIB_NAME" ] && [ "{{.FORCE_LOCAL_BINDINGS}}" = "true" ]; then
          echo "â™»ï¸  Rebuilding bindings for $RUST_TARGET (cache refresh)"
        fi

        echo "ðŸ¦€ Building bindings for $RUST_TARGET"
        task -d {{.REPO_ROOT}}/data-plane/bindings/rust bindings:build:all \
          TARGET="$RUST_TARGET" \
          PROFILE=release

        SRC_LIB="{{.REPO_ROOT}}/data-plane/target/$RUST_TARGET/release/libslim_bindings.a"
        if [ ! -f "$SRC_LIB" ]; then
          echo "âŒ Expected library not found: $SRC_LIB"
          exit 1
        fi

        mkdir -p "$CACHE_DIR"

        cp "$SRC_LIB" "$CACHE_DIR/$LIB_NAME"
        echo "âœ… Installed bindings to $CACHE_DIR/$LIB_NAME"

  control-plane:slimctl:build:
    desc: Cross-compile slimctl using Zig (accepts TARGETOS and TARGETARCH, defaults to current platform)

    vars:
      CURRENT_OS:
        sh: go env GOHOSTOS
      CURRENT_ARCH:
        sh: go env GOHOSTARCH

      DETECTED_TARGETOS:
        sh: go env GOOS

      DETECTED_TARGETARCH:
        sh: go env GOARCH

      TARGETOS: '{{.TARGETOS | default .DETECTED_TARGETOS}}'
      TARGETARCH: '{{.TARGETARCH | default .DETECTED_TARGETARCH}}'

      TARGETABI: '{{.TARGETABI | default "gnu"}}'

      TOOLS_DIR: "{{.REPO_ROOT}}/.tools"
      ZIG_INSTALL_DIR: "{{.ZIG_INSTALL_DIR | default .TOOLS_DIR}}"

      GIT_COMMIT:
        sh: git log -n 1 --format=%h
      BUILD_DATE:
        sh: date -u +'%Y-%m-%dT%H:%M:%SZ'
      VERSION:
        sh: pushd {{.REPO_ROOT}} > /dev/null && task version && popd > /dev/null
      FLAGS: '{{.FLAGS | default ""}}'
      USE_LOCAL_BINDINGS: '{{.USE_LOCAL_BINDINGS | default "false"}}'
      FORCE_LOCAL_BINDINGS: '{{.FORCE_LOCAL_BINDINGS | default "false"}}'

    deps:
      - control-plane:proto:generate
      - task: control-plane:go-bindings:setup
        vars:
          TARGETOS: "{{.TARGETOS}}"
          TARGETARCH: "{{.TARGETARCH}}"
          TARGETABI: "{{.TARGETABI | default \"gnu\"}}"
          USE_LOCAL_BINDINGS: "{{.USE_LOCAL_BINDINGS}}"
          FORCE_LOCAL_BINDINGS: "{{.FORCE_LOCAL_BINDINGS}}"
      - task: tools:zig

    dir: slimctl/cmd
    cmds:
      - task: control-plane:gogen
      - |
        # Debug: Show detected and target platforms
        echo "ðŸ“Š Platform Detection:"
        echo "   CURRENT_OS:    {{.CURRENT_OS}}"
        echo "   CURRENT_ARCH:  {{.CURRENT_ARCH}}"
        echo "   TARGETOS:      {{.TARGETOS}}"
        echo "   TARGETARCH:    {{.TARGETARCH}}"
        # Determine output binary name
        BINARY="slimctl"
        [ "{{.TARGETOS}}" = "windows" ] && BINARY="slimctl.exe"

        # Setup build context based on native vs cross-compilation
        if [ "{{.TARGETOS}}" = "{{.CURRENT_OS}}" ] && [ "{{.TARGETARCH}}" = "{{.CURRENT_ARCH}}" ]; then
          # Native build
          echo "ðŸ”¨ Building slimctl for native platform ({{.TARGETOS}}/{{.TARGETARCH}})"
          BUILD_MODE="native"
          # Unset CC/CXX and CGO flags to use system defaults
          unset CC
          unset CXX
          unset CGO_CFLAGS
          unset CGO_LDFLAGS
        else
          # Cross-compilation - setup Zig compiler
          echo "ðŸ”¨ Cross-compiling slimctl from {{.CURRENT_OS}}/{{.CURRENT_ARCH}} to {{.TARGETOS}}/{{.TARGETARCH}}"
          BUILD_MODE="cross"
          # Map GOOS/GOARCH to Zig target triple
          case "{{.TARGETOS}}" in
            linux)
              case "{{.TARGETARCH}}" in
                amd64) ZIG_TARGET="x86_64-linux-gnu" ;;
                arm64) ZIG_TARGET="aarch64-linux-gnu" ;;
                x86_64) ZIG_TARGET="x86_64-linux-gnu" ;;

                *) echo "âŒ Unsupported TARGETARCH: {{.TARGETARCH}}"; exit 1 ;;
              esac
              ;;
            darwin)
              case "{{.TARGETARCH}}" in
                amd64) ZIG_TARGET="x86_64-macos" ;;
                arm64) ZIG_TARGET="aarch64-macos" ;;
                *) echo "âŒ Unsupported TARGETARCH: {{.TARGETARCH}}"; exit 1 ;;
              esac
              ;;
            windows)
              case "{{.TARGETARCH}}" in
                amd64) ZIG_TARGET="x86_64-windows-gnu" ;;
                arm64) ZIG_TARGET="x86_64-windows-gnu" ;;
                x86_64) ZIG_TARGET="x86_64-windows-gnu" ;;
                *) echo "âŒ Unsupported TARGETARCH: {{.TARGETARCH}}"; exit 1 ;;
              esac
              ;;
            *)
              echo "âŒ Unsupported TARGETOS: {{.TARGETOS}}"
              exit 1
              ;;
          esac

          # Verify Zig is available
          ZIG="{{.ZIG_INSTALL_DIR}}/zig"
          if [ ! -f "$ZIG" ]; then
            echo "âŒ Error: Zig binary not found at $ZIG"
            exit 1
          fi

          echo "Using Zig target: $ZIG_TARGET"

          # Configure Zig as the C/C++ compiler with explicit runtime library
          # Use -rtlib=compiler-rt to link Zig's compiler runtime which includes unwinding
          # Use --unwindlib=libunwind to link Zig's unwinding library for exception handling
          export CC="$ZIG cc -target $ZIG_TARGET -rtlib=compiler-rt -lunwind"
          export CXX="$ZIG c++ -target $ZIG_TARGET -rtlib=compiler-rt -lunwind"
        fi

        # Execute build with configured context
        CGO_ENABLED=1 \
        GOOS={{.TARGETOS}} \
        GOARCH={{.TARGETARCH}} \
        go build -o {{.OUTPUT_DIR}}/bin/$BINARY \
          -ldflags " \
            -X '{{.MAIN_MODULE}}/control-plane/slimctl/internal/cmd/version.semVersion={{.VERSION}}'
            -X '{{.MAIN_MODULE}}/control-plane/slimctl/internal/cmd/version.gitCommit={{.GIT_COMMIT}}'
            -X '{{.MAIN_MODULE}}/control-plane/slimctl/internal/cmd/version.buildDate={{.BUILD_DATE}}'
            {{.FLAGS}} \
          "

        # Report success
        if [ "$BUILD_MODE" = "native" ]; then
          echo "âœ… Successfully built $BINARY for {{.TARGETOS}}/{{.TARGETARCH}}"
        else
          echo "âœ… Successfully cross-compiled $BINARY for {{.TARGETOS}}/{{.TARGETARCH}}"
        fi

  control-plane:token-service:build:
    desc: Build token service
    dir: token-service/cmd
    cmds:
      - |
        go build -o \
          {{.OUTPUT_DIR}}/bin/slim-tks \
          -ldflags \
          " \
            -X '{{.MAIN_MODULE}}/control-plane/internal/cmd/version.semVersion={{.VERSION}}'
            -X '{{.MAIN_MODULE}}/control-plane/internal/cmd/version.gitCommit={{.GIT_COMMIT}}'
            -X '{{.MAIN_MODULE}}/control-plane/internal/cmd/version.buildDate={{.BUILD_DATE}}'
            {{.FLAGS}} \
          "
    vars:
      GIT_COMMIT:
        sh: git log -n 1 --format=%h
      BUILD_DATE:
        sh: date -u +'%Y-%m-%dT%H:%M:%SZ'
      VERSION:
        sh: pushd {{.REPO_ROOT}} > /dev/null && task version && popd > /dev/null

  control-plane:build:
    desc: Build go binaries
    vars:
      USE_LOCAL_BINDINGS: '{{.USE_LOCAL_BINDINGS | default "false"}}'
      FORCE_LOCAL_BINDINGS: '{{.FORCE_LOCAL_BINDINGS | default "false"}}'
    deps:
      - task: control-plane:modtidy
        vars:
          USE_LOCAL_BINDINGS: "{{.USE_LOCAL_BINDINGS}}"
    cmds:
      - task: control-plane:control-plane:build
      - task: control-plane:token-service:build
      - task: control-plane:slimctl:build
        vars:
          USE_LOCAL_BINDINGS: "{{.USE_LOCAL_BINDINGS}}"
          FORCE_LOCAL_BINDINGS: "{{.FORCE_LOCAL_BINDINGS}}"


  #  control plane related tasks
  control-plane:control-plane:build:
    desc: Builds the control plane binary
    dir: control-plane/cmd
    deps:
      - control-plane:proto:generate
    cmds:
      - task: control-plane:modtidy
      - task: control-plane:gogen
      - |
        go build -o \
          {{.OUTPUT_DIR}}/bin/control-plane

  control-plane:control-plane:run:
    desc: Runs the control plane binary
    deps:
      - control-plane:control-plane:build
    cmds:
      - |
        {{.OUTPUT_DIR}}/bin/control-plane \
          --config {{.REPO_ROOT}}/control-plane/control-plane/config/config.yaml
